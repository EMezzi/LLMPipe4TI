{
    "title": "new sofacy attacks against us government agency",
    "text": "03/04/24, 17:50New Sofacy Attacks Against US Government Agency Pagina 1 di 6https://unit42.paloaltonetworks.com/unit42-new-sofacy-attacks-against-us-government-agency/New Sofacy A!acks Against US GovernmentAgency45,815people reacted47 min. read This post is also available in: ೔ຊޠ( Japanese)The Sofacy group, also known as APT28, is a well-known threat group that frequently conducts cyber espionagecampaigns. Recently, Unit 42 iden!ﬁed a spear phishing e-mail from the Sofacy group that targeted the UnitedStates government. The e-mail was sent from a poten!ally compromised account belonging to the Ministry ofForeign Aﬀairs of another government en!ty and carried the Carberp variant of the Sofacy Trojan. The developerimplemented a clever persistence mechanism in the Trojan, one which had not been observed in previous a#acks.The focus of this blog will be on the a#acks and the infrastructure associated with Sofacy using the newpersistence mechanism as a correla!on point.The DeliveryOn May 28, 2016, a#ackers sent a spear-phishing e-mail to a U.S. government en!ty using an email addressbelonging to the Ministry of Foreign Aﬀairs of another country. Analysis of the a#ack revealed a high likelihoodthat the sender’s email address was not spoofed and is instead a result of a compromised host or accountbelonging to that Ministry.The targeted email had a subject of “FW: Exercise Noble Partner 2016”, which is a reference to a joint NATOtraining eﬀort between the United States and Georgia. The email contained an RTF ﬁle as an a#achment, with theﬁlename \"Exercise_Noble_Partner_16.r$,” reﬂec!ng the same training exercise. We have also seen related deliverydocuments with ﬁlenames that have a Russian military theme (Pu!n_Is_Being_Pushed_to_Prepare_for_War.r$ andRussian an!-Nato troops.r$), purportedly targe!ng organiza!ons in Poland according to a blog published byPrevenity.The RTF ﬁle is a weaponized document that a#empts to exploit CVE-2015-1641 to drop two ﬁles to the system,speciﬁcally, \"btecache.dll\" and \"svchost.dll\". The “btecache.dll” ﬁle is a Trojan that loads and executes “svchost.dll”,which is a Carberp variant the Sofacy Trojan. Surprisingly, unlike many other espionage actors who display decoydocuments a%er successful exploita!on, this RTF document does not drop or open a decoy document a%erexploi!ng the vulnerability.In the installa!on process, we observed the delivery document crea!ng a very interes!ng registry key that it usesBy Robert Falcone and Bryan LeeJune 14, 2016 at 5:00 AMCategory: Unit 42Tags: APT28, Carberp, Ministry of Foreign Aﬀairs, Sofacy, TrojanSHARE  Under Attack?About Unit 42ServicesUnit 42 Threat ResearchPartnersResources03/04/24, 17:50New Sofacy Attacks Against US Government Agency Pagina 2 di 6https://unit42.paloaltonetworks.com/unit42-new-sofacy-attacks-against-us-government-agency/for persistence to run the Trojan. The path to the \"btecache.dll\" ﬁle is added to the following registry key:So!ware\\Microso!\\Oﬃce test\\Special\\Perf\\: \"C:\\Users\\[username]\\AppData\\Roaming\\btecache.dll\"This registry key is interes!ng, because unlike tradi!onal methods of maintaining persistence, it does notautoma!cally run the “btecache.dll” ﬁle at system start up. Instead, this registry key will cause the DLL to load onlywhen the user opens any Microso% Oﬃce applica!on, such as Word or Excel. This is the ﬁrst !me Unit 42 hasseen the Sofacy group, or any other threat group for that ma\"er, use this tac!c for persistence purposes. Anadded beneﬁt for the threat actor to using this speciﬁc tac!c for persistence is that it requires user interac!on toload and execute the malicious payload, which can cause challenges for detec!on in automated sandboxes.The Carberp variant of SofacyThe \"btecache.dll\" ﬁle is the loader Trojan that is responsible for loading the \"svchost.dll\" DLL and execu!ng it.Both the \"btecache.dll\" and \"svchost.dll\" ﬁles contain code from the leaked Carberp source code, speciﬁcally theAPI resolu!on func!ons, as well as the RC2 key. The Sofacy group has used the Carberp source code in the past,speciﬁcally discussed in a blog by F-Secure, which is the reason we call this Trojan the Carberp variant.The \"svchost.dll\" ﬁle contains the bulk of the func!onality of this Trojan, which at a high level is a downloader thatallows the threat actors to gain an ini!al foothold on the system. The Trojan sends network beacons to itscommand and control (C2) serverallowing the threat actors to iden!fy targets of interest. The threat actors canthen respond to these network beacons to download and execute addi!onal secondary payloads on the system.The Trojan delivered in this a#ack contains two network loca!ons that it will send network beacons to, speciﬁcally“google.com” and “191.101.31.6”. These beacons are sent to the legi!mate website google.com as an a#empt tohide the true C2 beacons sent to the actual C2 server hosted at 191.101.31.6.  The network beacons are sentusing HTTP POST requests with URLs created largely with random characters. There are two excep!ons whererandom characters are not used to construct the URL, speciﬁcally the ﬁle extension that is randomly chosen from.xml, .pdf, .htm or .zip and the base64 encoded value at the end of the URL. The base64 encoded data is a string(\"J04aLsxVhHBkr19CYr0”) hardcoded within the Trojan that it will then encrypt using a custom algorithm. Figure 1shows an example beacon sent from the Trojan to the C2 server during analysis. Figure 1 Network Beacon Sent from Carberp variant of SofacyThe POST data seen in the beacon in Figure 1 is base64 encoded and encrypted using the same custom algorithm03/04/24, 17:50New Sofacy Attacks Against US Government Agency Pagina 3 di 6https://unit42.paloaltonetworks.com/unit42-new-sofacy-attacks-against-us-government-agency/used to encrypt the data in the beacon URL. We decrypted the data to determine its purpose and found thecleartext seen in Figure 2.,^Bid=I,;<&w@[System Process]Systemsmss.execsrss.exewininit.execsrss.exewinlogon.exeservices.exelsass.exelsm.exesvchost.exesvchost.exesvchost.exesvchost.exesvchost.exesvchost.exesvchost.exespoolsv.exesvchost.exetaskhost.exeuserinit.exedwm.exeexplorer.exesvchost.execmd.execonhost.exereader_sl.exesvchost.execmd.execonhost.exeSearchIndexer.exeSearchProtocolHost.exeSearchFilterHost.exeSearchProtocolHost.exeexplorer.exesvchost.exesvchost.exedisk=IDE\\DiskMAXTOR_HARDDISK_________________________2.2.1___\\5&2770a7af&0&0.0.0build=0x7caa0e19Figure 2 Decrypted HTTP POST Data Shows System Informa#onThe clear text of the data sent in the network beacons contains informa!on regarding the compromised system, aswell as malware-speciﬁc informa!on. The data is comprised of the following ﬁelds of data:id = The serial number of the storage devicew = This parameter (whose name ‘w’ could change to any character between samples) begins with a one bytevalue deno!ng the OS version followed by a one byte value for the CPU architecture. These values are03/04/24, 17:50New Sofacy Attacks Against US Government Agency Pagina 4 di 6https://unit42.paloaltonetworks.com/unit42-new-sofacy-attacks-against-us-government-agency/immediately followed by a new line delimited list of running processes on the system.disk = The name of the system's hard drive, obtained from the registry key\"SYSTEM\\CurrentControlSet\\Services\\Disk\\Enum\\0\"build = The hardcoded build iden!ﬁer for the Trojan versioninject = (Op!onal, not displayed in Figure 2) If the Trojan injected its code into other processes to interact with theC2 serverThis callback data allows the threat actors to determine if the infected machine is a target of interest, as thebeacon contains a list of running processes and the name of the storage device that could be used to ﬁlter outanalysis systems or researchers. If the actors believe the system is of interest, they will respond to these networkbeacons to download and execute addi!onal secondary payloads on the system. The Trojan parses the responseto the beacons for two ac!ons \"Execute\" and \"Delete\" between the tags \"[ﬁle]\" and \"[/ﬁle]\", as well as se'ngslabeled \"FileName\", \"PathToSave\", \"Rundll\" and \"IP\" between the tags \"[se'ngs]\" and \"[/se'ngs]\". This allows thethreat actors to download addi!onal ﬁles to the system, execute both executables and DLLs and delete ﬁles.The InfrastructureThe ini!al analyzed sample in this a#ack only contained a single malicious command and control loca!on,191.101.31.6. We have not observed this IP address used by the Sofacy group in any previous a#ack campaigns,and examining passive DNS data showed no other correla!ons to poten!ally related a#acks. The sample also seenby Prevenity appeared to only have a single primary C2 domain, servicecdp[.]com. This domain also appears to benewly created for this speciﬁc a#ack campaign, with no strong links to any previous a#acks.Pivo!ng oﬀ the unique registry key used for persistence revealed links to a previously observed Sofacy campaign,from mid-2015. Two addi!onal payloads with recent compile dates of March 7, 2016, were discovered using thesame persistence mechanism, and analysis of those payloads revealed one primary C2 domain,munimonoce[.]com, and three secondary C2 domains, www.wscapi[.]com, www.tabsync[.]net, and storsvc[.]org.The secondary C2 domains may appear familiar, as they were widely publicized in a report from iSight Partners inJuly 2015 as C2 domains related to the Sofacy group aka Tsar Team.In addi!on, the primary C2 domain munimonoce[.]com previously had resolved to the IP 66.172.11.207, whichwas previously iden!ﬁed as a primary C2 IP for a Sofacy payload with a compile !mestamp of June 11, 2015. Thispar!cular sample also happened to use the exact same secondary C2 domains of www.wscapi[.]com,www.tabsync[.]net, and storsvc[.]org, but lacked the newly discovered persistence mechanism. 03/04/24, 17:50New Sofacy Attacks Against US Government Agency Pagina 5 di 6https://unit42.paloaltonetworks.com/unit42-new-sofacy-attacks-against-us-government-agency/The Sofacy group o%en re-uses infrastructure components across mul!ple a#ack campaigns, whether to speedthe ﬂow of a#acks, for a lack of available resources commi#ed, or out of sheer laziness. In this case, the newera#ack campaign appears to use newly created infrastructure, but s!ll maintains some overlap with previousSofacy-related C2s. We believe this overlap could possibly be due to an oversight when adap!ng a previous codebase with the new persistence method discussed in this blog for the new a#ack campaign.The threat appears to be moving toward deployment of one-oﬀ infrastructure that can make analysis of a#ackcampaigns and correla!on more challenging. This shi% stresses the importance of analysts and researchers beingable to pivot on all ar!facts of a given a#ack, not simply relying on network indicators. In this case, we were ableuse AutoFocus to pivot on a common registry key unique to this a#ack campaign to quickly iden!fy where itcorrelates with characteris!cs of previous a#acks.ConclusionThe Sofacy group con!nues its a#ack campaigns on government organiza!ons, speciﬁcally the U.S. government inthis latest spear-phishing example. The threat group added a new persistence mechanism that requires userinterac!on by loading its payload into Microso% Oﬃce applica!ons when opened, which may help the actors toevade detec!on. The use of this new persistence method shows the con!nued development of tac!cs andtechniques employed by this threat group, o%en !mes in clever ways as we observed in this instance.Palo Alto Networks customers are protected from the new Sofacy Carberp variant and can gather addi!onalinforma!on using the following tools:WildFire detec!on of all known samples as maliciousAll known C2s are classiﬁed as malicious in PAN-DBAutoFocus tags have been created SofacyCarberpIndicatorsDelivery Documents03cb76bdc619fac422d2b954adfa511e7ecabc106adce804b1834581b5913bca (Exercise_Noble_Partner_16.r$)12572c2fc2b0298ﬀd4305ca532317dc8b97ddfd0a05671066fe594997ec38f5(Pu!n_Is_Being_Pushed_to_Prepare_for_War.r$ and Russian an!-Nato troops.r$)Loader Trojansc2551c4e6521ac72982cb952503a2e6f016356e02ee31dea36c713141d4f3785 (btecache.dll)be1cfa10fcf2668ae01b98579b345ebe87dab77b6b1581c368d1aba9fd2f10a0 (bitsprex3.dll)(d5c2cf1c1f17402cc313fe3266b097a46e08f48b971570ef4667(fd6b7301 (amdcache.dll)Payloads69940a20ab9abb31a03fcefe6de92a16ed474bbdﬀ3288498851afc12a834261 (svchost.dll)aeeab3272a2ed2157ebf67f74c00fafc787a2b9bbaa17a03be1e23d4cb273632 (clconfg.dll)dfa8a85e26c07a348a854130c652dcc6d29b203ee230ce0603c83d9f11bbcacc (iprpp.dll)03/04/24, 17:50New Sofacy Attacks Against US Government Agency Pagina 6 di 6https://unit42.paloaltonetworks.com/unit42-new-sofacy-attacks-against-us-government-agency/57d230ddaf92e2d0504e5bb12abf52062114(8980c5ecc413116b1d6ﬀedf1b (clconfg.dll)Command and Control191.101.31.6munimonoce[.]comwscapi[.]comtabsync[.]netstorsvc[.]orgservicecdp[.]comGet updates from Palo Alto Networks!Sign up to receive the latest news, cyber threat intelligence and research from usEmail addressSubscribeBy submi'ng this form, you agree to our Terms of Use and acknowledgeour Privacy Statement.   2024 Palo Alto Networks, Inc. All rights reserved.Popular ResourcesResource CenterBlogCommuni!esTech DocsUnit 42SitemapLegal NoticesPrivacyTerms of UseDocumentsAccountManage Subscrip!onsReport a Vulnerability"
}