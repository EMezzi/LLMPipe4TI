{
    "title": "menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations",
    "text": "01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 1 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/menuPass Returns with New Malware and NewA!acks Against Japanese Academics andOrganiza\"ons63,475people reacted78 min. read This post is also available in: ೔ຊޠ( Japanese)In 2016, from September through November, an APT campaign known as “menuPass”  targeted Japaneseacademics working in several areas of science, along with Japanese pharmaceu!cal and a US-based subsidiary of aJapanese manufacturing organiza!ons. In addi!on to using PlugX and Poison Ivy (PIVY), both known to be used bythe group, they also used a new Trojan called “ChChes” by the Japan Computer Emergency Response TeamCoordina!on Center (JPCERT).  In contrast to PlugX and PIVY, which are used by mul!ple campaigns, ChChesappears to be unique to this group. An analysis of the malware family can be found later in this blog.Interes!ngly, the ChChes samples we observed were digitally signed using a cer!ﬁcate originally used byHackingTeam and later part of the data leaked when they were themselves hacked. Wapack labs also observed asimilar sample targe!ng Japan in November. It’s not clear why the a\"ackers chose to use this cer!ﬁcate, as it wasold, had been leaked online, and had already been revoked by the !me they used it. Digital cer!ﬁcates are typicallyused because they aﬀord an air of legi!macy, which this one deﬁnitely does not.The a\"ackers spoofed several sender email addresses to send spear phishing emails, most notably publicaddresses associated with the Sasakawa Peace Founda!on and The White House. All the spear phishes wereBy Jen Miller-Osborn and Josh GrunzweigFebruary 16, 2017 at 11:00 AMCategory: Unit 42Tags: MenuPassunit42THREATRESEARCHTHENEXTSTEPINTHREATINTELLIGENCESHARE  Under Attack?About Unit 42ServicesUnit 42 Threat ResearchPartnersResources01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 2 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/socially engineered with subjects appropriate for the target and the apparent sender. One of the more interes!ngsubject lines was used in the White House a\"ack; “[UNCLASSIFIED] The impact of Trump’s victory to Japan,” senttwo days a$er the elec!on.  Most of the a\"acks against academics involved webmail addresses using names ofacademics but are not !ed to those academics openly online. However, all the spear phish recipients used emailaddresses !ed to them online. Figure 1. Recent menuPass ac!vity and some !es to older infrastructureThe C2 infrastructure in these a\"acks is largely actor registered, with only a few Dynamic Domain Name System(DDNS) domains. menuPass typically makes use of a mix of DDNS and actor-registered domains in their a\"ackcampaigns. All of the related hashes and C2s are in appendix at the end of this blog.Ties to menuPassThere is not much public informa!on about the APT campaign called menuPass (also known as Stone Panda andAPT10).  A paper from FireEye in 2013 on several campaigns using PIVY included menuPass as one of them.  Alater blog added some addi!onal details. The group name is derived from one of the passwords they use with PIVYin their a\"acks. Believed to have started ac!vity in 2009 and to originate from China, the group ini!ally wasknown for targe!ng US and overseas defense contractors but broadened their targe!ng as !me passed. They havetargeted Japanese organiza!ons since at least 2014.The newer ChChes malware family uses an import hash (bb269704ba8647da97377440d403ae4d) shared withother tools used by menuPass, aﬀording an ini!al link. However, the !es are most strongly proved throughinfrastructure analysis, which shows a number of links between the newer infrastructure used in these a\"acks andolder infrastructure publicly associated with the group. The three circled domains represent C2s publicly reportedas !ed to menuPass, linked to domains not previously publicly reported as associated. These are only a few ofmul!ple overlaps analysts can ﬁnd while researching menuPass infrastructure. The circled known domains are theﬁrst three below:apple[.]cmdnetview[.]com%i[.]sexxxy[.]bizcvnx[.]zyns[.]comcia[.]toh[.]info2014[.]zzux[.]comiphone[.]vizvaz[.]com01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 3 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/ Figure 2. menuPass infrastructure overlapsTwo of these domains can further be !ed into the newer C2 infrastructure. Again, these are only a few of theoverlaps that can be uncovered by analyzing the infrastructure used by menuPass. The domains in the belowﬁgure are:cia[.]toh[.]info2014[.]zzux[.]comwchildress[.]comlion[.]wchildress[.]comkawasaki[.]unhamj[.]comsakai[.]unhamj[.]comkawasaki[.]cloud-maste[.]comfukuoka[.]cloud-maste[.]comyahoo[.]incloud-go[.]commsn[.]incloud-go[.]comwww[.]mseupdate[.]ourhobby[.]comcontractus[.]qpoe[.]com01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 4 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/ Figure 3. Ties between new and older infrastructure.Addi!onally, the passwords in the PIVY samples also ﬁt known passwords used by the group – three samples use“menuPass” and the other uses “keaidestone.”  With these data points, we assess with high conﬁdence the recenta\"acks were conducted by the menuPass group.Following is our analysis of the ChChes malware family.Malware AnalysisFor this analysis, Unit 42 looked at the following ﬁle:MD5c0c8dcc9dad39da8278bf8956e30a3fcSHA1009b639441ad5c1260f55afde2d5d21fc5b4f96cSHA2566605b27e95f5c3c8012e4a75d1861786%749b9a712a5f4871adbad81addb59eCompile Time2016-11-24 01:31:37 UTC This malware is provided with an icon that appears to be that of a Microso$ Word document, as we can see in theimage below.01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 5 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/ Figure 4. Icon used for ChChesAddi!onally, we discovered that the samples iden!ﬁed in a\"acks against Japanese organiza!ons were digitallysigned using the cer!ﬁcate originally used by the Italian-based company, HackingTeam. Readers may recall thatHackingTeam was compromised and subsequently had a large amount of internal data exposed in July 2015. Thisdata included a wealth of code used by the organiza!on, including cer!ﬁcates. The cer!ﬁcate in ques!on wasfairly old, and expired on August 4, 2012. On July 10, 2015, the cer!ﬁcate was revoked.thth01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 6 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/ Figure 5.  Digital signing of ChChes01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 7 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/ Figure 6.  Cer!ﬁcate revoca!onMul!ple instances of malware have been discovered using this cer!ﬁcate since it was originally leaked in 2015. Itis unclear why the actors decided to use this cer!ﬁcate that is !ed to known malicious samples for their ownsamples. One possibility may be to make a\"ribu!on more diﬃcult for analysts researching these threats.01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 8 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/When the malware is ini!ally run, it will ﬁrst decrypt an embedded stub of code within the malware prior toexecu!ng it. This stub has many characteris!cs seen in shellcode, and begins by crea!ng a new Import AddressTable (IAT). This new IAT is then referenced throughout the remainder of the code when calling Windows APIs.The following snippet of assembly shows the newly created IAT being referenced to call various func!ons, such asGetProcessHeap, RtlAllocateHeap, RtlReAllocateHeap, and InternetReadFile. Figure 7.  Newly created IAT being used to call Windows API func!ons01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 9 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/A$er the IAT has been generated, the malware will determine the path of %TEMP% and set its current workingdirectory to this value. ChChes proceeds to collect the following informa!on about the vic!m:HostnameProcess Iden!ﬁer (PID)Current working directory (%TEMP%)Window resolu!onMicroso$ Windows versionThis informa!on is aggregated into a string such as the following:WBQTLJRH9553618*2564?3618468394?C:\\\\Users\\\\ADMINI~1\\\\AppData\\\\Local\\\\Temp?1.4.1(1024x768)*6.1.7601.17514Note that in the string above, the ‘3618468394’ and ‘1.4.1’ strings are hardcoded within the malware itself. Thesemay indicate versions of the malware or campaign iden!ﬁers, however, this has not been conﬁrmed.A$er this data has been aggregated, it is uploaded to a hardcoded command and control (C2) server via HTTP. Thedata is embedded within the ‘Cookie’ HTTP header, as seen below Figure 8.  Ini!al HTTP beacon for ChChesThe URI used above is randomly generated for each HTTP request made by ChChes. The data embedded withinthe Cookie header is encrypted using a unique technique. For each key/value pair, separated by a ‘;’, the malwarewill ﬁrst perform a MD5 hash of the key, and extract the middle 16 bytes. The value is base64-decoded a$er thestring is unquoted. Finally, the base64-decoded data is decrypted using RC4 with the previously obtained 16bytes. All of the data is concatenated to form the ﬁnal, decrypted data.The following Python code shows an example of decoding the supplied Cookie ﬁeld:12345import urllibimport base64from binascii import *import hashlib 01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 10 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/The script above produces the following output:The ini!al ‘A’ character witnessed in the output above instructs the remote server that this is an ini!al beacon, orthe ﬁrst expected request sent by ChChes.The C2 will respond with a ‘Set-Cookie’ header that contains the middle 16 bytes of the MD5 hash performedagainst the hostname and PID. Using the above example, the C2 would perform the MD5 against‘WBQTLJRH9553618*2564’.The resul!ng middle 16 characters is ‘b331106210b6364c’.The subsequent request made by ChChes looks like the following: Figure 9. Second network request made by ChChes67891011121314151617181920212223242526272829303132333435363738394041def md5_get_middle(data):  m = hashlib.md5()  m.update(data)  o = m.digest()  hexed = hexlify(o)  return hexed[8:24] def rc4_crypt(data, key):  S = range(256)  j = 0  out = []  for i in range(256):    j = (j + S[i] + ord( key[i % len(key)] )) % 256    S[i] , S[j] = S[j] , S[i]  i = j = 0  for char in data:    i = ( i + 1 ) % 256    j = ( j + S[i] ) % 256    S[i] , S[j] = S[j] , S[i]    out.append(chr(ord(char) ^ S[(S[i] + S[j]) % 256]))  return ''.join(out) cookie_string = 'OtKoVg=jlIt2Eh55%2F%2F38%2FJbKlZpYFNNFhXgOgc0zzNqAxvls8edznJy4k%2BpxKUl1GG15OTRuC%2Blc5R6WGCmOHyPNObeV2OL0ppBty%2Bj3JOsKlUupX%2Fpk6WumT8yLGWtHVQZHZhUxdY%3D;KR9nHItU=MTBOzPjjkPOom89lXeC0A%2Fc%3D' all_decrypted = \"\"sub_strings = cookie_string.split(\";\")for s in sub_strings:  key, data = s.split(\"=\")  new_key = md5_get_middle(key)  new_data = base64.b64decode(urllib.unquote(data))  decrypted = rc4_crypt(new_data, new_key)  decrypted_data = decrypted.split(key)[1]  all_decrypted += decrypted_data print \"Decrypted String:\"print repr(all_decrypted)12Decrypted String:'AWBQTLJRH9553618*2564?3618468394?C:\\\\Users\\\\ADMINI~1\\\\AppData\\\\Local\\\\Temp?1.4.1 (1024x768)*6.1.7601.17514' 12jgrunzweig$ echo -n WBQTLJRH9553618*2564 | md57fc27808b331106210b6364c326569fd 01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 11 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/Decrypted, we see the following contents stored within the Cookie ﬁeld:Bb331106210b6364cThe ﬁrst character of ‘B’ signiﬁes that this is the second request, and the remaining data is the 16 bytes previouslyseen in the C2 response within the Set-Cookie header.At this stage, the C2 server is expected to return content in the following format:[Middle MD5][Base64-Encoded Data][Middle MD5]The ‘Middle MD5’ ﬁeld contains the middle 16 bytes of the MD5 hash of the ‘b331106210b6364c’ string. Thiswould result in a string of ‘500089dadf52ae0b’ in this par!cular example. The ‘Base64-Encoded Data’ ﬁeldcontains a fairly complex structure that will store a module that is to be loaded and subsequently run by ChChes.A visualiza!on of this network communica!on can be seen in the following ﬁgure:01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 12 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/ Figure 10. Network ﬂow of ChChesChChes acts as an ini!al inﬁltra!on point on a vic!m machine. It has the ability to load addi!onal code that in turnmay accomplish any number of tasks. During analysis, no C2 servers were found to be ac!ve, and Unit 42 wasunable to iden!fy any modules being loaded by ChChes. However, the JPCERT also recently analyzed this familyand was able to collect modules that give ChChes the following func!ons:Encryp!on of communica!on by AESExecute shell commandUploading and downloading ﬁles01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 13 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/Loading and execu!ng the DLLTask list of bot commandHowever, the lack of persistence built into ChChes suggests that it by itself is not intended to run on a vic!m’smachine for long periods of !me.  In a successful intrusion, it may be only a ﬁrst stage tool used by the a\"ackers toorient where they landed in a network, and other malware will be deployed as a second stage layering forpersistence and addi!onal access as the a\"ackers move laterally through a network.ConclusionThese a\"acks show Japan con!nues to be a target of interest to APT campaigns. menuPass has targetedindividuals and organiza!ons in Japan since at least 2014, and as the same organiza!ons and academics werelargely targeted each month in these a\"acks, it further shows menuPass is persistent in a\"empts to compromisetheir targets.  menuPass also heavily favors spear phishing, and so takes steps to socially engineer their spearphishes for maximum appearance of legi!macy. This, and their persistence, highlights the need for training andawareness of spear phishing on the part of both individuals and organiza!ons likely to be targeted. menuPass is anongoing APT campaign with a broad range of targets and will likely con!nue to target Japan in the future.Palo Alto Networks customers are protected from these malware families and C2 infrastructure by:All C2 domains are ﬂagged as malicious in Threat Preven!on and PAN-DBAll three families are properly tagged malware by WildFire. Autofocus subscribers can learn more about eachfamily via their tags:ChChesPoison IvyPlugXAddi!onally, Autofocus subscribers can learn more about menuPass by exploring !ed ac!vity with the menuPasstag.Indicators of CompromiseSHA256 HashesSHA256 HashesSHA256 HashesSHA256 HashesChChes5961861d2b9f50d05055814e6bfd1c6291b30719f8a4d02d4cf80c2e87753fa1e90064884190b14a6621c18d1f9719a37b9e5f98506e28ﬀ0636438e3282098bae6b45a92384f6e43672e617c53a44225e2944d66c1'074694526386074145fd6a956a7708708cddﬀ78c8505c7db73d7c4e961da8a3c00cc5a51171a92b7b01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 14 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/2c71eb5c781daa43047fa6e3d85d51a061aa1dfa41feb338e0d4139a6dfd6910316e89d866d5c710530c2103f183d86c31e9a90d55e2ebc2dda94f112f3bdb6defa0b414a831cbf724d1c67808b7483dec22a981ae670947793d114048f880576605b27e95f5c3c8012e4a75d1861786%749b9a712a5f4871adbad81addb59efadf362a52dcf884f0d41ce3df9eaa9bb30227afda50c0e0657c096baﬀ501f02965c1b6ab9d1601752cb4aa26d64a444b0a535b1a190a70d5ce935be3f91699e88f5bf4be37e0dc90ba1a06a2d47faaeea9047fec07c17c2a76f9f7ab98acf0d26dae0d8e5c23ec35e8b9cf126cded45b8096fc07560ad1c06585357921eeede6ecb146f469d243945ad8a5451ba1129c5b190f7d50c64580dbad4b8246f88e4521a74337a8b454f9b80c7d9e57b4c9580567f84e513d9a3ce763275c55e691bc2f07066c624663b0a6f71cb965009d4d9b480213de51809cdc454ca55f1a91c21eaadf9ﬀc62ca4673e27e06c16447f103c0cf7acd8db6ac5c8bd17805e39df251485a62e104dfd8629dc4d2dfd572ebd0ab554602d682a28682876a47e773b20ce00a6864225f05de6407fac80ddb83cd0aec00ada438c1e354cdd0d7d5dfc6b8ed157eed54958da73716f8db253ba5124a0e4b649f08de060c4aa6531afc9a6692690c03ec33c758cb5648be1ed886ﬀ039e6b72f1c43b23%d9c342ce8ccb0c8681a407a76f8c0fd2512197aafad8120aa62e5c871c29d1fd2a102bc6284cc0adf4baa1e3932d74282a'1a137b30820934ad4f80daceec712ba2bbe14312dc69dd6ea16842d6e58cd7fd98ba4d28eefeb4fd4c4d198fac4eee76f93c345d804f35266b26bf63e3d616715fc593931e33aa07feba5ad6875609692efa219aa5019f3c00211182b2a80dd9675721dac7c%31d174436d3b8ec9f97d898b 01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 15 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/PlugXf1ca9998ca9078c27a6dab286dfe25fcd%1ad734cc2af390bdcb97da12145636392e0701a77ea25354b1f40f5b867a35c0142abde785a66b83c9c8d2c14c0c36c7e85e426999579dd6a540fcd827b644a79cda0ad50211d585a0be5135715869f01dd2b19a1032e848619428dd46bfeb6772be2e78b33723d2fa076f1320c576c7e85e426999579dd6a540fcd827b644a79cda0ad50211d585a0be51357158676721d08b83aae945aa00fe69319f896b92c456def4df5b203357cf443074c03dcﬀ19fc193f1ba63c5dc6f91f00070e6912dcec3868e889fed37102698b554b7eeaa97d346bc3f8090e5b742f42e8900127703420295279ac7e04d06ebe0a04a6b6c66735e5e26002202b9d263bf8c97e278f6969c141853857000c8d242d245412cddde0a2f2d78ec9de0f9a02ac2b22882543c9f15724ebe14b3a0bf8cbda92dbbe0eﬀ3fe0082c3485b99e6a949d9c3747afa493a0a1e336829a7c1faa% PIVYf0002b912135bcee83f901715002514fdc89b5b8ed7585e07e482331e4a56c06412120355d9ac8c37b5623eea86d82925ca837c4f8be4aa24475415838ecb35644a7bea8a08f4c2feb74c6a00ﬀ1114ba251f3dc6922ea5ﬀab9e749c98cbdce9edf191c6ca1e4eddc40c33e2a2edf104ce8dﬀf37b2a8b57b8224312ﬀ008fe C2sdick[.]ccfchrist[.]comtrout[.]belowto[.]com01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 16 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/sakai[.]unhamj[.]comzebra[.]wthelpdesk[.]comarea[.]wthelpdesk[.]comkawasaki[.]cloud-maste[.]comkawasaki[.]unhamj[.]comfukuoka[.]cloud-maste[.]comscorpion[.]poulsenv[.]comlion[.]wchildress[.]com%i[.]sexxxy[.]bizcia[.]toh[.]info2014[.]zzux[.]comn\"data[.]otzo[.]comiphone[.]vizvaz[.]comapp[.]lehigtapp[.]comjimin[.]jimindaddy[.]comJepsen[.]r3u8[.]cominspgon[.]re26[.]comnunluck[.]re26[.]comyahoo[.]incloud-go[.]commsn[.]incloud-go[.]comwww[.]mseupdate[.]ourhobby[.]comcontractus[.]qpoe[.]com01/04/24, 21:11menuPass Returns with New Malware and New Attacks Against Japanese Academics and Organizations Pagina 17 di 17https://unit42.paloaltonetworks.com/unit42-menupass-returns-new-malware-new-attacks-japanese-academics-organizations/apple[.]cmdnetview[.]comcvnx[.]zyns[.]com Get updates from Palo Alto Networks!Sign up to receive the latest news, cyber threat intelligence and research from usEmail addressSubscribeBy submi(ng this form, you agree to our Terms of Use and acknowledgeour Privacy Statement.   2024 Palo Alto Networks, Inc. All rights reserved.Popular ResourcesResource CenterBlogCommuni!esTech DocsUnit 42SitemapLegal NoticesPrivacyTerms of UseDocumentsAccountManage Subscrip!onsReport a Vulnerability"
}