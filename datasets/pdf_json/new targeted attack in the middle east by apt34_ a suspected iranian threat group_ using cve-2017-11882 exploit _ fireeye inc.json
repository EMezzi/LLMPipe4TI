{
    "title": "new targeted attack in the middle east by apt34_ a suspected iranian threat group_ using cve-2017-11882 exploit _ fireeye inc",
    "text": " PREVIOUS POST nEXT POSTThreat Research new Targeted attack in the Mi ddle East by aPT 34, a Suspected Iranian Th reat Group, Using CVE-2017-11882 Exploit Decembe r 07, 2017 | by Manish Sardiwal, Vincent Cannon , nalani Fraser, Yogesh Londhe, nick Richa rd, Jacqueline O’Lea ry MIDDLE EaST   aPT Less than a week afte r Microsoft issued a patch fo r CVE-2017-11882  on nov. 14, 2017, FireEye observed an attacke r using an exploit fo r the Mic rosoft Office v ulnerability to ta rget a gove rnment o rganization in the Mi ddle East. We a ssess this activity was carried out by a suspected Iranian cybe r espionage th reat group, whom we refer to as aPT34, using a custom Po werShell back door to achieve it s objective s. We believe aPT 34 is involve d in a long-te rm cybe r espionage ope ration la rgely foc used on reconnai ssance efforts to benefit Iranian nation- state inte rests and has been ope rational since at lea st 2014. This threat group has conducted broad targeting ac ross a variety of in dustries, including financial, gove rnment, ene rgy, chemical, and telecomm unication s, and has largely foc used its operations within the Mi ddle East. We a ssess that aPT 34 works on behalf of the Iranian gove rnment ba sed on infrastructure details that contain references to Iran, use of Iranian inf rastructure, and targeting that align s with nation- state inte rests. aPT34 uses a mix of p ublic and non-public tool s, often con ducting spear phishing ope rations using comp romised accounts, sometime s coupled with social enginee ring tactic s. In May 2016 , we published a blog detailing a spear phishing campaign  targeting bank s in the Mi ddle East region that used macro-enable d attachment s to distribute POWBaT mal ware. We no w attribute that campaign to aPT 34. In July 2017, we observed aPT34 targeting a Middle East organization using a Po werShell-ba sed backdoor that we call POWRU nER and a downloader with domain gene ration algo rithm functionality that we call BO nDUPDaT ER, based on strings within the mal ware. The back door was delivered via a malicio us .rtf file that exploite d CVE-2017-0199 . In this latest campaign, aPT 34 leveraged the recent Mic rosoft Office v ulnerability CV E-2017-11882  to deploy POWRU nER and BOnDUPDaT ER. The full report on aPT 34 is available to o ur MySIGHT customer community. aPT34 loosely align s with public reporting related to the g roup \"OilRig\" . as individual organizations may track adversaries using varied data sets, it is possible that o ur classification s of activity may not wholly align. CVE-2017-11882 : Microsoft Office Stack Memo ry Corruption V ulnerability CVE-2017-11882  affects several versions of Microsoft Office an d, when exploite d, allows a remote user to run arbitrary code in the context of the c urrent user as a result of imp roperly handling object s in memo ry. The vulnerability was patche d by Mic rosoft on nov. 14, 2017. a full proof of concept (POC) was publicly released a week late r by the reporter of the v ulnerability. The vulnerability exi sts in the ol d Equation Editor (EQnEDT32.EXE), a component of Mic rosoft Office that i s used to insert and evaluate mathematical fo rmulas. The Equation Editor is embedded in Office documents using object linking an d embedding (OL E) technology. It is created as a separate process instead of child process of Office application s. If a crafted formula is passed to the Equation Editor, it does not check the data length properly while copying the data, which results in stack memo ry corruption. a s the EQnEDT32.exe is compile d using an ol der compile r and does not support address space layo ut randomization (aSLR), a techniq ue that guards against the exploitation of memo ry corruption vulnerabilities, the attacke r can ea sily alter the flow of program exec ution. analysis aPT34 sent a malicio us .rtf file (MD 5: a0e6933 f4e0497269620 f44a083b2ed4) as an attachment in a malicio us spear phishing email sent to the victim o rganization. The malicio us file exploit s CVE-2017-11882 , which corrupts the memo ry on the stack an d then p roceeds to push the malicio us data to the stack. The mal ware then overwrites the function a ddress with the a ddress of an exi sting instruction from EQnEDT32.EXE. The overwritten instruction (displayed in Figure 1) is used to call the “Win Exec” function f rom kernel32.dll, as depicted in the in struction at 00430c12, which call s the “Win Exec” function. Figure 1: Disassembly of ove rwritten function a ddress after exploitation, the ‘Win Exec’ function i s successfully called to create a chil d process, “mshta.exe”, in the context of c urrent logge d on user. The process “mshta.exe” downloads a malicio us script from hxxp://m umbai- m[.]site/b.txt an d executes it, as seen in Fig ure 2. Figure 2: attacke r data copie d to corrupt stack buffer Execution Wo rkflow The malicio us script goe s through a series of steps to successfully exec ute and ultimately e stablish a connection to the comman d and control (C2) server. The full sequence of event s starting with the exploit document is illustrated in Figure 3. Figure 3: CVE-2017-11882  and POWRU nER attack sequence 1. The malicio us .rtf file exploit s CVE-2017-11882 . 2. The mal ware overwrites the function a ddress with an exi sting instruction from EQnEDT32.EXE. 3. The mal ware creates a child process, “mshta.exe,” which downloads a file from: hxxp://m umbai-m[.] site/b.txt. 4. b.txt contain s a PowerShell comman d to download a dropper from: hxxp:// dns-update[.]club/v.txt. The PowerShell comman d also renames the downloaded file from v.txt to v.vb s and executes the script. 5. The v.vb s script drops four component s (hUpdateChecke rs.base, dUpdateChecke rs.base, cUpdateChecke rs.bat, an d GoogleUp dateschecker.vbs) to the directory: C:\\ProgramData\\Win dows\\Microsoft\\java\\ 6. v.vbs uses CertUtil.exe, a legitimate Mic rosoft comman d-line program installed as part of Certificate Se rvices, to decode the ba se64-encoded files hUpdateChecke rs.base and dUpdateChecke rs.base, and drop hUpdateChecke rs.ps1 and dUpdateChecke rs.ps1 to the staging directory. 7. cUpdateChecke rs.bat is launched and creates a scheduled task for GoogleUp dateschecker.vbs persistence. 8. GoogleUp dateschecker.vbs is executed after sleeping fo r five seconds. 9. cUpdateChecke rs.bat and *.base are deleted from the staging directory. Figure 4 contain s an exce rpt of the v.vb s script pertaining to the Execution Wo rkflow section. Figure 4: Execution Wo rkflow Section of v.vb s after successful execution of the steps mentione d in the Execution Wo rkflow section, the Ta sk Scheduler will launch GoogleUp dateschecker.vbs every minute, which in t urn executes the dUpdateChecke rs.ps1 and hUpdateChecke rs.ps1 scripts. These PowerShell scripts are final stage payloa ds – they incl ude a downloader with domain gene ration algo rithm (DGa) f unctionality an d the back door component, which connect to the C 2 server to receive comman ds and perform additional malicio us activitie s.  hUpdateChecke rs.ps1 (POWRU nER) The back door component, POWRU nER, is a PowerShell script that sends and receives comman ds to and from the C2 server. POWRU nER is executed every minute by the Ta sk Scheduler. Figure 5 contain s an exce rpt of the POWRU nER backdoor. Figure 5: POWRU nER PowerShell script hUp dateChecke rs.ps1 POWRU nER begin s by sending a random GET request to the C 2 server and waits for a response. The server will respond with eithe r “not_no w” or a random 11-digit number. If the response is a random number, POWRU nER will send anothe r random GET request to the server and store the response in a string. POWRU nER will then check the la st digit of the stored random number response, interpret the val ue as a comman d, and perform an action ba sed on that comman d. The comman d values and the associated actions are described in Table 1. Comman d Description action 0Server response string contain s batch comman dsExecute batch comman ds and send results back to server 1Server response string is a file pathCheck fo r file path and upload (PUT) the file to server 2Server response string is a file pathCheck fo r file path and download (GET) the file Table 1: POWRU nER comman ds after successfully exec uting the comman d, POWRU nER sends the results back to the C 2 server and stops execution. The C2 server can also send a PowerShell comman d to capt ure and store a screenshot of a victim’ s system. POWRU nER will send the capt ured screenshot image file to the C 2 server if the “file upload” comman d is issued. Figure 6 shows the Po werShell “Get-Sc reenshot” function sent by the C 2 server. Figure 6: Powershell Screenshot Functionality dUpdateChecke rs.ps1 (BOnDUPDaT ER) One of the recent a dvancement s by aPT 34 is the use of DGa to gene rate subdomains. The BO nDUPDaT ER script, which was named based on the ha rd-coded string “B007”, uses a custom DGa algo rithm to gene rate subdomains for communication with the C 2 server. DGa Implementation Figure 7 provides a breakdown of ho w an example domain (4 56341921300006 B0C8B2CE9C9B007.mumbai- m[.]site) is generated using BOnDUPDaT ER’s custom DGa. Figure 7: Breakdown of subdomain c reated by BOnDUPDaT ER 1. This is a randomly gene rated number created using the follo wing exp ression: $rnd = -join (Get-Ran dom - InputObject ( 10..99) -Count (%{ Get-Ran dom -InputObject ( 1..6)})); 2. This value is either 0 or 1. It is initially set to 0. If the first resolved domain IP address starts with 24.125.X.X, then it i s set to 1. 3. Initially set to 000, then inc remente d by 3 after every DnS request 4. First 12 characters of system UU ID. 5. “B007” hardcoded string. 6. Hardcoded domain “m umbai-m[.] site” BOnDUPDaT ER will attempt to resolve the resulting DGa domain an d will take the follo wing action s based on the IP address resolution: 1. Create a tempo rary file in %temp% location The file c reated will have the la st two octet s of the resolved IP addresses as its filename. 2. BOnDUPDaT ER will evaluate the la st character of the file name an d perform the co rresponding action fo und in Table 2. Character Description 0File contain s batch comman ds, it executes the batch comman ds 1Rename the temporary file as .ps1 extension 2Rename the temporary file as .vbs extension Table 2: BOnDUPDaT ER action s Figure 8 is a screenshot of BO nDUPDaT ER’s DGa implementation. Figure 8: Domain Gene ration algo rithm Some example s of the gene rated subdomains observed at time of exec ution incl ude: 143610035 BaF04425847B007.mumbai-m[.] site 835710065 BaF04425847B007.mumbai-m[.] site 376110095 BaF04425847B007.mumbai-m[.] site network Comm unication Figure 9 shows example net work comm unication s between a POWRU nER backdoor client an d server. Figure 9: Example network Comm unication In the example, the POWRU nER client sends a random GET request to the C 2 server and the C2 server sends the random number (99999999990 ) as a response. as the response is a random number that en ds with ‘0’, POWRU nER sends anothe r random GET request to receive  an a dditional comman d string. The C 2 server sends back Ba se64 encoded response. If the server had sent the string “not_no w” as response, as shown in Fig ure 10, POWRU nER would have cea sed any further requests and terminated its execution. Figure 10: Example \"not no w\" server response Batch Comman ds POWRU nER may al so receive batch comman ds from the C 2 server to collect ho st information f rom the system. This may incl ude information abo ut the currently logge d in user, the ho stname, net work config uration data, active connection s, process information, local an d domain a dministrator accounts, an enumeration of user directories, and other data. an example batch comman d is provided in Figure 11. Figure 11: Batch comman ds sent by POWRU nER C2 server additional U se of POWRU nER / BOnDUPDaT ER aPT34 has used POWRU nER and BOnDUPDaT ER to target Middle East organizations as early as July 2017. In July 2017, a FireEye Web MPS appliance detected and blocked a request to retrieve an d install an aPT 34 POWRU nER / BOnDUPDaT ER downloader file. During the same month, Fi reEye observed aPT34 target a separate Middle East organization using a malicio us .rtf file (MD 5: 63D66D99E46FB93676a4F475a65566 D8) that exploite d CVE-2017-0199 . This file issued a GET request to download a malicio us file from: hxxp:// 94.23.172.164/dupdatechecke r.doc. as shown in Fig ure 12, the script within the dupatechecke r.doc file attempt s to download anothe r file name d dupatechecke r.exe from the same server. The file al so contain s a comment by the mal ware author that appea rs to be an appa rent taunt to security researchers. Figure 12: Content s of dupdatechecke r.doc script The dupatechecke r.exe file (MD 5: C9F16F0BE8C77F0170B9B6CE876ED7FB) drops both BO nDUPDaT ER and POWRU nER. These files connect to p roxychecke r[.]pro for C2. Outlook an d Implication s Recent activity by aPT 34 demonstrates that they a re capable g roup with potential acce ss to thei r own development resources. During the pa st few month s, aPT34 has been able to q uickly inco rporate exploit s for at least two publicly vulnerabilities (CVE-2017-0199  and CVE-2017-11882 ) to target organizations in the Mi ddle East. We assess that aPT 34’s efforts to contin uously update thei r malware, including the inco rporation of DGa fo r C2, demonstrate the g roup’s commitment to p ursing strategies to deter detection. We expect aPT 34 will contin ue to evolve thei r malware and tactics as they contin ue to pursue access to entitie s in the Mi ddle East region. IOCs Filename / Domain / IP addressMD5 Hash or Description CVE-2017-11882  exploit documenta0E6933 F4E0497269620 F44a083B2ED4 b.txt 9267D057C065E a7448aCa1511C6F29C7 v.txt/v.vb s B2D13a336a3EB7BD27612BE7D4E334DF dUpdateChecke rs.base 4a7290a279E6F2329E DD06151 78a11FF hUpdateChecke rs.base 841CE6475F271F86D0B5188E 4F8BC6DB cUpdateChecke rs.bat 52Ca9a7424B3CC34099aD218623 a0979 dUpdateChecke rs.ps1 BBDE33F5709CB1452aB941C08aCC775E hUpdateChecke rs.ps1 247B2a9FCBa6E9E C29ED818948939 702 GoogleUp dateschecker.vbsC87B0B711F60132235 D7440aDD0360 B0 hxxp://m umbai-m[.] site POWRU nER C2 hxxp:// dns-update[.]club Malware Staging Se rver CVE-2017-0199  exploit document63D66D99E46FB93676a4F475a65566 D8 94.23.172.164:80 Malware Staging Se rver dupdatechecke r.doc D85818E82 a6E64Ca185EDFDDBa 2D1B76 dupdatechecke r.exe C9F16F0BE8C77F0170B9B6CE876ED7FB proxycheke r[.]pro C2 46.105.221.247Has resolved mumbai-m[.] site & hpserver[.]online 148.251.55.110Has resolved mumbai-m[.] site and dns- update[.]club 185.15.247.147 Has resolved dns-update[.]club 145.239.33.100 Has resolved dns-update[.]club 82.102.14.219Has resolved ns2.dns-update[.]club & hpserver[.]online & anypo rtals[.]com v7-hpserver.online.hta E6aC6F18256 C4DDE5BF06a9191562 F82 dUpdateChecke rs.base 3C63BFF9EC0a340E0727E5683 466F435 hUpdateChecke rs.base EEB0FF0D8841C2EBE643FE328 B6D9EF5 cUpdateChecke rs.bat FB464C365B94B03826E6 7EaBE4BF9165 dUpdateChecke rs.ps1 635E D85BFCaaB7 208a8B5C730D3D0a8C hUpdateChecke rs.ps1 13B338C47C52DE3ED0B68E1 CB7876aD2 googleupdateschecker.vbsDBFEa6154D4F9D7209C1875B2D5D70D5 hpserver[.]online C2 v7-anypo rtals.hta EaF3448808 481FB1FDBB675BC5Ea24DE dUpdateChecke rs.base 42449DD79Ea7D2B5B6482B6F0D493498 hUpdateChecke rs.base a3FCB4D 23C3153DD42aC124B112F1BaE dUpdateChecke rs.ps1 EE1C482C41738aaa5964730DCBaB 5DFF hUpdateChecke rs.ps1 E516 C3a3247aF2F2323291 a670086 a8F anyportals[.]com C2  Email Up dates Information an d insight on to day's advanced threats from FireEye. SHaRE Recent Po sts 17 Mar 2020 16 Mar 2020 09 Mar 2020 RSS FEED: STaY CO nnECTED  First name Last name Email address Company name Threat Research Blog FireEye Stories Blog Industry Perspective s Blog Yes, I would like to receive communication s from FireEye. Please read more about our information collection an d use. SUBSCR IBE Six Fact s about address Space Layout Randomization on Windows  They Come in the night: Ransomware Deployment T rends  Crescendo: Real Time Event Vie wer for macOS    Home  FireEye Blog s Threat Research  new Targeted attack in the Mi ddle East by aPT 34, a...    Company Why Fi reEye? Customer Stories Careers Certification s and Compliance Investor Relation s Supplier Documents news and Events newsroom Press Releases Webina rs Events awards and Honors Email Preferences Technical S upport Incident? Report Security Issue Contact S upport Customer Portal Communities Documentation Po rtal FireEye Blog s Threat Research FireEye Stories Industry Perspective s Threat Map View the Late st Threats Contact U s +1 877-347-3393   Stay Connecte d  Copyright   2020  FireEye, Inc. all rights reserved.  Privacy & Cookie s Policy  | Privacy Shiel d | Legal Doc umentationSite Lang uage English Solutions Services Customers Partners Resources Company  "
}