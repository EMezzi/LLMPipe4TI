{
    "title": "threat actor leverages windows zero-day exploit in payment card data attacks _ fireeye inc",
    "text": " PREVIOUS POST nEXT POSTThreat Research Threat acto r Leverages Windows Zero-day Exploit in Payment Ca rd Data attack s May 11, 2016  | by Dhanesh Kizhakkinan , Yu Wang , Dan Ca selden, Erica Eng | Vulnerabilities 0DaY EXPLOITS  VULnERaBILITIES  ZERO-DaY VUL nERaBILITY  ZERO-DaY EXPLOIT  0DaY   0-DaY In March 2016 , a financially motivate d threat acto r launched several tailored spear phishing campaign s primarily targeting the retail, restaurant, and hospitality in dustries. The email s containe d variations of Microsoft Word documents with embedded macros that, when enabled, downloaded and executed a malicio us downloader that we refer to as PUnCHBUGGY. PUnCHBUGGY i s a dynamic-link lib rary (DLL) downloader, existing in both 32-bit and 64-bit ve rsions, that can obtain a dditional co de over HTTPS. Thi s downloader was used by the th reat acto r to inte ract with comp romised systems and move late rally across victim envi ronment s. FireEye identified more than 100 organizations in north ame rica that fell victim to thi s campaign. Fi reEye investigated a number of these breaches and observed that the th reat acto r had access to relatively sophisticated tools including a previously unknown elevation of p rivilege ( EoP) exploit an d a previously unnamed point of sale (POS) memo ry scraping tool that we refer to as PUnCHTRaCK.  CVE-2016 -0167 – Microsoft Win dows Zero-Day Local P rivilege Escalation In some victim envi ronment s, the th reat acto r exploite d a previously unknown elevation of p rivilege ( EoP) vulnerability in Mic rosoft Win dows to selectively gain SYST EM privileges on a limite d number of comp romised machine s (Figure 1). Figure 1. CVE-2016-0167 Local p rivilege e scalation exploit elevate s to system We coo rdinated with Microsoft, who patche d CVE-2016 -0167 on the ap ril 12, 2016 , Patch T uesday (MS16-039). Working togethe r, we were able to ob serve limite d, targeted use of this particular exploit dating back to Ma rch 8, 2016 . The Threat acto r We attribute the use of this EoP to a financially motivate d threat acto r. In the pa st year, not only have we observed this group using similar infrastructure and tactics, techniq ues, and procedures (TTPs), but they a re also the only g roup we have ob served to date who uses the downloader PUnCHBUGGY an d POS mal ware PUnCHTRaCK. De signed to scrape both T rack 1 and Track 2 payment ca rd data, PU nCHTRaCK i s loaded and executed by a highly obf uscated launcher and is never saved to disk. This actor has conducted operations on a la rge scale and at a rapid pace, displaying a level of ope rational awareness and ability to a dapt thei r operations on the fly. The se abilitie s, combine d with targeted usage of an EoP exploit an d the reconnai ssance required to individually tailo r phishing email s to victim s, potentially speaks to the threat acto rs’ operational mat urity and sophistication. Exploitation Detail s Win32k!xxxMnDestroyHandler Use-after-Free CVE-2016 -0167 is a local elevation of p rivilege v ulnerability in the win32k Windows Graphics subsystem. an attacke r who had already achieve d remote co de execution (RC E) could exploit thi s vulnerability to elevate privileges. In the attack f rom the wild, attacke rs first achieve d RCE with malicio us macros in documents attache d to spear phishing email s. They then downloaded and ran a CV E-2016 -0167 exploit to run subsequent code as SYSTEM. CVE-2016 -0167 is patche d as of april 12, 2016 , meaning the attacke r’s EoP exploit will no longe r function on f ully updated systems. Microsoft released an additional update ( MS16-062) on May 10, 2016 , to further improve Windows against similar issues. Vulnerability Set up First, the exploit call s CreateWin dowEx() to c reate a main window. It sets the WnDCLaSS EX.lpfnWn dProc field to a function that we name Wn dProc. It installs an application- defined hook (that we name Me ssageHandler) and an event hook (that we name EventHandler) using SetWin dowsHookEx() and SetWin EventHook(), respectively. next, it c reates a timer with IDEvent 0x5678 in SetTime r(). When the timeo ut occurs, WndProc receives the WM_TIMER message and will invoke T rackPop upMenuEx() to display a shortcut menu. EventHandler will capture the EVEnT_SYST EM_MEnUPOPUPSTaRT event f rom xxxT rackPop upMenuEx()and post a message to the kernel. In handling the me ssage, the ke rnel event ually calls the vulnerable function xxxM nDestroyHandler(), which calls the usermode callback Me ssageHandler. MessageHandler then ca uses a use-after-free scenario by calling DestroyWindow() Heap Cont rol The exploit uses SetSysColors() to pe rform heap Feng Sh ui which manip ulates the layo ut of the heap  by carefully making heap allocation s. In the follo wing snippet, one of the impo rtant fiel ds is at address fffff900`c1aaac40, where fffff900`c06a0422 is a window kernel object’ s (tagWnD) base address plus 0x22: Memory Corruption The USE operation occ urs at HMassignmentUnlock()+ 0x14 as shown below: Since RDX contain s the ba se address of tagW nD plus 0x22, this instruction will add 0xffffffff to the win32k!tagWnD.state fiel d, changing it s value from 0x07004000 to 0x07003fff. 0x07004000 indicates that the bSe rverSideWindowProc flag i s unset. When the change occ urs, it sets the bSe rverSideWindowProc flag a s shown below. Code Execution If a window is marked as server-side (bServerSideWindowPro is set), the lpfnWn dProc function pointe r will be trusted by default and this can be user-mode shellcode. The follo wing backt race shows the kernel calling the exploit’ s shellcode: The shellcode then steals the System process token to elevate a chil d cmd.exe process. Mitigation FireEye products and services identify thi s activity a s Exploit.doc.MVX, Mal ware.Binary.Doc, PU nCHBUGGY, Malware.Binary.exe, an d PUnCHTRaCK within the user interfaces. The late st Windows updates address CVE-2016 -0167, and fully protect systems from exploit s targeting CV E- 2016 -0167. In addition, effective mitigation s exist to prevent social enginee ring attack s that utilize Office mac ros. Individual users can disable Office mac ros in their settings and enterprise administrators can enfo rce a Group Policy to control macro execution for all Office 2016  users. More details about Office mac ro attack s and mitigation s are available here. acknowledgement s Thank yo u to Elia Florio and the Sec ure@ staff of Mic rosoft, and Dimiter andonov, Erye Hernandez, nick Richard, and Ryann Winte rs of FireEye for their collabo ration on thi s issue.  Email Up dates Information an d insight on to day's advanced threats from FireEye. SHaRE Recent Po sts 17 Mar 2020 16 Mar 2020 09 Mar 2020 RSS FEED: STaY CO nnECTED  First name Last name Email address Company name Threat Research Blog FireEye Stories Blog Industry Perspective s Blog Yes, I would like to receive communication s from FireEye. Please read more about our information collection an d use. SUBSCR IBE Six Fact s about address Space Layout Randomization on Windows  They Come in the night: Ransomware Deployment T rends  Crescendo: Real Time Event Vie wer for macOS    Home  FireEye Blog s Threat Research  Threat acto r Leverages Windows Zero-day Exploit in...    Company Why Fi reEye? Customer Stories Careers Certification s and Compliance Investor Relation s Supplier Documents news and Events newsroom Press Releases Webina rs Events awards and Honors Email Preferences Technical S upport Incident? Report Security Issue Contact S upport Customer Portal Communities Documentation Po rtal FireEye Blog s Threat Research FireEye Stories Industry Perspective s Threat Map View the Late st Threats Contact U s +1 877-347-3393   Stay Connecte d  Copyright   2020  FireEye, Inc. all rights reserved.  Privacy & Cookie s Policy  | Privacy Shiel d | Legal Doc umentationSite Lang uage English Solutions Services Customers Partners Resources Company  "
}