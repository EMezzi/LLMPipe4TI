{
    "title": "wp-dissecting-operation-troy",
    "text": "Dissecting Operation Troy: \nCyberespionage in South Korea\n1 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nBy Ryan Sherstobitoff and Itai Liba, McAfee® Labs  \nand James Walter, Office of the CTO2 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nTable of Contents\n3 Executive Summary\n3 Attack Timeline\n4 State Sponsorship or Cyberterrorism?\n4  The adversaries\n5 The Analysis\n5 The Malware \n6  The dropper Trojan\n6  MBR wiper\n6  The remote-access Trojan\n7 Linking to the Attackers\n8 Code Analysis \n9 Revealing “Operation Troy”\n9  Persistent espionage campaign in South  \n Korea: 2009–2013\n10  Tools and tactics17 Military Espionage Malware: 2009–2013\n18  The encrypted network\n20\t \t Data \texfiltration\n21  The DLL relationship \n24  Relationships to Http Dr0pper\n24  Destroying the target\n25  The campaigns\n26 Conclusion\n26 About the Authors\n26 About McAfee Labs\n27 About McAfeeExecutive Summary\nSouth Korea was hit by a major cyberattack on March 20, 2013, at 2:00 pm local time. This \ncyberattack\tcaused\ta\tsignificant\tamount\tof\tdamage\tto\tthe\taffected\torganizations\tby\twiping\t\nthe\thard\tdrives\tof\ttens\tof\tthousands\tof\tcomputers.\nMcAfee®\tLabs\tresearch\tprovides\tfurther\tinsight\tinto\tthe\tlikely\tsource\tof\tthese\tattacks.\t\nThough\tnot\tdefinitive,\tour\tanalysis\tprovides\ta \tmuch\tclearer\tpicture.\tThe\tresearch\talso\t\nindicates\tthat\tthere\tmay\thave\tbeen\ttwo\tdistinct\tgroups,\tattacking\tdifferent\ttargets.\nOur\tanalysis\tof\tthis\tattack—known\tfirst\tas\tDark\tSeoul\tand\tnow\tas\tOperation\tTroy—has \t\nrevealed\tthat\tin\taddition\tto\tthe\tdata\tlosses\tof\tthe\tmaster\tboot\trecord\t(MBR)\twiping,\tthe \t\nincident was more than cybervandalism. The attacks on South Korean targets were actually \nthe\tconclusion\tof\ta\tcovert\tespionage\tcampaign. \tWHITE PAPER\nDissecting Operation Troy:  \nCyberespionage in South Korea\n3 Dissecting Operation Troy: Cyberespionage in South KoreaConnect With UsAttack Timeline\nOur\tanalysis\tsuggests\tthe\tfollowing\torder\tof\tthese\tattacks. \t\nLater in this report we mention other elements that color \nour\tview\tof\tthis\tevent,\tbut\tconsistent\tthroughout\tis\tour \t\nbelief\tthat\tthe\tattackers\thad\taccess\tto\tthe\tenvironments \t\nprior to launching the wiping component.\nMarch 20 attack against banks and news agencies in \nSouth Korea:\n1. The remote-access Trojan was compiled January 26, \n2013.2. The\tcomponent\tto\twipe\tthe\tmaster\tboot\trecord\t(MBR)\t\nof\tnumerous\tsystems\twas\tcompiled\tJanuary\t31.\n3. An\tinitial\tvictim\twithin\tthe\torganization\t was\tspear-phished \t\nwith\tthe\tremote-access\tTrojan.\tThis\tlikely\toccurred\tbefore \t\nMarch 20 and possibly weeks prior to the attack.\n4. The\tdropper\twas\tcompiled\tMarch\t20,\thours\tbefore\t\nthe attack occurred.\n5. The dropper was distributed to systems across the \nvictim\torganizations,\tand,\twithin\tminutes\tof\texecution,\t\nthe MBRs were wiped. This occurred around 2:00 pm \nSeoul time on March 20.4 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nState Sponsorship or Cyberterrorism?\nWho conducted these attacks is still unclear, but our \nresearch\tgives\tsome\tfurther\tinsight\tinto\tthe\tlikely\tsource.\t\nThe\tclues\tleft\tbehind\tconfirm\tthat\tthe\ttwo\tgroups\t\nclaiming\tresponsibility\twere\ta\tfabrication\tto\tthrow\t\ninvestigators\toff\tthe\ttrail\tand\tto\tmask\tthe\ttrue\tsource.\nThe adversaries\nThe two groups that appear to have been involved in the \nattacks have had no prior connection until now.\n ■NewRomanic Cyber Army Team: The samples \nconnected to this group are more convincing. The \nmajority\tof\tthe\twipers\t(found\tin\tthe\twild\tand\tretrieved\t\nfrom\tinfected\tsystems\tthrough\tother\tsources)\tcontain\t\nthe strings “principes” and “hastati,” which also appear \nin\ta\tmessage\tleft\ton\tone\tof\tthe\ttargeted\twebsites\tin\t\nthe\tform\tof\ta\tweb\tpop-up.\tThe\twiper\tcomponent\talso\t\noverwrote\tthe\tMBR\twith\tone\tof\tthese\tstrings.\tThe\t\nfollowing\tdata\t points\tsupport\tthis\tfact:\n −The strings “principes”1 and “hastati”2\twere\tfound\t\nwithin\tthe\tcode\tof\tsome\tof\tthe\twiper\tcomponents.\t\nThe\tsame\tstrings\twere\talso\tfound\tin\tthe\tweb\tpop-\nup\tmessage\tthat\twas\tleft\ton\tthe\tNocut\tNews\tKorea\t\nwebsite. The strings are ancient Roman terms \nthat\tmake\treference\tto\tmilitary\tunits,\thence\ta\t\n“cyberarmy.”\tThe\tpop-up\teven\tstates\tsome\tof\tthe\t\nspecific\tunits\tthat\twere\tpart\tof\thastati\twhich\twere\t\ninvolved in this attack.\n −The\tremote-access\tTrojan\tthat\twas\tfound\thad\ta\t\nbuild\tpath\tthat\tincluded\tthe\treference\t“Make\tTroy,”\t\na subdirectory\tof\tthe\tfolder\t“Work.”\tTroy3\trefers\tto\tan\tancient Roman region, again connecting the Roman \nreferences\tto\tthis\tgroup,\twhich\tconsistently\tuses\t\nthis theme.\n ■The Whois Hacking Team: \tOn\tMarch\t20,\tthe\twebsite\tof\t\nthe\tnetwork\tprovider\tLG\t+U\twas\tdefaced\tby\tthis\tgroup. \t\nWas it a coincidence that a second group was involved? \nAll\tof\tthe\tevidence\tindicates\t that\tthey\thad\ta\tstrong\t\ninvolvement, but there is no solid link to the group \nbecause it did not claim involvement in the attacks. \nHowever,\twe\tdo\thave\tthe\tcircumstantial\tlink\tof\ta\twiper\t\ncomponent\tthat\tin\tpractice\toperated\tdifferently\tfrom\t\nthe\twipers\temployed\tby\tthe\tNewRomanic\tCyber\tArmy\t\nyet also appears to be essentially the same wiper. The \nWhois Hacking Team MBR wiper component includes \nthe\tsame\tgraphics\t(in\ta\tresource\tfile\tin\tthe\tbinary)\tthat\t\nappeared\ton\tthe\tdefaced\tLG\t+U\twebsite,\talthough\t\nthe malware did not behave the same way. Within the \nmain\texecutable\tfile,\thowever,\twe\tdiscovered\ta\tsmall\t\nportion\tof\tthe\tcode\tthat\tmatched\tthe\tstructure\tof\tthat\t\nof\tthe\tNewRomanic\tCyber\tArmy\twipers\twe\tfound,\tso\t\nthe Whois Team likely dropped the same wiper. \nState sponsored or not, these attacks were crippling \nnonetheless. The overall tactics were not that \nsophisticated in comparison to what we have seen \nbefore.\tThe\ttrend\tseems\tto\tbe\tmoving\ttoward\tusing\tthe\t\nfollowing\ttechniques\tagainst\ttargets:\n ■Stealing and holding data hostage and announcing the \ntheft—public\tnews\tmedia\thave\treported\tonly\tthat\ttens\t\nof\tthousands\tof\tcomputers\thad\ttheir\tMBRs\twiped\tby\t\nthe malware. But there is more to this story. The main \ngroup\tbehind\tthe\tattack\tclaims\tthat\ta\tvast\tamount\tof\t5 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\npersonal\tinformation\thas\tbeen\tstolen.\tThis\ttype\tof\ttactic \t\nis consistent with Anonymous operations and others \nthat\tfall\twithin\tthe\thacktivist\tcategory,\tin\twhich\tthey\t\nannounce\tand\tleak\tportions\tof\tconfidential\tinformation.\n ■Wiping the MBR to render systems unusable, creating \nan instant slowdown to operations within the target\nThe Analysis\nWhat were the motives behind these attacks, and why \ndid the attackers chose certain targets? The attacks \nmanaged\tto\tcreate\ta\tsignificant\tdisruption\tof\tATM\t\nnetworks\twhile\tdenying\taccess\tto\tfunds.\tThis\twasn’t\tthe\t\nfirst\ttime\tthat\tthis\ttype\tof\tattack—in\twhich\tdestructive\t\nmalware\twiped\tthe\tsystems\tbelonging\tto\ta\tfinancial\t\ninstitution—has\toccurred\tin\tSouth\tKorea.\tIn\t2011,\t\nthe\tsame\tfinancial\tinstitution\twas\thit\twith\tdestructive\t\nmalware\tthat\tcaused\ta\tDenial-of-Service.\t\nThe\tattackers\tleft\ta\tcalling\tcard\ta\tday\tafter\tthe\tattacks\t\nin\tthe\tform\tof\ta\tweb\tpop-up\tmessage\tclaiming\tthat\tthe\t\nNewRomanic\tCyber\tArmy\tTeam\twas\tresponsible\tand\t\nhad\tleaked\tprivate\tinformation\tfrom\tseveral\tbanks\tand\t\nmedia companies. \nThey\talso\treferenced\tdestroying\tthe\tdata\ton\ta\tlarge\tnumber \t\nof\tmachines\t(the\tMBR\twiping)\tand\tleft\ta\tmessage\tin\tthe\tweb \t\npop-up\tidentifying\tthe\tgroup\tbehind\tthe\tattacks.\tThe\tpage \t\ntitle\tin\tInternet\tExplorer\twas\t“Hey,\tEverybody\tin\tKorea????” \t\n“Hi,\tDear\tFriends,\tWe\tare\tvery\thappy\tto\tinform\tyou\tthe\t\nfollowing\tnews.\tWe,\tNewRomanic\tCyber\tArmy\tTeam,\t\nverified\tour\t#OPFuckKorea2003.\tWe\thave\tnow\ta\tgreat\t\ndeal\tof\tpersonal\tinformation\tin\tour\thands.\tThose\tincludes; 2.49M \tmember\ttable\tdata,\tcms_info\t\nmore\tthan\t50M\tfrom\t .\tMuch\tinformation\tfrom\t\n.\tWe\tdestroyed\tmore\tthan\t0.18M\tof\tPCs.\tMany\t\nauth Hope you are lucky. 11th, 12th, 13th, 21st, 23rd and \n27th\tHASTATI\tDetachment.\tPart\tof\tPRINCIPES\tElements.\t\np.s\tFor\tmore\tinformation,\tplease\tvisit\twww.dropbox.\ncom\tlogin\twith\tjoseph.r.ulatoski@gmail.com::lqaz@\nWSX3edc$RFV. Please also visit pastebin.com.”\nThe Malware \nA\tfew\ttypes\tof\t malware\twere\tinvolved\tin\tthese\tattacks.\t\nEach\tvariant\thad\ta\tparticular\tuse.\tSome\tpublic\treports\t\nmentioned\t only\tthe\tuse\tof\tthe\twiper\tcomponent.\t However, \t\nthere\twere\tactually\tthree\tcomponents,\tall\twith\ta\tdifferent \t\npurpose, that assisted the attackers in the campaign.\nComponent Purpose File Size Compile Date\nDropper Trojan Installs the MBR \nwiper418 Kb March 20, 2013\nMBR Wiper Wipes the MBR of \nthe disk24 Kb January 31, 2013\nRemote-Access \nTrojanProvides backdoor \naccess to attackers46 Kb January 26, 2013\nTable 1. Elements of the attack on South Korean targets. \nThere\twere\ttwo\tsubsequent\taspects\tto\tthis\tattack:\n ■The\tdestruction\tof\tPCs\tusing\tthe\tMBR\twiper\t\ncomponent, which occurred March 20.\n ■Remote\taccess\tto\tthe\ttargets’\tenvironments\tfor\ta\t\nperiod\tprior\tto\tthe\tattack.\tThe\tduration\tof\tthis\taccess\t\nis unknown.6 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nThe dropper Trojan\nThe dropper Trojan was primarily used to download the \nexecutable\tthat\tdestroyed\tthe\tsystems’\tMBRs.\tWe\tsuspect \t\nthat\tthe\tdropper\tTrojan\twas\tdistributed\tat\tthe\ttime\tof\t\nthe attacks via a compromised patch-management server \nthat pretended to run a legitimate update.\nThe\tdropper\tTrojan\twas\tcompiled\tMarch\t20,\tthe\tday\tof\t\nthe\tattack,\tand\tseveral\thours\tprior\tto\tthe\tdestruction\tof\t\nthe systems. We suspect that the attackers had access \nto\tthe\ttarget\tenvironment\tprior\tto\tMarch\t20.\tIt\tis\tunlikely\t\nthat\ta\tlarge\tvolume\tof\tusers\t(some\t30,000+)\twere\tspear-\nphished on March 20 alone. \nIt’s\tlikely\ta\tmuch\tearlier\tcompromise\tled\tto\tthe\tattacks\t\nbeing staged internally. Thus, there was an initial victim \nwhose\tinfected\tsystem\tallowed\tthe\tattackers\tto\tgain\t\naccess to other systems that let them distribute the \nmalware\tbroadly.\tThe\tinitial\tinfection\tcertainly\tcould\t\nhave\tcome\tfrom\ta\tspear-phishing\tattack.\tThe\tbackdoor\t\ncomponent was compiled in late January. The attackers \ncould have been inside the networks since February. \nThis timeline is plausible given that the attackers claim \nto\thave\tstolen\ta\tvast\tamount\tof\tinformation\tfrom\tthese\t\nnetworks prior to wiping the MBRs.\nOur\tfurther\tanalysis\tled\tus\tto\tdiscover\tadditional\t\ncomponents that support our conclusion:\n ■A remote-access Trojan was discovered to have \ncompromised\tsome\tof\tthe\ttarget\tenvironments,\t\nspecifically\tan\tinternal\tserver\tused\tto\tdistribute\t\nupdates\tto\tthousands\tof\tPCs.\tThis\tTrojan\tvariant\twas\t\ncompiled on January 26 and was detected by the \nsecurity\tindustry\ton\tMarch\t25.\tMcAfee\tdetected\tthis\tthreat\tas\tRDN/Generic\tPWS.y!io.\tThis\tTrojan\twas\tbuilt\t\nwith\tthe\tMicrosoft\tVisual\tC++\tVersion\t2.9\tcompiler\twith\t\na\tfile\tsize\tof\t47KB.\nMBR wiper\nWe\thave\tseen\tseveral\twiper\tsamples\tto\tdate—all\twere\t\ncompiled\ton\tJanuary\t31.\tThe\twiper\titself\tis\trelatively\t\nsmall\t(24\tKb)\tand\tis\tintroduced\tinto\tthe\tenvironment\tvia\t\na dropper Trojan that is 418 Kb and was compiled the \nday\tof\tthe\tattacks.\nUpon executing the malware, the main dropper \n(9263e40d9823aecf9388b64de34eae54)\tcreates\tthe\t\nfile\tAgentBase.exe,\tthe\tMBR\twiper\tcomponent.\tThis\tfile\t\nis\tplaced\tin\tthe\tinfected\tuser’s\tapplication\tdata\tfolder,\t\nexecutes, and immediately starts the countdown to wipe \nthe\tsystem\tand\trender\tit\tunbootable.\tThis\tfile\twas\tcompiled \t\napproximately\ttwo\tmonths\tprior\tto\tthe\tattack’s\ttaking\tplace. \t\nThe\tmain\tdropper\tcomponent\twas\tcompiled\tthe\tday\tof\t\nthe attack, March 20, at 4:07 am Seoul time. The dropper \ninstalled the wiper, which destroyed the MBRs at around \n2:00 pm Seoul time. Once the dropper executed, \nthe systems were wiped within minutes. Thus, these \ncomponents\tlikely\tweren’t\tdistributed\tuntil\tthe\ttime\t\nwhen the attackers wished to destroy these machines. \nThe remote-access Trojan\nIt’s\tnot\twidely\tknown\tthat\tthe\tattackers\tused\ta\tremote-\naccess Trojan to compromise an internal server. The \nattackers used this internal server to distribute the wiper \ncomponent\tto\tthe\tthousands\tof\tPCs.\tThe\tremote-access \t\nTrojan\thad\ta\tfile\tsize\tof\t46\tKb\tand\twas\tcompiled\ton\t\nJanuary\t26,\tfive\tdays\tbefore\tthe\tMBR\twiper\twas\tcompiled.7 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nAs we concluded earlier, we have determined that \nthe attackers had access to the environment prior to \nwiping the systems. The remote-access Trojan was \nlikely delivered to an internal PC via a spear-phishing \ncampaign. From this system, the attackers accessed \nother internal resources. The Trojan was designed to \noperate\twithin\tInternet\tExplorer—it\tlaunched\ta\thidden\t\ninstance\tof\tInternet\tExplorer\tand\tinjected\titself\tinto\tthe\t\nrunning process.\nFigure 1. The process monitor shows the remote-access Trojan \nspawning an instance of Internet Explorer.\nThe\tTrojan\timmediately\tmodified\tthe\tproperties\tin\tthe\t\nregistry\tto\tallow\tfor\tremote\tconnections\tto\tthe\tsystem.Linking to the Attackers\nLinking\tmalware\tto\tits\tdevelopers\tisn’t\talways\tan\teasy\t\ntask.\tMost\tattackers\tare\tcareful\tenough\tto\tensure\tthey\t\ncan’t\tbe\ttraced.\tThis\tis\tespecially\timportant\tin\tcases\t\nsuch as cyberespionage, in which the intent is to remain \ninvisible. \nIn\tour\tanalysis\twe\tobserved\ta\tnumber\tof\tunique\t\nattributes in the components involved in these attacks. \nThese\tmarkers\tallowed\tus\tto\tlink\tspecific\tsamples\tto\ta\t\nspecific\tgroup.\nTwo\tgroups\thave\ttaken\tcredit\tfor\tthese\tattacks,\tbut\twe\t\ncan tell that the variants that wiped the systems link to \nthe\tNewRomanic\tCyber\tArmy\tTeam.\nAlthough the Whois Hacking Team is more public due \nto\tits\tdefacement\tof\tthe\tnetwork\tprovider\tLG\t+U’s\t\nwebsite,\twe\tcan\tlink\tthis\tgroup\tto\tonly\tone\tsample\tof\ta\t\nwiper,\twhich\toperates\tdifferently\tthan\tthe\tothers.\tThe\t\nWhois\twiper\tis\tmuch\tlarger,\twith\ta\tfile\tsize\tof\t236\tKb\t\nand was compiled March 19, whereas the other wiper \ncomponents\tare\ta\tmere\t24\tKb.\tThe\tlarger\tsize\tsuggests\t\nthe\tWhois\twiper\tcontains\tmore\tfunctions.\tThus,\twe\t\ncan\tdefinitively\tlink\tNewRomanic\tto\tthe\tsamples\tused\t\nto\twipe\tthe\tMBRs\tof\tsystems\twithin\tthe\tSouth\tKorean\t\nfinancial\tinstitution\tnetworks.\tNewRomanic\twill\tremain\t\nthe prime suspect involved in the attacks.\nConfirming\tthe\tlink\tbetween\tNewRomanic\tand\tknown\t\nwiper\tsamples,\twe\tfound\ta\tnumber\tof\twiper\tsamples\t\ncontained either the string “hastati” or “principes” in the \ncalling\tcards\tleft\tby\tthe\tattacker.8 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nSample MD5 Compilation \nDateDetection \nName\ndb4bbdc36a78a8807ad9b15a  \n562515c4January 31, 2013 KillMBR-FBIA\n5fcd6e1dace6b0599429d9138  \n50f0364January 31, 2013 KillMBR-FBIA\nf0e045210e3258dad91d7b6b  \n4d64e7f3January 31, 2013 KillMBR-FBIA\nTable 2. Wiper samples connected to the NewRomanic Cyber Army \nTeam.\nNot\tonly\tdid\tmost\tof\tthe\twiper\tsamples\tlink\tto\t\nNewRomanic,\tbut\tthe\tremote-access\tTrojan\tcan\talso\t\nbe linked to the group. The Trojan contained a build \npath that mentions Troy in the directory path, again \nconsistent\twith\tthe\tancient\tRoman\treferences\tused\tby\t\nthis group.\nFigure 2. The remote-access Trojan names Troy. This reference links the \nattack to the NewRomanic Cyber Army Team.\nCode Analysis \nIt\tis\thighly\tunusual\tthat\ttwo\tgroups\tclaim\tresponsibility\t\nfor\tthese\tattacks.\tNo\tfurther\tinformation\thas\tbeen\t\nrevealed as to who they are or what their motivations \nare; this is another reason to suspect that these two \ngroups\tare\tthe\tsame\tand\tare\tactually\tfabricated.\tThe\t\nsupporting\tevidence\tcomes\tin\tthe\tform\tof\tcode\tanalysis\t\ndetermining\tthe\tdegree\tof\tsimilarity\tbetween\tthe\t\nsamples.The Whois Hacking Team sample was compiled on March \n19\tat\t1:57\tpm\tlocal\ttime\tand\tthe\tNewRomanic \tdropper\twas\t\ncompiled on March 20 at 4:07 am local time. The attacks on \nSouth\tKorean\tbanks\tand\tmedia\tand\tthe\tdefacement\tof\tLG \t\n+U occurred approximately 2:00 pm local time on March 20.\nMcAfee\tLabs\tinvestigated\tthe\tdifferences\tbetween\t\nthe\ttwo\tsamples\tat\ta\tcode\tlevel\tto\tdetermine\tif\tthere\t\nwere\tany\tsimilarities.\tIn\tspite\tof\tthe\tfact\tthat\tthe\twiper\t\ncomponent\toriginating\tfrom\t NewRomanic\tCyber\tArmy\t\nTeam\twas\t24\tKb\tin\tsize\tand\tthe\tcomponent\tfrom\tWhois\t\nwas\t236KB,\twe\tdid\tfind\tsimilarities\twithin\tthe\tcode.\t\nThe\tWhois\tsample\tis\ta\tdropper\tfor\ta\tcomponent\tthat\t\nclosely\tresembles\tthe\tone\tused\tby\tthe\tNewRomanic\t\nCyber\tArmy.\tWe\tfound\ta\tsignificant\tnumber\tof\tmatching\t\nsubroutines\tand\ta\tlarge\tnumber\tof\tcode\tsegments\twith\t\nonly\tminor\tdifferences.\tThese\tsimilarities\tlead\tus\tto\t\nconclude that the payload code is based upon the same \ninitial\tcode\tand\twas\tembedded\tinto\tdifferent\tdroppers.\nWhois Sample NewRomanic \nSample# of Different \nFunctions\n_alloca_probe _alloca_probe exact match\nsub_4078C0 loc_40291F 15\nsub_4030A0 loc_302f40 17\nloc_404f54 loc_403169 1\nloc_4033a1 loc_4084ee exact match\nloc_4065f4 loc_403694 exact match\nstart sub_401870 131\nsub_402D02 sub_407BC9 0\nsub_407c7a sub_402DB3 10\nsub_4083F5 sub_40327D 4\nsub_403770 sub_409980 exact match\nTable 3. Partial analysis of subroutine differences.9 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nRevealing “Operation Troy”\nPersistent espionage campaign in South Korea: \n2009–2013\nPublic reports covering what is known as the Dark \nSeoul incident, which occurred on March 20, 2013, \naddressed\tonly\tthe\tMBR\twiper\tcomponents.\tMany\tof\t\nthe\tdetails\tof\tthis\tincident\thave\tbeen\texamined,\tand\t\nmost analysts conclude this was an isolated, though \nclearly\tcoordinated,\tattack.\tHowever,\tMcAfee\tLabs\thas\t\nfound\tthat\tthere\twas\tmore\tto\tthe\tincident\tthan\twhat\t\nwas widely reported. Our analysis has revealed a covert \nespionage campaign. \nTypically,\tthis\tsort\tof\tadvanced\tpersistent\tthreat\t(APT)\t\ncampaign\thas\t targeted\ta\tnumber\tof\tsectors\tin\tvarious\t\ncountries, but Operation Troy, as these attacks are now \ncalled, targets solely South Korea. \nFrom\tour\tanalysis\tof\tunique\tattributes\twithin\tthe\t\nmalware samples, we have determined that the initial \ncode\tbehind\tthe\t“Troy”\tfamily\tof\tTrojans\twas\tcreated\t\nin 2010, as was another component that was dropped \nby the Trojan HTTP Troy. The malware used in these \nattacks\twere\tcompiled\tto\tspecifically\ttarget\tSouth\tKorea\t\nand used Korean-language resources in the binaries. \nThe malware connected to legitimate Korean domains \nthat\twere\trunning\ta\tbulletin\tboard\tand\tsent\ta\tspecific\t\ncommand\tto\ta\tPHP\tpage\tto\testablish\tan\tIRC\tchannel\tand\t\nreceive commands.2009\nUS/South \nKorean \nMilitary \nAttacks\nDDoS \nAttacks10 Days of Rain Media/Broadcast \nAttacks\nFinancial Industry \nAttacksChang\nEagleXP\nNSTARHTTP Troy\nMail AttackHttp Dr0pper\nTongConcealment \nTroy\nMBR Wiper\n3Rat Client\nTDrop\nSuspected Link\nSolid Link\nHighly Probable LinkOperation Troy—Domestic Spying PeriodEspionage Campaign\nDark Seoul\n2011 2012 2013March 20,\n20132010\nFigure 3. The targeted attack Dark Seoul reached its culmination in \nMarch 2013, but its roots go back at least to 2009, when the Trojan’s \nsource code was first compiled. Subsequent variations of the malware \nhave also been involved in these threats. \nMcAfee\tLabs\thas\tdetermined\tthat\tdomestic\tespionage\t\nactivities\toccurred\tbefore\tthe\tMarch\t20\tattacks,\tmost\t\nlikely to gain intelligence regarding the targets to carry \nout\tfurther\tattacks\t(such\tas\tthe\tMarch\t20\tincident)\tor\t\nto\tbenefit\tthe\tattackers\tin\tsome\tother\tways.\tThis\tspying\t\noperation had remained hidden and only now has been \ndiscovered through diligent research and collaboration. \nWe\talso\tsuspect\tthe\tattackers\thad\tknowledge\tof\tthe\t\nsecurity\tsoftware\trunning\twithin\tthe\tenvironment\tbefore\t\nthey\twiped\tthe\tsystems,\tgiven\tthat\tsome\tof\tthe\tvariants\t\nused\tin\tthe\tattack\twere\tmade\tto\tlook\tas\tif\tthey\twere\t\nanti-malware\tupdate\tfiles\tfrom\tbefore\tMarch\t20.\t\nThe attackers who conducted the operation remained \nhidden\tfor\ta\tnumber\tof\tyears\tprior\tto\tthe\tMarch\t\n20\tincident\tby\tusing\ta\tvariety\tof\tcustom\ttools.\tOur\t10 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\ninvestigation\tinto\tDark\tSeoul\thas\tfound\ta\tlong-term\t\ndomestic spying operation underway since at least \n2009. The operation, all based on the same code, has \nattempted\tto\tinfiltrate\tspecific\tSouth\tKorean\ttargets.\tWe\t\ncall\tthis\tOperation\tTroy,\tbased\ton\tthe\tfrequent\tuse\tof\t\nthe word Troy in the compile path strings in the malware. \nThe\tprime\tsuspect\tgroup\tin\tthese\tattacks\tis\tthe\tNew\t\nRomanic\tCyber\tArmy\tTeam,\twhich\tmakes\tfrequent\tuse\tof \t\nRoman\tand\tclassical\tterms\tin\ttheir\tcode.\tWhile\tanalyzing\t\nmalware\tcomponents\tfrom\tbefore\tthe\tMarch\t20\t\nincident,\twe\tfound\tboth\tsimilar\tand\tidentical\tattributes\t\nof\tthe\tfiles\tinvolved\tthat\tenable\tus\tto\tlink\tthem\tto\tthe\t\n3Rat remote administration tool client used on March \n20, as well as to samples dating to 2010. Furthermore, \nwe\tdetermined\tthat,\tthrough\tprior\taccess\tto\tthe\tvictims’\t\nnetworks, the attackers were able to upload the MBR \nwiper\tcomponent\tand\tdistribute\tit.\tIt\tis\talso\tpossible\tthat\t\nthe\tcampaign\tknown\tas\t10\tDays\tof\tRain\tis\ta\tbyproduct\tof\t\nOperation\tTroy.\tSome\tof\tour\tanalysis\tsuggests\tthat\tthe\t\nmalware Concealment Troy was present in these attacks.\nTools and tactics\nNSTAR: 2010–2011 \nNSTAR\tappears\tto\tbe\tthe\tfirst\tproduction\tversion\tof\tthe\t\nTroy\tfamily.\tThis\tTrojan\tis\tbased\tupon\tmalware\tcreated\t\nfor\ta\tmilitary\tespionage\tcampaign\tthat\tfirst\temerged\tin\t\n2009.\tNSTAR\tis\tthe\tfirst\tto\tuse\tcomponents\tin\tthe\tsame\t\nway\tthat\tlater\tvariants\tof\tthe\tTroy\tfamily\tdo.\tIt\tincluded\t\na\tshared\tDLL\t(bs.dll)\tthat\twas\tfound\tin\tthe\t2010\tand\t\n2011\tvariants.\tLater\tvariants\tuse\ta\tmodified\tversion,\t\nHTTPSecurityProvider.dll, which employs nearly the \nsame\tfile-mapping\tfunction\tas\tused\tby\tbs.dll.\tMost\tof\t\nthese\tvariants\tare\tcompiled\tfrom\tthe\tWork\tdirectory.\tThat’s\tfairly\tconsistent\tthroughout\tall\tversions.\tThe\t\nDLL\twas\tcompiled\tusing\tMicrosoft\tVisual\tC++\tVersion\t6.\t\nThose\titerations\twere\tfound\tin\t2010-2011.\t\nThe\tcall\tgraph\tgenerated\tfor\tNSTAR’s\tbs.dll\tis\tidentical\t\nwith\tthat\tof\tHTTP\tTroy.\tThey\twere\tcompiled\tat\tleast\ta\t\nyear\tapart\tfrom\teach\tother.\nFigure 4. Call graph for bs.dll from the NSTAR variant of the Troy Trojan.\nFigure 5. Call graph for bs.dll from the HTTP Troy variant.11 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nThe DLL was compiled March 3, 2011, and includes an OCX \ncomponent that was compiled in late 2010. The OCX used \na\tvery\tdifferent\tcompile\tpath,\tbut\tbs.dll,\tthe\tbackdoor,\tis\t\nessentially the same as those seen in later versions. \nThe Work directory, with path shown below, is also used \nwith Troy variants Concealment Troy and 3Rat Client, \nwhich were both compiled in 2013.\nE:\\Work\\BackUp\\2011\\nstar_1103\\BackDoor\\BsDll-\nup\\Release\\BsDll.pdb\nWe\talso\tfound\ta\tfile-mapping\tfunction\tin\tthis\tvariant\t\nsimilar\tto\tthose\tin\tmost\tof\tthe\tnewer\tversions.\tThe\t\nunique\tstring\tbeginning\twith\t“FFFFFFF”\tis\tidentical\tand\t\noccurs throughout the later variants.\nFigure 6. NSTAR’s file-mapping function.\nThe\tmalware\testablishes\tan\tinternet\trelay\tchat\t(IRC)\t\nchannel to receive real-time commands in the same \nmanner as the military espionage malware. \nFigure 7. NSTAR communicates with its control server via HTTP as its \nprimary channel.Chang and EagleXP: 2010\nAnother\tvariant\tfrom\t2010,\tEagleXP,\tis\tclosely\trelated\tto\t\nNSTAR\tand\tHTTP\tTroy\tbased\ton\treused\tcomponents.\t\nEagleXP\tused\tthis\tcompile\tpath:\t\nD:\\VMware\\eaglexp(Backup)\\eaglexp\\vmshare\\\nWork\\BsDll-up\\Release\\BsDll.pdb\nAgain we see the Work directory involved as in the other \npost-2010 malware used in this campaign. A variant \ncompiled on May 27, 2010, also contained a very similar \ncompile\tpath.\tWe\twere\table\tto\tobtain\tsome\ttraffic\tfrom\t\nthe control server.\nD:\\\\Chang\\\\vmshare\\\\Work\\\\BsDll-up\\\\Release\\\\\nBsDll.pdb \nThe May 27 variant, called Chang, operated in the same \nmanner as other Troy variants and used the same bs.dll. \nA\tKorean\tmanufacturing\t website\thosted\tboth\tthe\tcontrol\t\nserver\tand\tan\tIRC\tserver.\nFigure 8. Outbound traffic from an infected system.\nFigure 9. The malware establishes a channel with the control server via IRC.12 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nBoth\tthe\tChang\tand\tEagleXP\tvariants\tare\tbased\ton\tthe\t\nsame\tcode\tthat\tcreated\tNSTAR\tand\tlater\tTroy\tvariants.\t\nThese\tsimilarities\tconfirm\tthe\tattackers\thave\toperated\t\nfor\tmore\tthan\tthree\tyears\tagainst\tSouth\tKorean\ttargets.\nInside the IRC botnet\nConcealment \nTroyTong\nTDropDochang.pe.kr\nMupa.co.krNowq.net\nNSTARHTTP\n Troy\nHttp\nDr0pper\nByonshop.comDong.a.jpTroy Botnet\nToneharbor.comSujewha.com\nQitaegyo.com\nDelmundo.kr\nTheumin.net\nGcglobal.com\nApsumo.co.krHanja.edu.comTraveler.foxlink.com\nSolarshare.co.krLawbookcenter.co.krBabcom-h1.bluethunder.co\nFigure 10. The malware family and its control servers.\nDuring\tour\tinvestigation\twe\tdug\tinto\tthe\tattackers’\t\ncontrolling botnet, which was used until 2013. The \ninfrastructure\trelied\tupon\ton\ta\tnetwork\tof\thacked\t\nSouth\tKorean\twebsites\thosting\tIRC\tservers.\tThe\tinfected\t\nclients,\tin\tturn,\tcommunicated\twith\tthe\tIRC\tservers\tusing\t\nRSA\tencryption\tand\tused\tfunctions\timported\tfrom\tthe\t\nMicrosoft\tCryptography\tAPI\tlibrary.\t\nFigure 11. Some functions imported from the Microsoft Cryptography \nAPI.\nThe attackers hardcoded the control domains in bs.dll \nand\tdistributed\tit\tin\tthe\tfinal\tcompiled\tTrojan\tcode.\tEach\t\nvariant\tof\teach\tgeneration\tof \tTrojans\tcontained\tdifferent\t\nhardcoded strings pertaining to the control servers. This \nshows\tthat\tthe\tattackers\tfirst\tcompromised\tthe\tfuture\t\nIRC\tserver\tsites\tand\tthen\tcompiled\tthe\tcomponent\tand\t\ndistributed\tit\tto\tinfected\ttargets.\t\nFigure 12. Hardcoded addresses in bs.dll.13 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nThe\tnickname\tfor\tthe\tbot\tcan\tbe\tdetermined\tby\tthe\t\noutbound\ttraffic\tand\tinformation\twritten\tto\tthe\tWindows\t\nregistry. One variant operating in June 2010 used \nthe nickname BS^000C2918AB11 with the password \nwodehaopeng.\tThe\tmalware\tjoined\tthe\tIRC\tchannel\t\n#god\tand\tsent\tseveral\tprivate\tmessages\tto\twhat\twas\t\nlikely the control server to receive instructions. \nPRIVMSG X^111112352643[1] :\nA5TbaKuqCO641tirNl51rFLdNHeUhMbUiJ93sO5rip9X  \n7AZG0Y8rlZVmItEEfDrmNL19OpJrv2khO5WbflTqxs7FV  \ngzUNfdvtnjbObWeNN VPlFyXPQIEDj/4YnidGDAqp7  \nm8lFpnC2Pyz2+6OOooEUMqG6rKImyFQLM/V7K69E=\nVariant Bot IRC Nickname\nHttp Dr0pper YN^000E0C3CB868\nHTTP Troy B9^E02E29C4\nTDrop TE02E29C\nNSTAR H^E02E29C4\nTong CO^000E0C2892FA\nEagleXP B3^000C2918AB11\nChang X^000C295C5DEC\nTable 4. IRC bot nicknames used by variants.\nHTTP Troy: 2011\nIn\t2011\tthe\tattackers\tcreated\tthe\tTrojan\tHTTP\tTroy,\t\nnamed\tfrom\tits\tcompile\tpath\tstring.\tThis\twas\tthe\tfirst\tof\t\nthe\tTroy\tfamily\tof\tTrojans.\tTo\tdate,\twe\thave\tfound\tonly\t\none\tsample\tof \tHTTP\tTroy.\tUpon\texecution,\tthe\tmalware\t\nlaunches\ta\tcrippled\tGUI\tthat\tallows\tthe\tvictim\tto\tinstall\t\na screen saver displaying politically sensitive images. \nWe\tdon’t\tknow\twhy\tthe\tdevelopers\ttook\tthe\trisk\tof\tmaking the Trojan visible. The screensaver component \n(chonanship.scr)\tis\tnot\tmalicious\tand\twas\tcompiled\ton\t\nDecember\t12,\t2010.\tIt\tcontained\timages\trelated\tto\tthe\t\nsinking\tof\tthe\tSouth\tKorean\tNavy\tship\tCheonan.4 HTTP \nTroy was compiled on March 20, 2011 and contained \nthe compile path Z:\\source\\1\\HttpTroy\\BsDll-up\\\nRelease\\BsDll.pdb . As we can see, HTTP Troy uses the \nsame\tDLL\tas\tthe\tNSTAR,\tChang,\tand\tEagleXP\tvariants\t\ndid in 2010. This path was contained in a dropped DLL \ncomponent\tthat\twas\tused\tto\testablish\ta\thidden\tIRC\t\nchannel\tto\tthe\tattackers’\tcontrol\tserver.\tThe\tprimary\t\ndropper\tfile\tfor\tthis\tremote-access\tTrojan\twas\tdisguised\t\nas\tAhnLab’s\tSmart\tUpdate\tUtility\tsetup\tprogram.\tThe\t\noriginal\tfilename\twas\tSUpdate.exe.\t\nAfter\texecuting,\tthe\tremote-access\tTrojan\tmakes\ta\t\nconnection\tto\tsujewha.com,\tthe\tIRC\tcontrol\tserver.\t\nFigure 13. HTTP Troy communicates with its control server via IRC.\nHttp Dr0pper: 2012\nWe\tfound\ta\tsecond-generation\tTrojan\tbased\ton\tHTTP \t\nTroy that included the compile path Z:\\1Mission\\Team_\nProject\\[2012.6~]\\HTTP Troy\\HttpDr0pper\\Win32\\\nRelease . This Trojan, Http Dr0pper, was compiled in \n2012\tfrom\tthe\tHTTP\tTroy\tdirectory,\tindicating\tthat\tit\tis\tan \t\nadvancement\tof\tthe\toriginal\tHTTP\tTroy. \t14 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nAll\tof\tthe\tvariants\tfrom\tthis\tpoint\treuse\ta\tspecific\tDLL,\t\nwhich in some instances is named HTTPSecurityProvider.\ndll\tand\tuses\tthe\tMicrosoft\tCryptography\tAPI\tto\tsecure\t\ncommunications.\tWe\tcan\ttrack\tthe\treuse\tof\tthis\tDLL\t\nbased\ton\tthe\tconsistent\tfile -mapping\tfunction\tthat\t\nappears throughout the variants.\nFigure 14. The malware Http Dr0pper using the same file-mapping \nfunction and DLL as other versions.\nWe\tcan\tdetermine\tthat\tanother\tvariant,\tTong\t(based\ton\t\nthe\tdirectory\tin\twhich\tit\twas\t compiled),\talso\treuses\tthis\t\nDLL\tand\tcontains\tthe\tsame\tfunction.\nFigure 15. The malware Tong using the same file-mapping function and \nDLL as other versions.\nFurthermore, variants such as Concealment Troy that \nwere\tcompiled\tin\t2013\tcontain\tthe\tsame\tfunction\tonce\t\ndecoded.\tStill,\tsome\tof\tthe\tbase\tcode\tis\treused\tin\tthe\t\nsupporting\tDLL\tfor\tConcealment\tTroy.\nFigure 16. The malware Concealment Troy using the same function \n(encoded function shown).\nAfter\texecution,\tthe\tTrojan\tmakes\ta\tconnection\tto\tthe\t\ncontrol\tserver\tusing\tspecific\tparameters\tthat\tinclude\tthe\t\nIRC\tnickname.\tThis\tcommunication\tpattern\tis\tconsistent\t\nwith\tother\tvariants\tthat\treference\tTroy.\nFigure 17. Communicating with the control server.\nTong: 2012\nThe Tong variant contains the compile path E:\\Tong\\\nWork\\Op\\1Mission\\Team_Project\\[2012.6~]\\HTTP \nTrojan 2.0\\HttpDr0pper\\Win32\\Release .\tIt\talso\t\ncommunicated using the same methods. This Trojan was \ncompiled on August 28, 2012.\nFigure 18. Tong communicating with its control server.\nCompile Date Compile Path\nJuly 4, 2012 Z:\\1Mission\\Team_Project\\[2012.6~]\\HTTP Troy\\\nHttpDr0pper\\Win32\\Release\\3HttpDropper.pdb\nJuly 7, 2012 Z:\\1Mission\\Team_Project\\[2012.6~]\\\nHTTP Troy\\HttpDr0pper\\Win32\\Release\\\nHttpSecurityProvider.pdb\nAugust 28, 2012 Z:\\1Mission\\Team_Project\\[2012.6~]\\\nHTTP Troy\\HttpDr0pper\\Win32\\Release\\\nHttpSecurityProvider.pdb\nAugust 29, 2012 Z:\\1Mission\\Team_Project\\[2012.6~]\\HTTP Troy\\\nHttpDr0pper\\Release\\HttpSecurityProvider.pdb\nTable 5. Components dropped by Tong.15 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nTDrop: 2013\nTDrop\tis\tthe\tthird\tgeneration\tof\tHTTP\tTroy.\tTDrop\tuses\t\none\tof\ttwo\tDLL\tfiles,\tpayload32.dll\tand\tpayload64.\ndll, and injects one, depending on operating system, \ninto svchost.exe. Previous versions used bs.dll, which \ncontained\tthe\tcode\tfor\tcommunicating\twith\tthe\tIRC\t\nbotnet.\tTDrop\thas\tsome\tfurther\tfunctionality\tnot\t\npresent\tin\tHTTP\tTroy\tthat\textends\tthis\tTrojan’s\tability\tto\t\noperate on 64-bit machines and to evade automated \nanalysis systems and emulation technologies. \nThe\tevasion\troutines\tcheck\tfor\tthe\tpresence\tof\t\ndebuggers and tracers that attach to the parent \nprocess.\tThis\teffectively\tcauses\tthe\tparent\tprocess\t\nto immediately terminate when under analysis by \nemulation or sandboxing systems that attempt to hook \nand\tmonitor\tAPI\tcalls\tcoming\tfrom\tthat\tprocess.\nFigure 19. The antidebugging feature in payload32.dll.Furthermore, TDrop uses a DLL to run under \nnonprivileged accounts on Windows 7. This variant \nwas compiled on January 15, 2013, and contained the \ncompile path D:\\Work\\Op\\Mission\\TeamProject\\\n[2012.11~12]\\TDrop\\Dropper32\\Release\\Dropper.\npdb. The main executable, which extracts the other \ncomponents,\twas\tcompiled\tfrom\tthe\tpath\tZ:\\Work\\\nv3zip\\misc.c  and Z:\\Work\\v3unzip.c . This is likely a \ncompression\ttool\tto\textract\tthe\tfiles\tto\tthe\tdesktop.\nJust as Http Dr0pper, TDrop uses the disguised dropper \ncomponent\tAhnlabUpdate.exe.\tThe\tunique\tcode\tis\t\nnearly identical to that used in Http Dr0pper with the \nexception\tof\tthe\tlast\ttwo\tcharacters.\nFigure 20. TDrop reusing code from Http Dr0pper.\nWhen\tthe\tmain\tTrojan\tfile\texecutes,\tit\tlaunches\tRunCmd.\nexe,\twhich\titself\tdoesn’t\tappear\tto\tbe\tmalicious.\t\nRunCmd.exe then launches AhnlabUpdate.exe based \non\tthe\tspecified\tfilename\tin\tthe\tassociated\tRunCmd.ini\t\nfile.\tThese\tfiles\tare\tcreated\tin\tthe\tdirectory\t114719_507_\nAhnlabUpdateKit, which sits in a temp directory \ncreated\ton\tthe\tdesktop.\tIt\tis\t obvious\tthat\tthe\tattackers\t\nwere\taware\tof\tthe\tsecurity\tproduct\tthat\tthe\ttarget\t\nenvironment used and attempted to make the malware \nappear as legitimate as possible. AhnlabUpdate drops \nand runs an additional executable, which is the RAT \npayload that establishes a connection with the control \nserver.16 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nMain.EXE\nRunCmd.exe\n~ERC6C8.tmpAhnlabUpdate.exe\nFigure 21. TDrop disguises its presence by appearing to be a security \nproduct.\nConcealment Troy: 2013\nAnother\t third-generation\t Troy\tfamily\tTrojan\tis\tConcealment \t\nTroy.\tThis\tversion\twas\tcompiled\tfrom\tthe\tsame\tdirectory\t\nas\tthe\t3Rat\tclient\tfound\tin\tthe\tvictims’\tenvironments\ton\t\nMarch\t20.\tSome\tcomponents\tfrom\tConcealment\tTroy\t\nsuggest that the source code was originally written in \n2010\tand\twas\tlater\tcompiled\tfor\tuse\tin\tthis\tcampaign.\t\nThe 64-bit component to install the backdoor on the \nvictims’\tsystems\tcontains\tan\tinteresting\tcompile\tpath\t\nand\twas\tfirst\tcreated\ton\tNovember\t28,\t2012.\nC:\\test\\BD_Installer_2010\\x64\\Release\\BD_\nInstaller_2010.pdb\nThe 32-bit version was compiled January 23, 2013, and \ncontained this compile path:Z:\\\\Work\\\\Make Troy\\\\Concealment Troy\\\\\nExe_Concealment_Troy(Winlogon_Shell)\\\\\nSetKey_WinlogOn_Shell_Modify\\\\BD_Installer\\\\\nRelease\\\\BD_Installer.pdb \nComponent Compile Path Compile Date  \n(all 2013)\nBDInstaller1 Z:\\\\Work\\\\Make Troy\\\\\nConcealment Troy\\\\Exe_\nConcealment_Troy(Winlogon_\nShell)\\\\SetKey_WinlogOn_Shell_\nModify\\\\BD_Installer\\\\Release\\\\\nBD_Installer.pdbJanuary 23\nBackdoorEXE Z:\\\\Work\\\\Make Troy\\\\\nConcealment Troy\\\\Exe_\nConcealment_Troy(Winlogon_\nShell)\\\\Concealment_Troy(exe)\\\\\nRelease\\\\Concealment_Troy.pdbFebruary 4\nBackdoorDLL Z:\\\\Work\\\\Make Troy\\\\\nConcealment Troy\\\\Exe_ \nConcealment_Troy(Winlogon_\nShell)\\\\Dll\\\\Concealment_Troy(Dll) \n\\\\Release\\\\Concealment_Troy.pdbFebruary 22\nBDInstaller2 Z:\\\\Work\\\\Make Troy\\\\\nConcealment Troy\\\\Exe_\nConcealment_Troy(Winlogon_\nShell)\\\\SetKey_WinlogOn_Shell_\nModify\\\\BD_Installer\\\\Release\\\\\nBD_Installer.pdbFebruary 22\nMainDropper2 None February 22\nMainDropper3 None February 23\nTable 6. Compilation timeline for Concealment Troy.\nConcealment\tTroy\tdoes\tnot\temploy\treal-time\tIRC\tcontrol\t\nas\tearlier\tversions\tdid.\t(Concealment\tTroy\tis\ta\ttypical\t\nHTTP\tbotnet.)\nFigure 22. Concealment Troy abandons the use of IRC for real-time \ncontrol and uses HTTP as its primary channel.17 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nMilitary Espionage Malware: 2009–2013\nMcAfee\tLabs\thas\tuncovered\ta\tsophisticated\tmilitary\t\nspying network targeting South Korea that has been in \noperation since 2009. Our analysis shows this network \nis connected to the Dark Seoul incident. Furthermore, \nwe have also determined that a single group has been \nbehind\ta\tseries\tof\tthreats\ttargeting\tSouth\tKorea\tsince\t\nOctober\t2009.\tIn\tthis\tcase,\tthe\tadversary\thad\tdesigned\t\na sophisticated encrypted network designed to gather \nintelligence\ton\tmilitary\tnetworks.\tWe\thave\tconfirmed\t\ncases\tof\tTrojans\toperating\tthrough\tthese\tnetworks\tin\t\n2009, 2010, 2011, and 2013. This network was designed \nto\tcamouflage\tall\tcommunications\tbetween\tthe\tinfected\t\nsystems\tand\tthe\tcontrol\tservers\tvia\tthe\tMicrosoft\t\nCryptography\tAPI\tusing\tRSA\t128-bit\tencryption.\t\nEverything\textracted\tfrom\tthese\tmilitary\tnetworks\t\nwould be transmitted over this encrypted network once \nthe\tmalware\tidentified\tinteresting\tinformation.\tWhat\t\nmakes\tthis\tcase\tparticularly\tinteresting\tis\tthe\tuse\tof\t\nautomated\treconnaissance\ttools\tto\tidentify\twhat\tspecific\t\nmilitary\tinformation\tinternal\tsystems\tcontained\tbefore\t\nthe\tattackers\ttried\tto\tgrab\tany\tof\tthe\tfiles.\nThe\tattacks\twould\thave\toccurred\tin\tfour\tgeneral\tstages:\n ■Initial\tcompromise\tvia\ta\t“watering-hole\tattack,”\twhich\t\nwould\tlead\tto\tthe\texploitation\tof\tthe\tinternal\tsystems\t\n(in\tthe\t2009\tcase).\t(The\tattacker\tplaced\ta\tzero-day\t\nexploit\ton\ta\tmilitary\tsocial\tnetworking\tsite.)\tLater\tcases\t\nwere\tlikely\tspear\tphishing\tto\tmore\tquickly\tget\tto\tthe\t\nright targets.\nOctober 21, 2009 \nMilitary AttacksAugust 21, 2010 \nMilitary Attacks\ntake.chu.jp seung.us sarangbang.us christkingchurch.us\nFebruary 28, 2011 \nMilitary AttacksJanuary 13, 2013 \nMilitary Attacks\ndjuna.cine21.com strider.pe.kr dochang.pe.kr kairoshairstory.com.au ejiweb.com dennisoneil.net daeilho.net\nFigure 23. Encrypted data exfiltration network.\n ■Malware\tautomatically\tperforms\treconnaissance\ton\t\ntarget\tsystems\tlooking\tfor\tdocuments\tof\tinterest.\t\nMalware can also scrape out passwords and registry \ninformation\talong\twith\tdirectory\tlisting\tof\tinteresting\t\nfiles.\n ■The\tattacker\tcan\trequest\tdirectory\tcontents\tfrom\t\ninfected\tsystems\tbased\ton\tthe\tnumber\tof\tinteresting\t\nfiles\tfound.\tThey\tcan\tselectively\tgrab\tspecific\tfiles\tas\t\nneeded.\n ■Stolen\tfiles\tare\ttransmitted\tvia\tHTTP-encrypted\t\nchannel\tto\tthe\tattacker’s\tserver.18 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nThe encrypted network\nThe\tattacker’s\tencrypted\tnetwork\tuses\tMicrosoft’s\t\nCryptography\tAPI\tlibrary\tVersion\t1.0\tto\tencrypt\t\ncommunication channels to the control servers over \nboth\tHTTP\tand\tIRC.\tThe\tencryption\tuses\ta\t128-bit\tRSA\t\nkey,\tshown\tas\t imported\tand\tused\tby\tthe\tfollowing\tcode.\nFigure 24. Function to call the Microsoft Cryptography API library.\nFigure 25. RSA encryption key used to camouflage communications.This\tnetwork\toperates\tover\tboth\tHTTP\tand\tuses\tIRC\t\nas\tsecondary\tchannel\tfor\treal-time\toperations.\tThe\tIRC\t\nnetwork is based on the open-source library libircclient5, \nand\teverything\tsent\tover\tthis\tIRC\tchannel\tis\tencrypted\t\nvia\tthe\tMicrosoft\tCryptography\tAPI.\nFigure 26. Establishing an IRC channel session.\nThe\tfollowing\tcommands\tare\tsupported\tby\tIRC\tto\tcontrol \t\ninfected\tsystems\tin\treal\ttime.\tThis\tfunctionality\tenables \t\nthe\tattacker\tto\tsend\tand\treceive\tfiles\ton\tdemand\tand \t\nexecute remote commands. The messages sent between \nclient and servers are base64 encoded and then \nencrypted\tusing\tthe\tCryptography\tAPI—thus,\ta\tmessage \t\nmust be decoded and decrypted to be visible. This highly \nsophisticated\tmethod\tprovides\tfor\tgreat\tflexibility\tover\ta \t\nsecure encrypted channel that is not SSL.\n ■Get bot version and uptime\n ■Get\tdirectory\tfile\tlisting,\tall\tdrives\tor\tfrom\tspecific\tpath\n ■Stop\tactivities\tfor\ta\tgiven\tperiod\n ■Download\tfile\t\n ■Send\tlocal\tfile\tto\tthe\tserver19 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\n ■Execute\tshell\tcommand\n ■Connect\tto\tIRC\tserver\n ■Change\tnick\t(IRC)\n ■Join\tchannel\t(IRC)\n ■IRC\tdisconnect\n ■Remove\tbot\tfrom\tsystem\nFigure 27.  Functions for IRC commands.The\tHTTP\tportion\tis\tdesigned\tto\tget\tconfiguration\tdata\t\nused\tin\tthe\tIRC\tbotnet\tand\tto\tsend\tstolen\tdocuments\t\nback to the control server.\nFigure 28. HTTP Get command with parameters.\nFigure 29. HTTP Get command continued.20 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nFigure 30. HTTP Get command continued.\nThe\tencrypted\tnetwork\toperates\tby\tscanning\tinfected\t\nsystems\tand\tcategorizing\tthose\tsystems\tthat\tcontain\t\ninteresting documents. The malware does not extract \nevery\tdocument\tthat\tis\tfound\tas\ta\tmatch\tthrough\tdrive\t\nscanning—rather\tit\tassigns\ta \tunique\tsignature\tto\tthe\t\ninfected\tsystem\taccording\tto\twhat\tit\tcontains.\tLess\t\ninteresting systems are less likely to have documents \nextracted\tfrom\tthem.\tThe\tdirectory\tcontents\tare\t\nuploaded\tto\tthe\tattacker’s\tserver,\twhich\tlets\tthe\tattacker\t\ngrab\tdocuments\tat\twill\tand\tkeeps\tthe\tamount\tof\t\nnetwork\ttraffic\tlow.Data exfiltration\nThe\ttheft\tof\tclassified\tinformation\tis\tthe\tprimary\tpurpose \t\nof\tthis\tnetwork\tand\twould\toccur\tthrough\tdrive\tscanning. \t\nDrive\tscanning\tlocates\tclassified\tinformation\ton\ttarget\t\nsystems\tand\tgives\tthe\tattacker\tan\toverall\tidea\tof\twhat\t\nthese military networks have. The malware searches \nthe\troot\tdisk,\tcounts\tthe\tnumber\tof\tinteresting\tfiles,\t\nand\tdetermines\tthe\tlevel\tof\tthat\tsystem’s\timportance\t\nto\tthe\tattacker.\tThe\tsearch\tcriteria\tare\tprimarily\tspecific\t\nfile\textensions\tand\tkeywords\tin\tdocument\ttitles.\tThe\t\nkeywords\tare\tall\tmilitary\tspecific.\tSome\trefer\tto\tspecific\t\nmilitary units and programs that operate in South Korea. \nThis\tfunction\twould\tdetermine\tonly\tthe\tnumber\tof\t\ninteresting\tfiles\tthat\tare\tcontained\ton\tany\tgiven\tsystem;\t\nanother\tfunction\twould\textract\tthe\tlist\tof\tfiles\tthat\t\nmatch these search criteria.\nFigure 31. The drive scan function.21 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nIn\taddition\tto\tsearching\tfor\tEnglish\tkeywords,\tthe\t\nfunction\tsearches\tfor\tKorean\tASCII\tcharacters\tthat\t\nrepresent\ta\tsubset\tof\tmilitary\tterms.\tMost\tkeywords\t\nspecific\tto\tmilitary\toperations\tin\tSouth\tKorea\tare\tin\t\nEnglish.\tThere\tis\talso\ta\tset\tof\tabbreviations.\nFigure 32. Google translation of ASCII characters.\nThe\tfiles\tto\tbe\tsent\tto\tthe\tattacker’s\tserver\tare\tzipped\t\nusing the open-source Zip Utils.6 The component \nuses\tthe\tpassword\t“dkwero38oerA^t@#.”\tWe\thave\t\nconsistently\tfound\tthis\tpassword\tin\tthe\tmalware\tdating\t\nback\tto\t2009.\tIt\tis\tused\tprimarily\tto\tarchive\titems\tto\tbe\t\nstolen\tfrom\tinfected\tsystems.\nFigure 33. The function to zip stolen documents.\nThe DLL relationship \nIn\tall\tof\tthese\tthreats,\twe\thave\tseen\tthe\tconsistent\tuse\t\nof\tbs.dll,\ta\tstripped-down\tversion\tof\tip6ld.dll,\twhich\t\nwe\thave\tfound\tin\tthe\tmilitary\tespionage\tcases.\tWe\tcan\t\nconnect\tnot\tonly\tsimilar\tfunctions\twithin\tbs.dll\tfrom\t\n2011\tto\tdate\twith\tthose\tof\tthe\tmilitary\tcases\tin\t2009\t\nand\t2010,\tbut\talso\tthe\tshared\tencryption\tkey\tfor\tzipping\t\nclassified\tinformation\tto\tbe\tsent\tto\tthe\tcontrol\tserver.\nThis\tip6ld.dll\tis\tthe\tsame\tas\tanother\tfile,\t~81923.dll.\tBoth\t\noperate in the same manner. Bs.dll appears to be used \nprimarily\tfor\tIRC\tbotnet\tcommunications.\nThe\tcomponent\tbs.dll\thas\tbeen\tseen\tin\ta\tnumber\tof\t\nTroy-era\tmalware\tsamples:\tChang,\tEagleXP,\tNSTAR,\tMail\t\nAttack, HTTP Troy, Tong, Http Dr0pper, and others. The \nfile\tIp6ld.dll,\twhich\tcontains\tmuch\tof\tthe\tlogic\tdescribed\t22 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nin\tthese\tattacks,\tshares\ta\tnumber\tof\tcommon\tfunctions\t\nwith\tbs.dll,\tincluding\tthe\tzip\tencryption\tpassword.\tIn\t\naddition,\tthe\tIRC\tand\tencryption\tfunctions\tare\tthe\tsame\t\nin\tboth\tfiles,\tindicating\tthat\tthey\twere\tbuilt\tby\tthe\tsame\t\nindividual\tor\tgroup.\tThe\ttwo\tfunctions\tare\tlikely\tthe\t\nsame\tsource\tcode\tin\tdifferent\tversions.\tThe\tprimary\t\ndifference\tbetween\tthem\tis\tbs.dll’s\tlack\tof\tsearching\tfor\t\nspecific\textensions\tand\tterms\tthat\tIp6ld.dll\tand\t~81923.\ndll\tcontain.\tThis\tsuggests\tbs.dll\trequires\ta\tsecond\t\nmodule, and we have seen that with the Mail Attack \nvariant, compiled in February 2011, which contained \nboth bs.dll and payload.dll, with the latter containing the \nmilitary-specific\tsearch\tand\textraction\tfunctions.\nFigure 34. The bs.dll function to scan all drives based on a specified \nextension.\nThe\tfollowing\tfunction\tfound\tin\tbs.dll\tlists\tthe\tcontents\t\nof\tspecified\tdirectories\tand\tzips\tthose\tcontents\tinto\tan\t\narchive\tfile\twith\ta\tpassword.\tThis\tfunction\tdoesn’t\thave\tany criteria and is likely disabled in some cases, such as \nwith HTTP Troy, which downloads a payload module to \nsearch\tfor\tdata.\nFigure 35. A bs.dll function to list and send directory contents.\nFigure 36. A bs.dll function to send directory contents to remote server.23 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nPayload.dll appears to combine both drive searching and \ndirectory\tlisting\tinto\ta\tsingle\tfunction.\tA\tseparate\taction\t\nputs\tthe\tdirectory\tcontents\tinto\ta\tseparate\tfile\tand\t\nprepares it to be sent to the remote server.\nFigure 37. A payload.dll drive-search function.\nFigure 38. A function to zip contents.24 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nRelationships to Http Dr0pper\nWe\thave\tdetermined\tthat\tsome\tvariants\tof\tHttp\tDr0pper\t\nwill execute payload32.dll, which is essentially the same \nDLL\tthat\tis\tfound\tin\tTDrop.\tThis\tcomponent\tcontains\t\nmilitary\tkeywords.\tOne\tvariant\tof\tHttp\tDr0pper\tmade\t\nuse\tof\tpayload32.dll,\twhich\twas\tcompiled\ton\tAugust\t\n23, 2012. The TDrop version was compiled on January \n13,\t2013.\tThis\tconsistency\tconfirms\tfurther\tthat\tthe\t\noperations\tagainst\tSouth\tKorea\tare\tprimarily\tfocused\t\non military intelligence gathering and have attempted to \nbreak in since 2009.\nDestroying the target\nThe espionage malware has the capability to destroy \nsystems in the same way that the March 20, 2013 \nattacks\tdisabled\tthousands\tof\tsystems\tin\tSouth\tKorea.\t\nThis\tcapability\tcould\tbe\tdevastating\tif\tmilitary\tnetworks\t\nwere\tto\tsuddenly\tbe\twiped\tafter\tan\tadversary\thad\t\ngathered intelligence. This was clearly the case with the \nMarch\t20\tDark\tSeoul\tincident,\tin\twhich\twe\tconfirmed\t\nthat the 3Rat Trojan gained access prior to the MBR-\nwiping event. There was at least one limitation, however: \nwe\tfound\tthe\tmalware\tof\tFebruary\t2011\tcould\twipe\tits\t\ntargets\tonly\tif\tit\tdetected\tthat\tit\twas\tbeing\tdebugged\tor\t\nanalyzed\tby\ta\tsecurity\tproduct.\nFigure 39. The malware’s function to wipe the MBR.25 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nThe campaigns\nThrough\tour\tresearch,\twe\thave\tdiscovered\ta\tnumber\tof\t\ndistinct\tsubcampaigns\tas\tpart\tof\tthe\toverall\tOperation\t\nTroy,\twhich\thas\ttargeted\tmilitary\tforces\tin\tSouth\tKorea\t\nto\textract\tclassified\tinformation.\tThese\toperations\twere\t\ndesigned to occur in 2009 through 2013. Recently, we \nuncovered evidence to suggest that they continued just \nprior\tto\tDark\tSeoul.\tWe\tcan\tlink\tthe\tactor(s)\tresponsible\t\nfor\tDark\tSeoul\tto\tthese\tparticular\tespionage\tcampaigns\t\nthrough various technical means. \n ■The Troy-era malware is based on the same source \ncode\tto\tcreate\tthese\tspecialized\tversions\t(components\t\nshared\tover\tthe\tyears). ■The\tzip\tencryption\tpassword\tis\tfound\tin\talmost\tall\t\ninstances,\twith\tthe\texception\tof\tConcealment\tTroy.\n ■Consistent\tterms\tin\tthe\tmalware\tcompile\tpaths\t(for\t\nexample,\tTroy,\tWork,\tand\tmore).\n ■The\tsame\tIRC\tbotnet\tchannel\tand\tencryption\tmethod\t\nare used throughout the variants. \n ■Military\tkeywords\tare\tconsistently\tfound\tthrough\tthe\t\ncomponents\tspanning\t2009–2013,\tconfirming\tthe\t\nintent\tof\tthis\tadversary.\n ■The\tsame\tstring-obfuscation\ttechniques\twere\tused \t\nin the 2009–2010 campaigns and the 2012–2013 \ncampaigns.\nMalware from 2009 \nMilitary AttacksMalware from 2012 \nMilitary AttacksMalware from 2013 \nMilitary Attacks\ndkwero38oerA^t@#\nMail Attack HTTP Troy NSTAR Chang EagleXP Http Dr0pper Tong TDropMalware from 2010 \nMilitary AttacksMalware from 2011 \nMilitary Attacks\nFigure 40. Shared encryption password.26 Dissecting Operation Troy: Cyberespionage in South KoreaWHITE PAPER\nConclusion\nMcAfee\tLabs\tcan\tconnect\tthe\tDark\tSeoul\tand\tother\t\ngovernment attacks to a secret, long-term campaign that \nreveals\tthe\ttrue\tintention\tof\t the\tDark\tSeoul\tadversaries:\t\nattempting\tto\tspy\ton\tand\tdisrupt\tSouth\tKorea’s\tmilitary\t\nand government activities. The Troy-era malware is \nbased on the same source code used to create these \nspecialized\tvariants\tand\tshares\tmany\tcommonalities,\t\nsuch\tas\tbs.dll\tand\tpayload.dll,\twhich\tare\tfound\t\nconsistently\tthroughout\tthe\tfamilies.\tThe\tattackers\thave\t\nattempted since 2009 to install the capability to destroy \ntheir targets using an MBR wiper component, as seen \nin the Dark Seoul incident. From our analysis we have \nestablished\tthat\tOperation\tTroy\thad\ta\tfocus\tfrom\tthe\t\nbeginning to gather intelligence on South Korean military \ntargets.\tWe\thave\talso\tlinked\tother\thigh-profile\tpublic\t\ncampaigns conducted over the years against South \nKorea to Operation Troy, suggesting that a single group \nis responsible. \nAbout the Authors\nRyan\tSherstobitoff\tis\ta\tthreats\tresearcher\twith\tMcAfee\t\nLabs.\tFormerly,\the\twas\tChief\tSecurity\tStrategist\tat\tPanda\t\nSecurity, where he managed the US strategic response \nfor\tnew\tand\temerging\tthreats.\tSherstobitoff\tis\twidely\t\nrecognized\tas\ta\tsecurity\tand\tcloud\tcomputing\texpert.\nItai\tLiba\tis\ta\tsenior\tsecurity\tresearcher\twith\tMcAfee\t\nLabs.\tHe\tis\ta\tmember\tof\tthe\tbotnet\tresearch\tteam.\tItai\t\nhas worked in mobile vulnerability research as well as \nlarge-scale reverse-engineering projects and display \ndriver\tdevelopment.\tHe\thas\tmore\tthan\t10\tyears\tof\t\nexperience in reverse engineering. James\tWalter\tis\tthe\tdirector\tof\tGlobal\tThreat\tIntelligence \t\nOperations\tand\tmanages\tthe\tMcAfee®\tThreat\tIntelligence \t\nService\t(MTIS)\tfor\tthe\tOffice\tof\tthe\tCTO.\tHe\tfocuses \t\non new threats research, as well as the cataloging \nand\tmaintenance\tof\tvulnerabilities\tand\tassociated \t\ncountermeasures.\tWalter\thas\tbeen\twith\tMcAfee\tfor\tmore \t\nthan\t14\tyears\tand\tleads\ta\tglobal\tteam\tof\tthreats\tanalysts \t\nwho\tcreate\tSecurity\tAdvisories, \tcountermeasure/detector \t\nfeeds,\tMcAfee®\tGlobal\tThreat\tIntelligence\tapplications, \t\nand\tmore.\tHe\tis\ta\tfrequent\tspeaker\tat\tindustry\tevents \t\nand\tconferences,\tand\tcohosts\t“AudioParasitics—The \t\nOfficial\tPodcast\tof\tMcAfee\tLabs.”\nAbout McAfee Labs\nMcAfee\tLabs\tis\tthe\tglobal\tresearch\tteam\tof\tMcAfee.\t\nWith\tthe\tonly\tresearch\torganization\tdevoted\tto\tall\t\nthreat\tvectors—malware,\tweb,\temail,\tnetwork,\tand\t\nvulnerabilities—McAfee\tLabs\tgathers\tintelligence\tfrom\t\nits\tmillions\tof\tsensors\tand\tits\tcloud-based\tservice\t\nMcAfee\tGlobal\tThreat\tIntelligence.\tThe\tMcAfee\tLabs\t\nteam\tof\t500\tmultidisciplinary\t researchers\t in\t30\tcountries\t\nfollows\tthe\tcomplete\trange\tof\tthreats\tin\treal\ttime,\t\nidentifying\tapplication\tvulnerabilities,\tanalyzing\tand\t\ncorrelating risks, and enabling instant remediation to \nprotect enterprises and the public. \nhttp://www.mcafee.com/labs\n1. http://en.wikipedia.org/wiki/Principes\n2. http://en.wikipedia.org/wiki/Hastati\n3. http://en.wikipedia.org/wiki/Troy\n4. http://en.wikipedia.org/wiki/ROKS_Cheonan_sinking\n5. https://github.com/jonasschnelli/IRCClient\n6. http://www.wischik.com/lu/programmer/zip_utils.htmlAbout McAfee\nMcAfee\tis\tthe\tdevice-to-cloud\tcybersecurity\tcompany. \t\nInspired\tby\tthe\tpower\tof\tworking\ttogether,\tMcAfee \t\ncreates business and consumer solutions that make our \nworld\ta\tsafer\tplace.\tBy\tbuilding\tsolutions\tthat\twork\twith \t\nother\tcompanies’\tproducts,\tMcAfee\thelps\tbusinesses \t\norchestrate cyber environments that are truly integrated, \nwhere\tprotection,\tdetection,\tand\tcorrection\tof\tthreats \t\nhappen simultaneously and collaboratively. By protecting \nconsumers\tacross\tall\ttheir\tdevices,\tMcAfee\tsecures\ttheir \t\ndigital\tlifestyle\tat\thome\tand\taway.\tBy\tworking\twith\tother \t\nsecurity\tplayers,\tMcAfee\tis\tleading\tthe\teffort\tto\tunite \t\nagainst\tcybercriminals\tfor\tthe\tbenefit\tof\tall. \t\nwww.mcafee.com .\nMcAfee and the McAfee logo are trademarks or registered trademarks of McAfee, LLC or its subsidiaries in the US and other countries. \nOther marks and brands may be claimed as the property of others. Copyright © 2018 McAfee, LLC. 3892_0418\nAPRIL 20182821 Mission College Blvd.\nSanta Clara, CA 95054\n888.847.8766\nwww.mcafee.com\n27 Dissecting Operation Troy: Cyberespionage in South Korea"
}