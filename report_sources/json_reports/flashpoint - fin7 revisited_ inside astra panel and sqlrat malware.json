{
    "title": "flashpoint - fin7 revisited_ inside astra panel and sqlrat malware",
    "text": "FIN7 Revisited: Inside Astra Panel and SQLRat\nMalware\n MARCH 20, 2019 BLOG\nBy Joshua Platt and Jason Reaves\nDespite the arrests of three prominent members of the FIN7 cybercrime gang  beginning in January 2018,\nattacks targeting businesses and customer payment card information did not cease.\nThe latest evidence involves the discovery of a new administrative panel and previously unseen malware\nsamples that Flashpoint analysts are linking to this notorious group. Activity from this campaign dates from\nMay to July 2018, but could go back farther to January 2018.\nFIN7 has been active since at least 2015, targeting more than 100 U.S.-based companies in 47 states, as well as\nbusinesses in Europe and Australia. The U.S. companies affected were operating primarily in the hospitality,\nrestaurant, and gaming industries , according to a U.S. Department of Justice press release last Aug. 1\nannouncing the arrest of three Ukrainian nationals alleged to be members of FIN7. Two were arrested in\nJanuary in Germany and Poland, while the third—an alleged supervisor—was arrested in June in Spain.\nFIN7, which has also used a backdoor linked to Carbanak —another prolific cybercrime outfit responsible for\nbillions in losses in the financial services industry—has stolen more than 15 million payment card records from\nAmerican businesses. The group, which operated behind a front company called Combi Security, has\ninfiltrated more than 6,500 individual point-of-sale terminals at more than 3,600 business locations, according\nto the DoJ.\nNew Attack Panel and Malware Samples\nFlashpoint analysts recently uncovered a new attack panel used by this group in campaigns they have called\nAstra. The panel, written in PHP, functions as a script-management system, pushing attack scripts down to\ncompromised computers.\nAnalysts discovered references to the FIN7 front company Combi Security in the Astra panel’s backend PHP\ncode, connecting the group to these campaigns. According to the DoJ indictments, Combi Security purported\nitself as a penetration-testing and security services company based in Russia and Israel. The DoJ alleges FIN7\nportrayed Combi Security as a legitimate business in order to recruit other hackers to their operation.\nThe attackers gain an initial foothold on targeted machines via phishing emails containing malicious\nattachments. The emails are often industry-specific and crafted to entice a victim to open the message and\nexecute the attached document.\nOne of the documents spreads what analysts are calling SQLRat, previously unseen malware that drops files\nand executes SQL scripts on the host system. The use of SQL scripts is ingenious in that they don’t leave\nartifacts behind the way traditional malware does. Once they are deleted by the attackers’ code, there is\nnothing left to be forensically recovered. This technique has not been observed in previous campaigns\nassociated with FIN7.\nThe second new malware sample discovered is a multiprotocol backdoor called DNSbot, which is used to\nexchange commands and push data to and from compromised machines. Primarily, it operates over DNS\ntraffic, but can also switch to encrypted channels such as HTTPS or SSL, Flashpoint analysts discovered.\nThe campaigns maintain persistence on machines by creating two daily scheduled task entries. The code,\nmeanwhile, is still controlled by the FIN7 actors and may be leveraged in future attacks by the group.\nSQLRat Technical Details\nSQLRat campaigns typically involved a lure document that included an image overlayed by a VB Form trigger.\nThe documents contained a message asking the user to “Unlock Protected Contents,” below, while showing a\nmessage box displaying “US SEC Unlock document service.”\nImage 1: An image of a document used in a typical campaign.\nOnce a user has double-clicked the embedded image, the form executes a VB setup script. The script writes\nfiles to the path %appdata%\\Roaming\\Microsoft\\Templates\\, then creates two task entries triggered to run\ndaily.\nImage 2: Executing scripts on disk.\nThe scripts are responsible for deobfuscating and executing the main JavaScript file mspromo.dot. The file uses\na character insertion obfuscation technique, making it appear to contain Chinese characters.\nImage 3: Obfuscated mspromo file.\nAfter deobfuscating the file, the main JavaScript is easily recognizable. It contains a number of functions\ndesigned to drop files and execute scripts on a host system.\nImage 4: Deobfuscated mspromo script.=\nThe SQLRat script is designed to make a direct SQL connection to a Microsoft database controlled by the\nattackers and execute the contents of various tables. The script retrieves an item from the bindata table and\nwrites the file to disk. This file appears to primarily be a version of TinyMet—an open source Meterpreter  stager\n—but the actors have the option to store and execute any binary loaded into the table.\nImage 5: Code responsible for downloading from the database.\nFiles associated with the SQLRat campaigns were all SFX RAR files. The files were 32/64-bit versions of a\ncustom-built TinyMet along with a recon.js file. The 32-bit file contained an XOR embedded .exe file. The file\nwas decoded out using the following:\nImage 6: Deobfuscate embedded “TiniMet,” a customized\nversion of TinyMet.\nThe result is a customized version of TinyMet. This version has limited usage; it does reverse TCP, XOR\ndecodes the data retrieved for execution of the stager, and looks for TrendMicro processes. This file calls itself\nTiniMet:\nImage 7: TiniMet looking for TrendMicro processes.\nAnalysts also uncovered a “TinyPS” stager:\nAfter decoding out the blob, analysts found a PowerShell script. This script was similar to what was previously\ndocumented in the Trustwave report  “Operation Grand Mars: Defending Against Carbanak Cyber Attacks.”\nThe script contained the same XOR key but does not achieve persistence. It is only intended to create the\nMeterpreter session. The following is the PowerShell version of TiniMet:\nImage 9: TinyPS PowerShell stager snippet.\nDNSbot Technical Details\nAnalysts also uncovered subsequent campaigns associated with this panel. These campaigns were similar, but\nleveraged a document containing an embedded JavaScript-based DNSbot. The document contained the\nsame MsgBox display, but this time there was a single file and task. The task name is similar to “Microsoft\nupdate service,” but the obfuscated JS file is dropped in %localappdata%\\Storage:\nImage 10: DNSBot drop location.\nAdditionally, the same US SEC Unlock document service is displayed, though the Microsoft update service task\nis deleted and replaced with the DNSbot.\nImage 11: DNSbot task update.\nThe JavaScript is heavily obfuscated. The first variable—a—is an array of obfuscated values. The second line\ncontains a function to deobfuscate the values, while the call to that function is the second variable, b:\nImage 12: DNSbot obfuscation.\nA deobfuscated version of the DNS script is:\nImage 13: DNSbot deobfuscated.\nA second deobfuscated testing script also matched components of the JavaScript embedded in the ASTRA\ndocs, demonstrating the script’s multiprotocol use. The domain stats25-google[.]com was included in a report\nreleased by FireEye earlier in the year:\nImage 14: Script relation to other reporting.\nThe ASTRA backend was installed on a Windows server with Microsoft SQL. The panel was written in PHP\nand managed the content in the tables. It functioned as a script management system.\nImage 15: ASTRA attack panel partially redacted.\nImage 16: FIN7 front company name.\nImage 17: The file types\nthat were inserted,\nalong with a table\nlayout of the database\nwith partial redaction.\nMitigations\nFlashpoint recommends watching for newly added Windows tasks, specifically those with a JScript switch.\nAlso, monitor for attempts to delete the Microsoft update service.\nFlashpoint also recommends implementing host-based detections for new files in\n%appdata%\\Roaming\\Microsoft\\Templates\\ with a dot extension, as well as implementing host-based\ndetections for files in %appdata%\\local\\Storage\\.\nAttachments and Downloads\nThe indicators of compromise (IOCs) for ASTRA panel, SQLRat, and DNSbot are available for download here.\nJason Reaves\nJason Reaves is a Principal Threat Researcher at Flashpoint who specializes in malware reverse-engineering.\nHe has spent the majority of his career tracking threats in the Crimeware domain, including reverse-\nengineering data structures and algorithms found in malware in order to create automated frameworks for\nharvesting configuration and botnet data. Previously, he worked as a software developer and unix administrator\nin the financial industry and also spent six years in the U.S. Army. Jason holds multiple certifications related to\nreverse-engineering and application exploitation and has published numerous papers on topics such as\nwriting malware scripts pretending to be a bot, unpackers, configuration data harvesters and covert channel\nutilities. He enjoys long walks in IDA and staring at RFCs for hours.\nJoshua Platt\nJoshua Platt is a Principal Threat Researcher at Flashpoint who specializes in investigating complex financial\ncrimeware families. As a former network security engineer, he first began reversing malware while working in\nthe financial services industry nearly 10 years ago. Joshua graduated from the University of North Texas with a\nB.S. in criminal justice and has earned multiple certifications within the security industry related to reverse\nengineering and penetration testing.\nBlog\nIntelligence Platform\nCredentials Monitoring\nFlashpoint API\nProfessional Services\nThreat Response\nAlertingAbout\nPartners\nMedia\nEvents\nCareers\nContact UsFlash Talks\nPodcasts\nBlog\nCase StudiesLinkedIn\nTwitter\nFacebook\n© 2020 Flashpoint. All rights reservedTerms of Service  Privacy Policy  Cookie Policy  CCPAProducts & Services\n Company\n Resources\n Social\n "
}