{
    "title": "奇安信威胁情报中心",
    "text": "Background\nQiAnXin Threat Intelligence Center captured several lure Excel documents written in Arabic in January 9, 2019. A backdoor dropped by macro in the lure documents can\ncommunicate with C2 server through DNS tunnel, as well as Google Drive API.\nWe confirmed that this is a DarkHydrus Group’s new attack targeting Middle East region. In July 2018, Palo Alto disclosed DarkHydrus Group which showed its special\ninterest to governments in Middle East[1]. Prior to that report, we published detail analysis on malware exploiting CVE‐2018‐8414 vulnerability ﴾remote code execution in\nSettingContent‐ms ,﴿which is believed a work of DarkHydrus[2].\nTimeline\nTimeline of activities of DarkHydrus Group:\nKaspersky named “LazyMeerkat” to this APT group. [4]\nSample Analysis\nDropper （Macros）\nMD5 5c3f96ade0ea67eef9d25161c64e6f3e\nFilename ﺍﻟﻔﻬﺎﺭﺱ.xlsm（indexes. xlsm ）\nMD5 8dc9f5450402ae799f5f8afd5c0a8352\nFilename ﺍ  ﻃ  ﻉ.xlsm（viewing. xlsm ）\nThis malware is a lure Excel document with name ‘ ﺍﻟﻔﻬﺎﺭﺱ.xlsm’. When it is opened, embedded VBA macro is trigged to run. That macro drops 12‐B‐366.txt to\n‘%TEMP%’ directory first, then leverages regsvr32.exe to run 12‐B‐366.txt\n12‐B‐366.txt is a HTA ﴾HTML application ﴿file, which will drop a PowerShell script to %TEMP%\\\\ WINDOWSTEMP.ps1\nFinally, the PowerShell script drops %TEMP%\\\\OfficeUpdateService.exe for execution by extracting Based64‐encoded content.\nBackdoor （OfficeUpdateService.exe ）\nMD5 b108412f1cdc0602d82d3e6b318dc634\nFilename OfficeUpdateService.exe\nPDB path C:\\Users\\william\\Documents\\Visual Studio 2015\\Projects\\DNSProject\\DNSProject\\obj\\Release\\DNSProject.pdb\nThis backdoor is written in C# ：\nThe PDB path has a project name ‘DNSProject’, which illustrates that the malware may leverage some DNS techniques to achieve its goal.\nC:\\Users\\william\\Documents\\Visual Studio 2015\\Projects\\DNSProject\\DNSProject\\obj\\Release\\DNSProject.pdb\nThe backdoor checks if ‘st:off’ and ‘pd:off’ is given as paramters. If ‘st:off’ presents, no persistence entry is added; PDF file is not dropped if ‘pd:off’ exists. Then it detects\nexistence of virtual machine and sandbox before malicious payload is triggered.\nA registry entry is added for persistence ：\nIt can drop a PDF file ：\nCodes of virtual machine detection, sandbox detection and anti‐debug are following,\nNext, the backdoor will collect host name\nThe backdoor will send collected information to C2 server through DNS tunnel. queryTypesTest function is created for DNS tunnel communication.\nThen, the backdoor tries to retrieve commands from C2 server via DNS tunnel, then through HTTP if failed.\nAfter C2 commands is retrieved successfully, commands are dispatched by taskHandler.\nScreenshot of a part of C2 commands\n“^\\\\$x_mode” command sets file server address which is sent in DNS tunnel.\nOne file server is Google Drive\nhttps://www.googleapis.com/upload/drive/v3/files/\" + file_id + \"?supportsTeamDrive=true&uploadType=resumable&fields=kind,id,name,mimeType,parents\nAll command lists are following ：\nCommand Feature\n^kill Kill thread or process\n^\\$fileDownload Download file\n^\\$importModule Import module\n^\\$x_mode In x_mode ，configure C2 address ，then send RAT data to C2 by HTTP protocol\n^\\$ClearModules Remove module\n^\\$fileUpload Upload file\n^testmode Test module\n^showconfig Show configuration\n^changeConfig Change configuration\n^slp Sleep\n^exit Exit process\nDNS Tunnel\nDNS tunnel is a C2 communication technique in which malware send data and retrieve commands by DNS query packets. This technique is very effective since most\ngateways or firewalls allow both ingress and egress DNS traffic.\nIf C2 server is assigned in the format of IP address in malware body, malware can contact C2 directly. But OfficeUpdateService.exe backdoor has C2 server in the format of\nDNS name, which requires a DNS resolution to C2 domain name first. To do that, the backdoor queries C2 domain in specific name server. Then the backdoor communicates C2\nserver in DNS tunnel.\nC2 domain names are following ：\nName Server\nMalware sends DNS queries to these two name servers for C2 domain name resolution: ‘tvs1.trafficmanager.live’ and ‘tvs2.trafficmanager.live’\nMalware uses nslookup to send out DNS query, with following parameters: ‘timeout’ and ‘q’ for DNS record type\nC&C Commands\nTo parse C2 commands from above types of DNS records, the malware uses different regular expressions. For example, if commands are sent back in DNS A record, the\nmalware will use following regular expression:\nMalware will retrieve a process ID as victim ID, then treats victim ID as subdomain name in C2 communication.\nC2 commands are parsed out by regular expressions based on DNS record types.\nWe manually send out a DNS TXT query with victim ID as illustration.\nA domain name ‘ajpinc.akamaiedge.live’ is created. In subdomain ‘ajpinc’, ‘a’ means this is the first request, and ‘c’ is the character for string end, while ‘jpin’ is process ID.\nThen, we send DNS query by using nslookup command as following\nThe malware will use following regular expression to parse out command, ﴾[\\\\w+﴾.﴿akdns.live|akamaiedge.live|edgekey.live|akamaized.live]﴾file://w+.﴿\n﴾akdns.live|akamaiedge.live|edgekey.live|akamaized.live.﴿﴿\nFinally, system configuration is sent to C2 server in DNS protocol.\nCommunication Rule\nThis malware uses following types of DNS record\nA\nAAAA\nAC\nCNAME\nTXT\nSRV\nSOA\nMX\nTo parse C2 commands from above types of DNS records, the malware uses different regular expressions. For example, if commands are sent back in DNS AC record, the\nmalware will use following regular expression:\nFollowing regular expression is for commands in DNS AAAA records,\nAnd there is one regular expression for several DNS record types, including CNAME, SRV, SOA,\nBreakdown of regular expressions are as following,\nTypes of DNS record Regular expressions\nA Address:\\\\s+(\\\\d+.\\\\d+.\\\\d+.\\\\d+)\nAC ([^r‐v\\\\s]+)[r‐v]([\\\\w\\\\d+\\\\/=]+)‐\\\\w+.(<C2DOMIAN>)\nAAAA Address:\\\\s+(([a‐fA‐F0‐9]{0,4}:{1,4}[\\\\w|:]+){1,8})\nCNAME、TXT、SRV、SOA、MX([^r‐v\\\\s]+)[r‐v]([\\\\w\\\\d+\\\\/=]+)‐\\\\w+.(<C2DOMIAN>)\nand\n(\\\\w+).(<C2DOMIAN>)\nHowever, the malware will cancel operation if commands is matched by following regular expression:\n\"216.58.192.174|2a00:1450:4001:81a::200e|2200::|download.microsoft.com|ntservicepack.microsoft.com|windowsupdate.microsoft.com|update.microsoft.com\"\nAttribution\nWe found some traces which lead us to believe that DarkHydrus is behind this attack.\nSamples with DNS Tunnel Function\nSimilar to the malware disclosed by Palo Alto[2], both malware use DNS tunnel technique:\nSandbox detection and Backdoor Capability\nThe new malware has very similar code of detection to sandbox and virtual machine as previous DarkHydrus samples\nBoth samples have very similar code and functionality:\nPivot\nOne interesting finding is that, there is one Twitter user Steve Williams with handle name @darkhydrus2. It’s coincident that both ‘darkhydrus’ ﴾APT group name ﴿and\n‘Williams’ ﴾user name in PDB path ﴿found in this Twitter user.\nSummary\nIn recent APT incidents, more and more threat actors tend to adopt Office VBA macro instead of Office 0day vulnerability in the consideration of cost reduction. It is\nrecommended that users avoid to open documents from untrusted sources. And Office macro should be disabled by default.\nProducts of 360 ESG can protect users from this new malware, including QiAnXin Threat Intelligence Platform, SkyEye APT Detection, NGSOC.\nIOC\nMD5\n5c3f96ade0ea67eef9d25161c64e6f3e\n8dc9f5450402ae799f5f8afd5c0a8352\nb108412f1cdc0602d82d3e6b318dc634\n039bd47f0fdb6bb7d68a2428c71f317d\nPDB PATH\nC:\\Users\\william\\Documents\\Visual Studio 2015\\Projects\\DNSProject\\DNSProject\\obj\\Release\\DNSProject.pdb\nC2\n0ffice365.life\n0ffice365.services\n0nedrive.agency\nakamai.agency\nakamaiedge.live\nakamaiedge.services\nakamaized.live\nakdns.live\nazureedge.today\ncloudfronts.services\ncorewindows.agency\nedgekey.live\nmicrosoftonline.agency\nnsatc.agency\nonedrive.agency\nphicdn.world\nsharepoint.agency\nskydrive.agency\nskydrive.services\nt‐msedge.world\ntrafficmanager.live\nReferences\n[1]. https://ti.qianxin.com/blog/articles/analysis‐of‐settingcontent‐ms‐file/\n[2]. https://unit42.paloaltonetworks.com/unit42‐new‐threat‐actor‐group‐darkhydrus‐targets‐middle‐east‐government/\n[3]. https://ti.qianxin.com/\n[4]. https://twitter.com/craiu/status/1083305994652917760\nAPTDARKHYDRUNS LAZYMEERKA\nRESEARCH\n数 据 驱 动 安 全\nLatest Target Attack of DarkHydruns Group Against Middle East\n2019-01-16 By 奇安信威 胁情报中心  | 事件追踪\n分享到：\nLatest Target Attack of DarkHydruns Group Against Middle East   首页返回 TI 主页\n "
}